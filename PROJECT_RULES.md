# project-rules

## обновление-кода-и-документации

- Любое изменение в `src/` или `configs/` MUST сопровождаться актуализацией
  соответствующих разделов `docs/` и `docs/INDEX.md`.

- Добавление новых источников требует обновить таблицы в
  `docs/requirements/03-data-sources-and-spec.md` и `docs/pipelines/PIPELINES.md`.

- Все ссылки на код в документах оформляются через `[ref: repo:<path>@test_refactoring_32]`.

## проверки-перед-pr

- Запускайте `pytest`, `ruff check`, `mypy` и `python -m scripts.qa.check_required_docs`
  перед открытием PR.

- Markdown MUST проходить `npx markdownlint-cli2 "**/*.md"` без ошибок уровня
  error.

- Префикс коммита для документации: `docs:` с кратким описанием изменений.

## управление-конфигурациями

- YAML файлы обязаны использовать LF окончания строк и кодировку UTF-8.
- Новые ключи в `PipelineConfig` описываются в `docs/configs/CONFIGS.md`.
- Секреты загружаются только через переменные окружения `env:`; hardcoded значения
  запрещены.

## работа-с-пайплайнами

- Детерминизм (`column_order`, сортировка) не должен изменяться без обновления
  golden-тестов и уведомления в CHANGELOG.md.

- Fallback логика MUST оставаться идемпотентной; при модификации обновляйте QC
  правила и описания в `docs/requirements/03-data-sources-and-spec.md`.

## документация-и-рефакторинг

- Папка `refactoring/` служит указателем на основную документацию; не дублируйте
  содержимое, вместо этого добавляйте ссылки на актуальные файлы в `docs/`.

- Новые диаграммы Mermaid сохраняются в соответствующих разделах и проходят линк-чек.

## сериализация-данных

При извлечении данных из любых источников действуют общие правила сериализации
записей, списков и таблиц:

- **Список** `{A,b,c,D,e}` => `A|b|c|D|e` (pipe separated string)
- **Запись** `[a="A", b="b"]` => `a|b//"A"|"b"` (заголовки разделены `//`,
  значения разделены `|`)
- **Таблица** с заголовками и строками:

  ```text
  a        b
  A        B
  C        D
  ```

  => `a|b//A|B//C|D` (первая строка — заголовки через `|`, строки данных
  разделены `//`)
- **JSON запись** (одиночный объект) `{a="A", b="b"}` => `a|b//"A"|"b"`
  (сериализуется как запись)
- **JSON массив записей** `[{a:"A", b:"B"}, {a:"C", b:"D"}]` =>
  `a|b//A|B//C|D` (сериализуется как таблица)

Эти правила применяются при сохранении извлечённых данных в текстовые форматы
(CSV, TSV) или при логировании структур данных.
