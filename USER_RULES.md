# USER_RULES.md — правила пользователя для Cursor
Репозиторий: SatoryKono/bioactivity_data_acquisition (ветка `test_refactoring_11`)
Дата: 2025-10-29

## Назначение
Эти правила описывают, как именно работать в Cursor с кодом и документацией проекта,
чтобы сохранять детерминизм, трассируемость и соответствие принятым контрактам данных.

## Роль пользователя в Cursor
1. Вносить минимальные, атомарные правки. Каждая правка должна быть одной из категорий:
   - багфикс без изменения контрактов данных;
   - рефакторинг без изменения публичного API и схем;
   - расширение функциональности с явным изменением версий схем/контрактов;
   - правки документации, синхронизированные с кодом.
2. Не «чинить» чужие подсистемы в том же PR. Если требуется — готовить отдельный PR.

## Общие требования при редактировании
1. Детерминизм обязателен:
   - Только UTC; только ISO‑8601; без naive datetime.
   - Файловые операции — атомарные (tmp + rename).
   - Фиксированная сортировка строк/столбцов; запрет «естественной»/недетерминированной сортировки.
   - Каноническая сериализация (стабильный порядок ключей, фиксированные типы).
2. Идентификаторы:
   - Использовать канонические ID: ChEMBL IDs, UniProt accessions, PubChem CIDs, DOI.
   - Запрещено придумывать surrogate ID без явного бизнес‑ключа и хеша.
3. Схемы и валидация:
   - Любые изменения столбцов/типов/допустимых значений проходятся через Pandera‑схемы.
   - Колонко‑порядок и допускаемые NULL фиксированы. Любая смена — мажорная версия схемы и миграция.
4. Логирование и метаданные:
   - Структурные JSON‑логи с полями: pipeline_version, git_commit, config_hash, run_id, started_at_utc.
   - Для каждого артефакта — sidecar `meta.yaml` с lineage и QC.
5. HTTP/внешние источники:
   - Только через UnifiedAPIClient/клиенты. Таймауты, ретраи с backoff, TTL‑кэш, circuit breaker.
   - Политика 429/5xx: экспоненциальный backoff, бюджет попыток, троттлинг.
6. Ввод/вывод данных:
   - CSV/Parquet с фиксированным порядком столбцов; нормализованные NA/NULL; финальные файлы неизменяемы.
   - Контрольные суммы (BLAKE2), размер, строки, хэш бизнес‑ключа — в `meta.yaml` и QC‑отчёте.
7. Документация:
   - Любое изменение контрактов данных сопровождается синхронной правкой в `docs/` и примеров CLI.
8. Код‑стиль:
   - Полная аннотация типов, `mypy --strict` без `type: ignore` в публичном API.
   - Пре‑коммиты: ruff, black, isort, mypy, pytest, coverage; запрет на коммиты, не прошедшие хуки.

## Чего делать нельзя
- Менять порядок столбцов «по красоте».
- Подменять идентификаторы эвристиками без явного правила нормализации.
- Писать ad‑hoc HTTP‑вызовы, обходя унифицированные клиенты.
- Подмешивать локальную таймзону/нестабильные timestamp.
- Загружать большие объёмы данных без контрольных сумм и sidecar.

## Шаблон PR‑чеклиста
- [ ] Изменены только необходимые файлы; атомарность соблюдена.
- [ ] Схемы Pandera обновлены; версия/column‑order/nullable отражены.
- [ ] Обновлены `docs/` и примеры CLI.
- [ ] Пройдены: ruff, black, isort, mypy‑strict, pytest (+golden‑files), pandera‑validation.
- [ ] Добавлены/обновлены QC‑отчёты и `meta.yaml` с lineage.
- [ ] Все внешние вызовы через унифицированные клиенты; троттлинг/ретраи настроены.

## Структура проекта
- Конфиги в `configs/` - источники истины
- Скрипты запуска в `src/scripts/run_*.py`
- Pipeline'ы в `src/bioetl/pipelines/`
- Тесты в `tests/`

## Доступные команды
- `/run_assay` - запуск assay pipeline
- `/run_activity` - запуск activity pipeline  
- `/run_document` - запуск document pipeline
- `/run_target` - запуск target pipeline
- `/run_testitem` - запуск testitem pipeline
- `/validate_columns` - валидация колонок для конкретного pipeline
- `/validate_all_columns` - валидация колонок для всех pipeline'ов

## Работа с данными
- Входные данные в `data/input/`
- Выходные данные в `data/output/`
- Кэш в `data/cache/`
- Логи в `logs/`

## Тестирование
- Юнит-тесты для критических трансформаций
- Интеграционные тесты для pipeline'ов
- Golden-тесты для проверки детерминизма

