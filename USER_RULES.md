# USER RULES

## 1. Общие принципы
- Однозначность и проверяемость: все преобразования и эвристики описаны явно и покрыты тестами.
- Детерминизм: одинаковый вход дает бит-в-бит одинаковый выход.
- Источники истины: конфиги YAML и Pandera-схемы. Код обязан им соответствовать.
- Идемпотентность шагов и воспроизводимость артефактов, включая метаданные (`meta.yaml`).

## 2. Стиль кода
- Форматирование и сортировка импортов единообразны; `from x import *` запрещен.
- Публичные функции и датаклассы имеют аннотации типов; `mypy` обязателен для публичных API.
- Чистые функции там, где возможно; отсутствие скрытых побочных эффектов.

## 3. Нормализация данных
- Стандартные типы: `int`, `float`, `string`, `datetime`, `boolean` — явные приведения, политика `NA/NULL`, trimming, локали и десятичный разделитель.
- Специальные идентификаторы: DOI, ChEMBL ID, UniProt Accession, IUPHAR ID, PubChem CID, SMILES, InChI — валидация форматов и нормализация до записи.
- Стабильные ключи сортировки и хеш-столбцы (`hash_row`, `hash_business_key`).

## 4. Схемы и валидация
- Pandera-схемы обязательны для всех итоговых таблиц; диапазоны, категории и regex-ограничения заданы явно.
- Несовпадения типов/колонок с `column_order` — ошибка сборки.

## 5. Клиенты внешних API
- Таймауты, ретраи с backoff, ограничение QPS, кэш/TTL, корректный User-Agent.
- Правильная обработка пагинации и частичных сбоев; контракт‑тесты.

## 6. Тестирование и CI
- Юнит‑, интеграционные, golden‑тесты на критические трансформы; property‑based тесты уместно.
- Минимальный порог покрытия кода — определяется в проектных правилах; CI блокирует PR при нарушении.

## 7. Экспорт, QC и метаданные
- Перед экспортом: явная сортировка по ключам и проверка соответствия `column_order`.
- Обязательные QC‑сайдкары: `quality_report_table.csv`, `correlation_report_table.csv`.
- `meta.yaml` содержит `pipeline_version`, `chembl_release`, `row_count`, checksums.

## 8. Документация
- В `docs/`: входы, выходы, версии источников, схемы, примеры запуска.
- Любая смена схем/колонок фиксируется в `CHANGELOG.md`.

## 9. Коммиты и PR
- Атомарные изменения, информативные сообщения коммитов с ссылкой на задачу.
- Чеклист PR: стиль, тесты, схемы, конфиги, docs, детерминизм, CI зелёный.

## 10. Безопасность и секреты
- Секреты только через переменные окружения/секрет‑менеджер; запрет хардкода.
- Скан утечек в CI; политика ротации/ревокации ключей.

## 11. Производительность
- Бюджеты по памяти/времени; батчи/стриминг, промежуточные сохранения.
- Профилирование горячих путей и фикс‑регрессий.
