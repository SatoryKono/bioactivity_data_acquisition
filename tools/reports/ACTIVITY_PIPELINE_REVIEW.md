# Review Activity Pipeline

**Дата:** 2025-01-29  
**Pipeline:** `activity`  
**Версия:** 1.0.0

## Обзор

Activity Pipeline извлекает данные активности из ChEMBL API и преобразует их в стандартизированный формат согласно схеме `ActivitySchema`.

### Структура компонентов

```
src/bioetl/
├── pipelines/activity.py              # Compatibility proxy
├── sources/chembl/activity/
│   ├── pipeline.py                     # Основная реализация
│   ├── client/activity_client.py      # HTTP клиент (legacy)
│   ├── parser/activity_parser.py      # Парсер API ответов
│   ├── normalizer/activity_normalizer.py  # Нормализация данных
│   └── output/activity_output.py       # Обработка fallback записей
├── schemas/activity.py                 # Pandera схема
└── configs/pipelines/activity.yaml     # Конфигурация
```

## Соответствие правилам проекта

### ✅ Сильные стороны

1. **Детерминизм**
   - Используется атомарная запись через базовый класс
   - Сортировка по `activity_id` зафиксирована в конфигурации
   - Порядок колонок управляется через схему и конфигурацию

2. **Схемы и валидация**
   - Pandera-схема `ActivitySchema` зарегистрирована в реестре
   - Валидация с QC метриками (дубликаты, null_rate, invalid_units)
   - Fallback записи обрабатываются и логируются

3. **Архитектура**
   - Разделение ответственности: parser, normalizer, client
   - Использование UnifiedLogger
   - Регистрация клиентов для закрытия ресурсов

4. **QC и метаданные**
   - QC метрики рассчитываются в `_calculate_qc_metrics`
   - Fallback статистика записывается в дополнительную таблицу
   - Метаданные обновляются через `set_export_metadata_from_dataframe`

5. **Обработка ошибок**
   - Fallback записи создаются при сбоях API
   - Circuit breaker поддержка
   - Retry с backoff через UnifiedAPIClient

### ⚠️ Обнаруженные проблемы

#### Критические

1. **Несоответствие колонок между конфигурацией и схемой**
   - В схеме `ActivitySchema` (строка 87 в `COLUMN_ORDER`): `"assay_chembl_id"` → `"assay_id"` → `"target_chembl_id"`
   - В конфигурации `activity.yaml` (строки 35-36): `"assay_chembl_id"` → сразу `"target_chembl_id"`
   - Отсутствует `"assay_id"` в `determinism.column_order`
   - Это приводит к расхождению порядка колонок между config и schema
   - Интеграционный тест `test_activity_column_order_matches_schema_and_golden` должен ловить эту проблему
   - **Файл:** `src/bioetl/configs/pipelines/activity.yaml`
   - **Строка:** Добавить после строки 35
   - **Рекомендация:** Добавить `"assay_id"` в `determinism.column_order` после `"assay_chembl_id"` (строка 35)

2. **Использование deprecated клиента**
   - `ActivityChEMBLClient` помечен как legacy (`warn_legacy_client`)
   - Рекомендуется использовать `bioetl.adapters.chembl.activity`
   - **Файл:** `src/bioetl/sources/chembl/activity/client/activity_client.py:26`
   - **Рекомендация:** Мигрировать на новый адаптер согласно документации

3. **Ошибки типизации (60 ошибок линтера)**
   - Множество предупреждений от type checker
   - Несоответствие Protocol `_PipelineLike` с реальным API
   - Проблемы с типами logger методов
   - **Рекомендация:** Исправить типы и добавить stub-файлы

#### Средней важности

4. **Дублирование логики сортировки**
   - Сортировка происходит и в `extract()` (строка 152-154) и в `transform()` (строка 224)
   - **Рекомендация:** Оставить сортировку только в `transform()` для единообразия

5. **Несогласованность batch_size**
   - В конфигурации: `batch_size: 20`
   - В клиенте: `batch_size: 25` (по умолчанию)
   - **Рекомендация:** Использовать значение из конфигурации

6. **Отсутствие обработки атомарной записи**
   - Pipeline полагается на базовый класс, но нет явной проверки
   - **Рекомендация:** Добавить проверку в тестах атомарности записи

7. **Ограниченная валидация QC**
   - QC метрики только для дубликатов, null_rate и invalid_units
   - Нет проверки на соответствие BAO терминам
   - Нет проверки на корректность ChEMBL ID форматов
   - **Рекомендация:** Расширить QC метрики

#### Минорные

8. **Неиспользуемый код**
   - Строка 190: unnecessary cast
   - **Рекомендация:** Удалить cast

9. **Отсутствие документации**
   - Нет docstring для публичных методов в некоторых классах
   - **Рекомендация:** Добавить docstring согласно стандартам

10. **Тесты**
    - Интеграционный тест только проверяет порядок колонок
    - Нет тестов на fallback логику, ошибки API, кэширование
    - **Рекомендация:** Расширить покрытие тестами

## Рекомендации по улучшению

### Приоритет 1 (Критические)

1. **Исправить несоответствие колонок**
   ```yaml
   # configs/pipelines/activity.yaml
   determinism:
     column_order:
       - "assay_chembl_id"
       - "assay_id"  # ← Добавить
       - "target_chembl_id"
   ```

2. **Мигрировать на новый адаптер**
   - Заменить `ActivityChEMBLClient` на `bioetl.adapters.chembl.activity`
   - Обновить все импорты и использование

3. **Исправить типизацию**
   - Исправить Protocol `_PipelineLike` для соответствия реальному API
   - Добавить типы для logger методов
   - Исправить типы в QC метриках

### Приоритет 2 (Средние)

4. **Унифицировать batch_size**
   - Использовать значение из конфигурации везде
   - Убрать hardcoded значения

5. **Расширить QC метрики**
   - Добавить проверку BAO терминов
   - Добавить проверку форматов ChEMBL ID
   - Добавить проверку диапазонов значений (pchembl_value 0-14)

6. **Улучшить тесты**
   - Добавить unit-тесты для fallback логики
   - Добавить интеграционные тесты для error handling
   - Добавить тесты на атомарность записи

### Приоритет 3 (Минорные)

7. **Рефакторинг**
   - Удалить дублирование сортировки
   - Удалить unnecessary cast
   - Добавить docstring

8. **Документация**
   - Обновить docs/pipelines/activity.md (если есть)
   - Добавить примеры использования
   - Описать fallback поведение

## Соответствие правилам

| Правило | Статус | Примечание |
|---------|--------|------------|
| Детерминизм | ✅ | Сортировка и порядок колонок зафиксированы |
| Атомарная запись | ✅ | Через базовый класс |
| Pandera схемы | ✅ | ActivitySchema зарегистрирована |
| QC отчеты | ✅ | Метрики рассчитываются и логируются |
| Fallback записи | ✅ | Обрабатываются и сохраняются |
| Логирование | ✅ | UnifiedLogger используется |
| Типизация | ⚠️ | Много ошибок линтера |
| Тесты | ⚠️ | Покрытие ограничено |

## Выводы

Pipeline в целом соответствует архитектурным принципам проекта, но требует исправления критических проблем:

1. **Несоответствие конфигурации и схемы** - может привести к расхождению в output
2. **Deprecated клиент** - требует миграции на новый адаптер
3. **Типизация** - много ошибок, требует исправления

После исправления этих проблем pipeline будет полностью соответствовать требованиям проекта.

## Следующие шаги

1. Исправить `activity.yaml` - добавить `assay_id` в column_order
2. Провести миграцию на новый адаптер
3. Исправить типизацию и ошибки линтера
4. Расширить тестовое покрытие
5. Обновить документацию

