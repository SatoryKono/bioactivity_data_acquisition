# Базовые метрики проекта

**Дата**: 2025-01-29  
**Ветка**: test_refactoring_32  
**Аннотация**: Метрики проекта до рефакторинга (baseline) и оценки после рефакторинга. Используются для измерения эффективности рефакторинга.

## Метрики до рефакторинга (Baseline)

### Количество файлов

- **Python файлы в `src/bioetl/`**: 291 файл (.py)
- **YAML конфиги в `src/bioetl/configs/`**: 36 файлов (.yaml)
- **Тесты**: 
  - Unit: 161 файл
  - Integration: 9 файлов
  - E2E: 4 файла
- **CLI команды**: 13 файлов в `src/bioetl/cli/commands/`

### Lines of Code (LOC)

**Примечание**: Точные метрики LOC требуют автоматического подсчета через `cloc` или `tokei`. Приведены оценки на основе структуры проекта.

- **Общий LOC в `src/bioetl/`**: ~30,000-40,000 строк (оценка)
- **Критичные модули**:
  - `core/api_client.py`: ~1,450 строк
  - `core/output_writer.py`: ~1,545 строк
  - `pipelines/base.py`: ~1,200+ строк
  - `sources/chembl/*/`: ~80 файлов, ~10,000+ строк суммарно

### Кластеры дубликатов

- **Всего кластеров**: 4
  - **Duplicate**: 1 кластер (4 файла CLI команд)
  - **Alternative**: 1 кластер (requests vs UnifiedAPIClient)
  - **Complementary**: 2 кластера (output modules, pipeline definitions)

- **Размер кластеров**:
  - CLI-001: 4 файла (~100 LOC суммарно)
  - PIPELINE-001: 4 файла (~200 LOC суммарно)
  - HTTP-001: 1 файл (~50 LOC)
  - OUTPUT-001: 2 файла (разделение ролей корректно)

### Импорт-циклы

**Статус**: Требует полного анализа графа зависимостей (не завершен из-за таймаутов инструментов).

**Метод проверки**: 
- Ручной анализ ключевых модулей
- Автоматический анализ через `pydeps` (рекомендуется)

**Выявлено**: 0 циклов (требует верификации)

### Время сборки артефактов

**Примечание**: Требует измерения времени выполнения pipeline на эталонных данных.

**Рекомендации для измерения**:
- Запустить все pipeline на фиксированном наборе данных
- Замерить время выполнения каждого pipeline
- Сохранить метрики для сравнения после рефакторинга

### Нарушения архитектуры

- **Всего нарушений**: 3
  - **High**: 2 (сетевые I/O вне client/)
  - **Medium**: 1 (сортировки требуют проверки)
  - **Low**: 1 (избыточный импорт)

## Оценка метрик после рефакторинга

### Количество файлов (оценка)

- **Удаление дубликатов**:
  - CLI команды: 4 → 1 файл (-3 файла)
  - Итого: 291 → 288 файлов Python

- **Создание новых файлов**:
  - `cli/commands/external_source.py`: +1 файл
  - Итого: 288 → 289 файлов Python (чистое уменьшение на 2 файла)

### Lines of Code (оценка)

**Уменьшение LOC**:
- CLI команды: ~100 LOC → ~50 LOC (-50 LOC)
- `utils/chembl.py`: переписывание на UnifiedAPIClient (~-20 LOC за счет упрощения)

**Увеличение LOC**:
- `cli/commands/external_source.py`: +50 LOC
- Тесты: +200-300 LOC (golden, integration, property-based)

**Чистое изменение**: -20-50 LOC в production коде, +200-300 LOC в тестах

### Кластеры дубликатов (оценка после)

- **Ожидаемое количество**: 1-2 (уменьшение с 4)
  - CLI-001: устранен (4 → 1 файл)
  - HTTP-001: устранен (requests → UnifiedAPIClient)
  - PIPELINE-001: остается (может быть оптимизирован в батче 6)
  - OUTPUT-001: остается (разделение ролей корректно)

### Импорт-циклы (оценка после)

**Целевое значение**: 0 циклов

**После батча 5**: Полный анализ и устранение всех выявленных циклов

### Время сборки артефактов (оценка после)

**Ожидаемое изменение**: Без изменений или улучшение за счет:
- Устранение прямых requests (лучший retry/rate limiting)
- Оптимизация импортов (устранение циклов)

**Измерение**: Требует бенчмарков до и после

### Нарушения архитектуры (оценка после)

- **Ожидаемое**: 0 High нарушений, 0-1 Medium нарушений
- **После батчей 1-3**: Все High и Low нарушения устранены
- **После батча 4**: Medium нарушения (сортировки) устранены или задокументированы

## Метрики качества кода

### Покрытие тестами

**Текущее**: ≥85% (из `pyproject.toml`)

**После рефакторинга**:
- **Целевое**: ≥85% (сохранить)
- **Критичные модули**: ≥90%

### Сложность кода

**Метод**: Цикломатическая сложность (требует автоматического анализа)

**Рекомендации**:
- Использовать `radon` или `mccabe` для анализа
- Целевая сложность: <10 для большинства функций

### Технический долг

**Оценка до**:
- 4 кластера дубликатов
- 3 архитектурных нарушения
- Потенциальные циклы в зависимостях

**Оценка после**:
- 1-2 кластера дубликатов (остаются опциональные)
- 0 High нарушений
- 0 циклов в зависимостях

## Метрики для отслеживания

### CI метрики (рекомендуется добавить)

1. **Статический анализ**:
   - Проверка на прямые `requests.get/post/put/delete` вне `core/api_client.py`
   - Проверка на `print()` вместо логгера
   - Проверка импорт-циклов через `import-linter`

2. **Покрытие тестами**:
   - Текущее: `pytest --cov --cov-fail-under=85`
   - Критичные модули: отдельные проверки на ≥90%

3. **Детерминизм**:
   - Golden-тесты для критичных outputs
   - Проверка хешей outputs для бит-идентичности

4. **Производительность**:
   - Бенчмарки времени выполнения pipeline
   - Отслеживание регрессий

## План измерения после рефакторинга

1. **Автоматические метрики**:
   ```bash
   # Количество файлов
   find src/bioetl -name "*.py" | wc -l
   
   # LOC
   cloc src/bioetl
   
   # Покрытие тестами
   pytest --cov --cov-report=term-missing
   
   # Импорт-циклы
   pydeps --show-deps src/bioetl
   ```

2. **Ручные измерения**:
   - Время выполнения pipeline на эталонных данных
   - Сравнение outputs (bit-identical или diff)

3. **Регрессионные тесты**:
   - Golden-тесты для всех критичных outputs
   - Проверка детерминизма

## Целевые показатели

После завершения всех батчей рефакторинга:

- ✅ **Файлы**: Уменьшение на 2-3 файла (CLI дубликаты)
- ✅ **LOC**: Уменьшение на 20-50 строк production кода
- ✅ **Кластеры**: Уменьшение с 4 до 1-2
- ✅ **Нарушения**: 0 High, 0-1 Medium
- ✅ **Циклы**: 0 циклических зависимостей
- ✅ **Покрытие**: ≥85% (сохранить), ≥90% для критичных модулей
- ✅ **Детерминизм**: 100% бит-идентичность при одинаковых входных данных

