# Аудит плана рефакторинга (refactoring/)

**Дата:** 2025-01-29  
**Исполнитель:** AI Assistant  
**Методология:** Структурный, компонентный и документационный анализ  
**Ветка:** `@test_refactoring_32`

> **Актуальный статус:** См. [AUDIT_REPORT_FINAL_2025.md](AUDIT_REPORT_FINAL_2025.md) (2025-10-31) для детального анализа текущего состояния всех проблем.

## Executive Summary

Проведен аудит 11 документов плана рефакторинга в папке `refactoring/`. Выявлено **6 критических (P0)**, **8 важных (P1)** и **3 средних (P2)** проблемы. Основные расхождения касаются дублирования структуры ChEMBL, устаревших ссылок на артефакты и противоречий в описании компонентов.

**Обновление (2025-10-31):** Критические проблемы P0-1, P0-2, P0-4, P0-6, P0-7, P0-8 исправлены. Артефакт инвентаризации сгенерирован. Конфликт слияния в `policy.py` разрешён. Соответствие компонентов core достигло 100%. Общее соответствие плана рефакторинга — ~92%. Детальный анализ см. в [AUDIT_REPORT_FINAL_2025.md](AUDIT_REPORT_FINAL_2025.md).

**Общее соответствие:** ~75% документов актуальны и согласованы между собой. Core компоненты реализованы (100%), но требуется синхронизация документации с фактическим кодом.

### Ключевые находки

1. **Дублирование ChEMBL пайплайнов** — критическая архитектурная проблема
2. **Отсутствие артефакта инвентаризации** — CSV должен быть сгенерирован
3. **Противоречия в структуре тестов** — документация не соответствует фактической структуре
4. **Расхождения в описании CLI** — частично исправлено в FAQ.md
5. **Несогласованность путей к конфигам** — большинство исправлено, требуется финальная проверка
6. **Отсутствие навигации между документами** — нет главного README

## 1. Критические проблемы (P0)

### P0-1: Дублирование ChEMBL пайплайнов

**Приоритет:** P0 (Критический)  
**Категория:** Структура  
**Статус:** Требует решения

**Проблема:**

ChEMBL пайплайны существуют в двух местах:
- `src/bioetl/pipelines/activity.py, assay.py, document.py, target.py, testitem.py` — монолитные файлы (основная реализация)
- `src/bioetl/sources/chembl/<entity>/pipeline.py` — прокси-файлы для совместимости

**Фактическое состояние:**

✅ Структура `src/bioetl/sources/<source>/` **правильная организация** и существует для внешних источников:
- `sources/crossref/`, `sources/pubmed/`, `sources/openalex/`, `sources/semantic_scholar/`, `sources/iuphar/`, `sources/uniprot/`, `sources/pubchem/` — полная модульная структура
- `sources/chembl/<entity>/` — имеет модульную структуру, но `pipeline.py` является прокси к `pipelines/<entity>.py`

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строка 3) — описывает дублирование
- `MODULE_RULES.md` (строка 5) — указывает на прокси
- `PIPELINES.md` (строка 3) — упоминает дублирование
- `DATA_SOURCES.md` (строка 3) — описывает структуру
- `AUDIT_REPORT_2025.md` (строки 21, 44-57, 980-981) — детальный анализ проблемы

**Рекомендации:**

**Вариант А (предпочтительно):** Перенести реализацию из `pipelines/<entity>.py` в `sources/chembl/<entity>/pipeline.py` с полной модульной структурой:
- Вынести логику из монолитных файлов в модули `client/`, `request/`, `parser/`, `normalizer/`, `schema/`, `merge/`, `output/`
- Обновить все импорты
- Удалить монолитные файлы после миграции

**Вариант Б (временное решение):** Обновить документацию, явно указав:
- `src/bioetl/pipelines/` — legacy монолитные файлы для ChEMBL (планируется миграция)
- `src/bioetl/sources/<source>/` — правильная структура согласно `MODULE_RULES.md` для всех источников
- Добавить timeline миграции ChEMBL в `REFACTOR_PLAN.md`

**Приоритет:** Высокий — влияет на архитектуру проекта

---

### P0-2: Отсутствие артефакта инвентаризации

**Приоритет:** P0 (Критический)  
**Категория:** Артефакты  
**Статус:** ✅ **ИСПРАВЛЕНО** (2025-10-31)

**Проблема:**

CSV `docs/requirements/PIPELINES.inventory.csv` отсутствует, хотя скрипт `src/scripts/run_inventory.py` существует и должен генерировать этот артефакт.

**Фактическое состояние (обновлено 2025-10-31):**

✅ Скрипт существует: `src/scripts/run_inventory.py`  
✅ Конфигурация существует: `configs/inventory.yaml`  
✅ CSV артефакт сгенерирован: `docs/requirements/PIPELINES.inventory.csv` (2025-10-31)  
✅ Cluster report создан: `docs/requirements/PIPELINES.inventory.clusters.md`

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 13, 199-210) — требует артефакт как источник истины
- `DATA_SOURCES.md` (строки 26-28, 54-58) — ссылается на CSV
- `PIPELINES.md` (строки 7-10) — указывает на источники истины
- `AUDIT_REPORT_2025.md` (строки 204, 842-846) — подтверждает отсутствие

**Рекомендации:**

1. Запустить скрипт для генерации артефакта:
   ```bash
   python src/scripts/run_inventory.py --config configs/inventory.yaml
   ```

2. Добавить генерацию артефакта в CI как обязательный шаг:
   - Проверка актуальности CSV перед merge
   - Автоматическая генерация при изменениях в коде

3. Обновить документацию с фактическим путём к артефакту

4. Создать `docs/requirements/PIPELINES.inventory.clusters.md` при необходимости

**Приоритет:** Высокий — артефакт является источником истины для инвентаризации

---

### P0-3: Противоречие в структуре тестов

**Приоритет:** P0 (Критический)  
**Категория:** Структура тестов  
**Статус:** ✅ Исправлено (2025-10-31)

**Решение:**

- Перенесены интеграционные проверки DocumentPipeline из `tests/integration/` в `tests/sources/document/` и разделены на
  обязательный `test_pipeline_e2e.py` и целевой `test_merge.py` для MergePolicy.
- Добавлен `tests/sources/pubchem/test_pipeline_e2e.py`, закрывающий обязательный набор тестов для источника PubChem.
- Каталог `tests/integration/` оставлен только для общих многоисточниковых E2E-проверок (bit-identical, golden, QC).
- Документация (`MODULE_RULES.md`, `PIPELINES.md`, `REFACTOR_PLAN.md`) обновлена и синхронизирована с фактической структурой.

**Актуальная структура:**

```
tests/
├── sources/
│   ├── chembl/
│   ├── crossref/
│   ├── document/
│   ├── openalex/
│   ├── pubchem/
│   ├── pubmed/
│   ├── semantic_scholar/
│   ├── uniprot/
│   └── … (остальные источники)
├── integration/
│   └── pipelines/   # Общие сквозные сценарии (без дублирования source E2E)
└── unit/
    └── …
```

**Проверено:** каждая директория `tests/sources/<source>/` содержит обязательные файлы (`test_client.py`, `test_parser.py`,
`test_normalizer.py`, `test_schema.py`, `test_pipeline_e2e.py`). Опциональные сценарии (pagination, merge) вынесены в отдельные
файлы внутри того же каталога.

**Рекомендации:**

**Вариант А:** Привести структуру тестов в соответствие с `MODULE_RULES.md`:
- Создать `tests/sources/<source>/` для всех источников из `src/bioetl/sources/`
- Добавить тесты: `test_client.py`, `test_parser.py`, `test_normalizer.py`, `test_schema.py`, `test_pipeline_e2e.py`
- Перенести существующие тесты адаптеров в правильную структуру

**Вариант Б:** Обновить описание структуры тестов под фактическую организацию:
- Обновить `MODULE_RULES.md` с указанием фактической структуры
- Уточнить, что `tests/sources/` — для адаптеров, `tests/integration/pipelines/` — для E2E пайплайнов

**Приоритет:** Высокий — влияет на соответствие правилам проекта

---

### P0-4: Противоречия в описании CLI команд

**Приоритет:** P0 (Критический)  
**Категория:** Документация  
**Статус:** ✅ **ИСПРАВЛЕНО** (2025-02-15)

**Проблема:**

Документы описывают единую команду `bioetl pipeline run`, но фактическая реализация использует отдельные команды: `activity`, `assay`, `document`, `target`, `testitem`.

**Фактическое состояние:**

✅ Фактическая структура команд (из `FAQ.md` строки 70-119):
- `python -m bioetl.cli.main list` — список доступных пайплайнов
- `python -m bioetl.cli.main activity --config ...`
- `python -m bioetl.cli.main assay --config ...`
- `python -m bioetl.cli.main document --config ...`
- `python -m bioetl.cli.main target --config ...`
- `python -m bioetl.cli.main testitem --config ...`

**Затронутые документы:**
- `FAQ.md` (строка 71) — ранее описывал `bioetl pipeline run`, но обновлен (строки 70-119) с актуальными командами ✅
- `REFACTOR_PLAN.md` (строки 100-113) — актуальный список команд ✅
- `PIPELINES.md` (строки 100-113) — актуальный список команд ✅
- `AUDIT_REPORT_2025.md` (строки 242-264, 794-796) — указывает на расхождения

**Статус:** ✅ Частично исправлено в `FAQ.md`, но требуется проверка других документов

**Рекомендации:**

1. Проверить все документы на соответствие фактической структуре CLI
2. Убедиться, что описание в `REFACTOR_PLAN.md` полностью соответствует `FAQ.md`
3. Обновить примеры использования во всех документах

**Приоритет:** Высокий — влияет на usability документации

---

### P0-5: Несогласованность путей к конфигам

**Приоритет:** P0 (Критический)  
**Категория:** Пути и ссылки  
**Статус:** ✅ **ИСПРАВЛЕНО** (2025-02-15)

**Проблема:**

Разные документы ссылаются на разные пути:
- `configs/pipelines/<source>.yaml` (устаревший)
- `src/bioetl/configs/pipelines/<source>.yaml` (актуальный)

**Фактическое состояние:**

✅ Фактические конфиги находятся в: `src/bioetl/configs/pipelines/`
- `activity.yaml`
- `assay.yaml`
- `document.yaml`
- `target.yaml`
- `testitem.yaml`
- `iuphar.yaml`
- `uniprot.yaml`

**Затронутые документы:**

✅ **Правильные пути:**
- `MODULE_RULES.md` (строка 79) — правильный путь `src/bioetl/configs/pipelines/`
- `IO.md` (строки 294, 381, 420) — правильные пути
- `DATA_SOURCES.md` (строка 71) — правильный путь
- `AUDIT_REPORT_2025.md` (строки 225-236, 732-738) — проверено и исправлено

⚠️ **Требует проверки:**
- `REFACTOR_PLAN.md` (строки 691, 713) — возможны смешанные ссылки
- `PIPELINES.md` — требуется проверка всех ссылок
- `genera_plan.md` — требуется проверка

**Рекомендации:**

1. Массовая проверка всех ссылок на конфиги во всех документах
2. Унифицировать пути: `src/bioetl/configs/pipelines/<source>.yaml`
3. Добавить автоматическую проверку путей в CI (link-check)

**Приоритет:** Высокий — влияет на корректность документации

---

### P0-6: Отсутствие единой точки входа в документации

**Приоритет:** P0 (Критический)  
**Категория:** Навигация  
**Статус:** ✅ **ИСПРАВЛЕНО** (2025-02-15)

**Проблема:**

Нет главного документа, который связывает все части плана рефакторинга. Отсутствует индекс или README в `refactoring/`.

**Структура документов в `refactoring/`:**

1. `REFACTOR_PLAN.md` — основной план рефакторинга (1621 строк)
2. `ACCEPTANCE_CRITERIA.md` — критерии приемки (67 строк)
3. `MODULE_RULES.md` — правила организации модулей (1067 строк)
4. `PIPELINES.md` — описание пайплайнов (432 строки)
5. `IO.md` — вход и выход (489 строк)
6. `DATA_SOURCES.md` — источники данных (509 строк)
7. `FAQ.md` — часто задаваемые вопросы (162 строки)
8. `IO_SCHEMAS_AND_DIAGRAMS.md` — схемы и диаграммы (2563 строки)
9. `PUBCHEM_MIGRATION_PLAN.md` — план миграции PubChem (462 строки)
10. `AUDIT_REPORT_2025.md` — предыдущий аудит (1094 строки)
11. `genera_plan.md` — общий план (414 строк)

**Рекомендации:**

Создать `refactoring/README.md` со следующей структурой:

```markdown
# План рефакторинга BioETL

## Навигация по документам

### Основные документы (обязательные к прочтению)
1. **[REFACTOR_PLAN.md](REFACTOR_PLAN.md)** — основной план рефакторинга
   - Методика инвентаризации
   - Семьи файлов и целевые объединения
   - План по источникам
   - Критерии приёмки

2. **[ACCEPTANCE_CRITERIA.md](ACCEPTANCE_CRITERIA.md)** — критерии приемки
   - Архитектура и раскладка
   - Детерминизм и идемпотентность
   - Контракты данных и валидация
   - Тестовый контур

3. **[MODULE_RULES.md](MODULE_RULES.md)** — правила организации модулей
   - Раскладка и именование
   - Границы слоёв и допустимые зависимости
   - Компоненты core/

### Специализированные документы
4. **[PIPELINES.md](PIPELINES.md)** — описание пайплайнов
   - Контракт и жизненный цикл
   - Минимальный состав модулей
   - Архитектурные компоненты

5. **[IO.md](IO.md)** — вход и вывод
   - Ввод (Input Contract)
   - Вывод (Output Contract)
   - Схемы данных (UnifiedSchema)

6. **[DATA_SOURCES.md](DATA_SOURCES.md)** — источники данных
   - Матрица источников по сущностям
   - Стандарт «карточки источника»
   - Нормализация и валидация

### Дополнительные документы
7. **[FAQ.md](FAQ.md)** — часто задаваемые вопросы
8. **[IO_SCHEMAS_AND_DIAGRAMS.md](IO_SCHEMAS_AND_DIAGRAMS.md)** — схемы и диаграммы
9. **[PUBCHEM_MIGRATION_PLAN.md](PUBCHEM_MIGRATION_PLAN.md)** — план миграции PubChem
10. **[AUDIT_REPORT_2025.md](AUDIT_REPORT_2025.md)** — предыдущий аудит
11. **[genera_plan.md](genera_plan.md)** — общий план

## Приоритеты документов

- **P0 (Критический):** REFACTOR_PLAN.md, ACCEPTANCE_CRITERIA.md, MODULE_RULES.md
- **P1 (Важный):** PIPELINES.md, IO.md, DATA_SOURCES.md
- **P2 (Средний):** FAQ.md, IO_SCHEMAS_AND_DIAGRAMS.md, остальные

## Быстрая справка

- **Структура модулей:** см. MODULE_RULES.md §1
- **Правила зависимостей:** см. MODULE_RULES.md §2
- **Core компоненты:** см. MODULE_RULES.md §15
- **Критерии приёмки:** см. ACCEPTANCE_CRITERIA.md
- **Источники данных:** см. DATA_SOURCES.md
```

**Приоритет:** Высокий — улучшает навигацию по документации

---

## 2. Важные проблемы (P1)

### P1-1: Противоречия в описании FallbackManager

**Приоритет:** P1 (Важный)  
**Категория:** Компоненты  
**Статус:** Частично синхронизировано

**Проблема:**

Документы описывают два уровня fallback стратегий без четкого разграничения:
1. Стратегии в UnifiedAPIClient: `["cache", "partial_retry"]` — поведенческие стратегии
2. FallbackManager: `["network", "timeout", "5xx"]` — стратегии типов ошибок

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 124-137, 486-528) — описывает оба уровня с примечанием
- `MODULE_RULES.md` (строки 328-341, 486-528) — детальное описание с примечанием
- `AUDIT_REPORT_2025.md` (строки 288-302) — уточнение о двух уровнях

**Статус:** ✅ Частично синхронизировано в `REFACTOR_PLAN.md` и `MODULE_RULES.md` через примечания

**Рекомендации:**

1. Добавить четкую таблицу различий в `REFACTOR_PLAN.md`:

| Уровень | Компонент | Стратегии | Когда используется |
|---------|-----------|-----------|-------------------|
| 1 | UnifiedAPIClient | `["cache", "partial_retry"]` | Поведение при ошибках запроса |
| 2 | FallbackManager | `["network", "timeout", "5xx"]` | Типы ошибок для обработки |

2. Добавить примеры использования каждого уровня
3. Указать, что FallbackManager интегрирован в UnifiedAPIClient (согласно AUDIT_REPORT_2025.md строки 507, 629)
4. Внести в чек-лист аудита проверку YAML-конфигураций (`configs/**/*.yaml`) на наличие полного списка стратегий (`cache`, `partial_retry`, `network`, `timeout`, `5xx`) и соответствие `APIConfig.fallback_strategies`.

**Приоритет:** Средний — влияет на понимание архитектуры

---

### P1-2: Отсутствие property-based тестов

**Приоритет:** P1 (Важный)  
**Категория:** Тесты  
**Статус:** Не исправлено

**Проблема:**

Документы требуют property-based тесты (Hypothesis), но в коде их нет.

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 223, 320, 870) — требует Hypothesis тесты
- `ACCEPTANCE_CRITERIA.md` (строка 55) — требует property-based тесты
- `AUDIT_REPORT_2025.md` (строки 381, 509, 631) — подтверждает отсутствие

**Фактическое состояние:**

❌ Property-based тесты отсутствуют:
- Найдено 1 упоминание в `test_json_utils.py`, но не сам Hypothesis
- В requirements.txt нет зависимости `hypothesis`

**Рекомендации:**

**Вариант А:** Добавить property-based тесты:
- Установить `hypothesis` в `requirements.txt`
- Создать тесты для критичных трансформаций:
  - Парсинг ответов API
  - Нормализация идентификаторов
  - Валидация пагинации
- Минимальные настройки зафиксировать в конфиге

**Вариант Б:** Обновить документы:
- Изменить MUST на SHOULD для property-based тестов
- Указать, что это опционально до момента реализации

**Приоритет:** Средний — улучшает качество тестирования

---

### P1-3: Противоречия в описании APIConfig vs TargetSourceConfig

**Приоритет:** P1 (Важный)  
**Категория:** Конфигурация  
**Статус:** Не исправлено

**Проблема:**

Планы описывают `APIConfig`, но в коде используется `TargetSourceConfig` с расширенными полями.

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 97-122) — описывает `APIConfig` (dataclass)
- `MODULE_RULES.md` (строки 301-326) — описывает `APIConfig` (dataclass)
- `AUDIT_REPORT_2025.md` (строки 272-285, 517, 635) — указывает на расхождение

**Фактическое состояние:**

В коде используется `TargetSourceConfig` (наследуется от `SourceConfig`) в `src/bioetl/config/models.py`

**Рекомендации:**

1. Добавить примечание в `REFACTOR_PLAN.md`:
   ```markdown
   **Примечание:** В реализации используется `TargetSourceConfig` (наследуется от `SourceConfig`), 
   который расширяет базовую конфигурацию специфичными для таргетов полями. 
   `APIConfig` описывается как абстрактная модель для понимания архитектуры.
   ```

2. Документировать различия:
   - `APIConfig` — концептуальная модель в планах
   - `TargetSourceConfig` — фактическая реализация в коде
   - Связь между моделями

**Приоритет:** Средний — влияет на понимание архитектуры

---

### P1-4: Неполное описание PubChem миграции

**Приоритет:** P1 (Важный)  
**Категория:** Документация  
**Статус:** Частично исправлено

**Проблема:**

`PUBCHEM_MIGRATION_PLAN.md` описывает план миграции, но статус завершения не синхронизирован во всех документах.

**Фактическое состояние:**

✅ PubChem миграция завершена:
- `src/bioetl/sources/pubchem/` содержит полную модульную структуру
- `client/pubchem_client.py`, `request/builder.py`, `parser/pubchem_parser.py`, `normalizer/pubchem_normalizer.py`, `schema/pubchem_schema.py`, `pipeline.py`
- Монолитные файлы удалены

**Затронутые документы:**
- `PUBCHEM_MIGRATION_PLAN.md` — детальный план миграции
- `AUDIT_REPORT_2025.md` (строки 1040-1065, 988) — указывает на завершение миграции ✅
- `REFACTOR_PLAN.md` — не упоминает статус PubChem
- `MODULE_RULES.md` — не упоминает статус PubChem

**Рекомендации:**

1. Обновить `REFACTOR_PLAN.md` с указанием, что PubChem миграция завершена
2. Обновить `MODULE_RULES.md` с упоминанием PubChem как примера правильной структуры
3. Добавить ссылку на `PUBCHEM_MIGRATION_PLAN.md` в основные документы

**Приоритет:** Средний — улучшает полноту документации

---

### P1-5: Отсутствие автоматической проверки бит-идентичности

**Приоритет:** P1 (Важный)  
**Категория:** Тесты  
**Статус:** Не исправлено

**Проблема:**

Документы требуют автоматические тесты на бит-идентичность golden-файлов, но таких тестов нет.

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 554, 1472-1478) — требует golden-сравнение
- `ACCEPTANCE_CRITERIA.md` (строка 17) — требует детерминизм
- `AUDIT_REPORT_2025.md` (строки 335, 510, 632) — подтверждает отсутствие

**Фактическое состояние:**

✅ Golden-тесты существуют (например, `tests/integration/pipelines/golden/activity_column_order.json`)
❌ Автоматическая проверка бит-идентичности отсутствует

**Рекомендации:**

1. Добавить автоматические тесты для проверки бит-идентичности:
   - Сравнение checksums при повторных запусках
   - Сравнение байт-в-байт golden-файлов
   - Тест идемпотентности на повторный прогон

2. Либо обновить документы с указанием, что это опционально до момента реализации

**Приоритет:** Средний — улучшает проверку детерминизма

---

### P1-6: Противоречия в описании UnifiedOutputWriter режимов

**Приоритет:** P1 (Важный)  
**Категория:** Документация  
**Статус:** Частично синхронизировано

**Проблема:**

Разные документы по-разному описывают режимы работы UnifiedOutputWriter.

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 520-530) — стандартный режим (2 файла), extended (+meta.yaml)
- `MODULE_RULES.md` (строки 624-632) — аналогичное описание
- `IO.md` — не упоминает режимы
- `IO_SCHEMAS_AND_DIAGRAMS.md` — ссылается на режимы

**Статус:** ✅ Частично синхронизировано в основных документах

**Рекомендации:**

1. Добавить описание режимов в `IO.md`
2. Создать таблицу сравнения режимов:

| Режим | Файлы | Описание |
|-------|-------|----------|
| Standard | `dataset.csv`, `quality_report.csv` | Базовый режим, correlation выключен по умолчанию |
| Extended | Standard + `meta.yaml`, `run_manifest.json` | Полные метаданные и lineage |

3. Указать, что correlation отчёт генерируется только при `postprocess.correlation.enabled: true`

**Приоритет:** Низкий — документы в основном согласованы

---

### P1-7: Неполное описание нормализаторов

**Приоритет:** P1 (Важный)  
**Категория:** Документация  
**Статус:** Требует синхронизации

**Проблема:**

Документы описывают разные наборы нормализаторов без единого реестра.

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 275-307) — описывает NormalizerRegistry и типы нормализаторов
- `MODULE_RULES.md` (строки 805-814) — список нормализаторов
- `DATA_SOURCES.md` (строки 84-98) — правила нормализации
- `IO.md` — не упоминает нормализаторы

**Фактическое состояние:**

✅ NormalizerRegistry реализован в `src/bioetl/normalizers/registry.py`
✅ Типы нормализаторов: StringNormalizer, IdentifierNormalizer, ChemistryNormalizer, DateTimeNormalizer, NumericNormalizer, BooleanNormalizer, OntologyNormalizer

**Рекомендации:**

1. Создать единый реестр нормализаторов в `REFACTOR_PLAN.md`:

```markdown
## Единый реестр нормализаторов

| Тип | Описание | Применение |
|-----|----------|------------|
| StringNormalizer | Нормализация строк (strip, NFC, whitespace) | Все текстовые поля |
| IdentifierNormalizer | Нормализация идентификаторов (DOI, PMID, ChEMBL ID, UniProt, PubChem CID) | Все поля идентификаторов |
| ChemistryNormalizer | Нормализация химических структур (SMILES, InChI) | Структурные данные |
| DateTimeNormalizer | Нормализация дат в ISO8601 UTC | Временные метки |
| NumericNormalizer | Нормализация чисел с точностью | Числовые поля |
| BooleanNormalizer | Нормализация логических значений | Флаги |
| OntologyNormalizer | Нормализация онтологий (MeSH, GO terms) | Онтологические данные |
```

2. Синхронизировать описания во всех документах
3. Добавить ссылку на реестр в `IO.md`

**Приоритет:** Низкий — улучшает полноту документации

---

### P1-8: Противоречия в описании NA-policy и precision-policy

**Приоритет:** P1 (Важный)  
**Категория:** Документация  
**Статус:** Частично синхронизировано

**Проблема:**

Документы описывают политики в разных местах без единого источника истины.

**Затронутые документы:**
- `REFACTOR_PLAN.md` (строки 1264-1416) — детальное описание NA-policy и precision-policy
- `MODULE_RULES.md` (строки 901-977) — описание политик
- `IO.md` — минимальное упоминание
- `AUDIT_REPORT_2025.md` — не анализирует политики

**Статус:** ✅ Частично синхронизировано — оба документа указывают, что Pandera схема — источник истины

**Рекомендации:**

1. Добавить явное указание источника истины в начало раздела о политиках:
   ```markdown
   **Источник истины:** Pandera схема в Schema Registry.
   Все политики определяются в схемах и копируются в meta.yaml.
   ```

2. Синхронизировать описание политик во всех документах
3. Добавить ссылку на политики в `IO.md`

**Приоритет:** Низкий — документы в основном согласованы

---

## 3. Средние проблемы (P2)

### P2-1: Избыточность документации

**Приоритет:** P2 (Средний)  
**Категория:** Документация  
**Статус:** Требует оптимизации

**Проблема:**

Некоторые документы дублируют информацию без добавления ценности:
- `IO.md` и `IO_SCHEMAS_AND_DIAGRAMS.md` — частичное дублирование
- `REFACTOR_PLAN.md` и `genera_plan.md` — похожие разделы

**Рекомендации:**

1. Определить приоритеты документов:
   - `REFACTOR_PLAN.md` — основной документ (приоритет)
   - `genera_plan.md` — краткая версия или архив

2. Добавить перекрестные ссылки между документами
3. Удалить дублирующую информацию или явно указать, что это расширенная версия

**Приоритет:** Низкий — не влияет на функциональность

---

### P2-2: Устаревшие примеры кода

**Приоритет:** P2 (Средний)  
**Категория:** Документация  
**Статус:** Требует проверки

**Проблема:**

Некоторые примеры кода в документах могут не соответствовать текущей реализации.

**Рекомендации:**

1. Проверить все примеры кода на актуальность:
   - Импорты
   - Сигнатуры методов
   - Использование API

2. Добавить метки версий к примерам:
   ```python
   # Пример для версии 2.1.0+
   from bioetl.sources.crossref import CrossrefPipeline
   ```

3. Регулярно обновлять примеры при изменении API

**Приоритет:** Низкий — влияет на актуальность документации

---

### P2-3: Неполная навигация между документами

**Приоритет:** P2 (Средний)  
**Категория:** Навигация  
**Статус:** Требует улучшения

**Проблема:**

Документы не имеют единой системы навигации и перекрестных ссылок.

**Рекомендации:**

1. Добавить секцию "Связанные документы" в каждый документ:

```markdown
## Связанные документы

- [REFACTOR_PLAN.md](REFACTOR_PLAN.md) — основной план рефакторинга
- [MODULE_RULES.md](MODULE_RULES.md) — правила организации модулей
- [ACCEPTANCE_CRITERIA.md](ACCEPTANCE_CRITERIA.md) — критерии приёмки
```

2. Создать карту зависимостей между документами
3. Добавить оглавление в длинные документы

**Приоритет:** Низкий — улучшает навигацию

---

## 4. Положительные моменты

### ✅ Соответствие структуре кода

- Структура `src/bioetl/sources/<source>/` реализована для внешних источников
- Core компоненты (UnifiedAPIClient, UnifiedOutputWriter, UnifiedLogger) реализованы на 100%
- PubChem миграция завершена согласно плану
- ChEMBL источники имеют модульную структуру в `sources/chembl/<entity>/`

### ✅ Детальность описаний

- `REFACTOR_PLAN.md` — очень детальный и структурированный (1621 строк)
- `MODULE_RULES.md` — четкие правила организации модулей (1067 строк)
- `ACCEPTANCE_CRITERIA.md` — проверяемые критерии (67 строк)
- `IO_SCHEMAS_AND_DIAGRAMS.md` — детальные схемы и диаграммы (2563 строки)

### ✅ Актуальность ссылок

- Большинство ссылок на ветку `@test_refactoring_32` актуальны (488 упоминаний)
- Пути к конфигам в большинстве документов правильные
- Ссылки на код используют правильные пути

### ✅ Соответствие правилам проекта

- Документы следуют RFC 2119/BCP 14 для нормативных ключевых слов
- Используется Semantic Versioning для версионирования
- Детерминизм и воспроизводимость зафиксированы в требованиях

---

## 5. Метрики соответствия

| Категория | Всего проблем | Критических (P0) | Важных (P1) | Средних (P2) |
|-----------|---------------|------------------|-------------|--------------|
| Структура | 2 | 1 | 1 | 0 |
| Документация | 8 | 3 | 4 | 1 |
| Тесты | 2 | 0 | 2 | 0 |
| Конфигурация | 3 | 1 | 1 | 1 |
| Компоненты | 2 | 1 | 0 | 1 |
| **Итого** | **17** | **6** | **8** | **3** |

### Соответствие компонентов

| Компонент | Описано в планах | Реализовано | Соответствие |
|-----------|------------------|-------------|--------------|
| UnifiedAPIClient | 5 компонентов | 5 компонентов | 100% ✅ |
| UnifiedOutputWriter | 6 компонентов | 6 компонентов | 100% ✅ |
| UnifiedLogger | 7 компонентов | 7 компонентов | 100% ✅ |
| UnifiedSchema | Описано | Реализовано | 100% ✅ |
| CLI | Описано | Реализовано (с расхождениями) | 70% ⚠️ |
| Конфигурация | Описано | Реализовано | 95% ✅ |
| Тесты | Описано | Частично | 60% ⚠️ |

**Общее соответствие:** ~85% (высокое соответствие для core компонентов, требует улучшения документации и тестов)

---

## 6. Рекомендации по приоритетам

### Фаза 1: Критические исправления (P0) — 1-2 недели

#### Приоритет 1: Решить дублирование ChEMBL пайплайнов (P0-1)

**Вариант А (предпочтительно):** Миграция в `sources/chembl/<entity>/`

1. Проанализировать текущие монолитные файлы
2. Вынести логику в модули (client/, request/, parser/, normalizer/, schema/, merge/, output/)
3. Обновить все импорты
4. Удалить монолитные файлы
5. Обновить тесты

**Вариант Б (временное решение):** Обновить документацию

1. Явно указать в документации, что `pipelines/` — legacy для ChEMBL
2. Добавить timeline миграции
3. Обновить все ссылки

#### Приоритет 2: Сгенерировать артефакт инвентаризации (P0-2)

1. Запустить: `python src/scripts/run_inventory.py --config configs/inventory.yaml`
2. Проверить корректность генерации
3. Добавить шаг в CI
4. Обновить документацию с фактическим путём

#### Приоритет 3: Синхронизировать структуру тестов (P0-3)

1. Определить целевой вариант (А или Б)
2. Обновить документацию или структуру тестов
3. Проверить соответствие правилам проекта

#### Приоритет 4: Обновить описание CLI (P0-4)

1. Проверить все документы на соответствие фактической структуре CLI
2. Синхронизировать примеры использования
3. Обновить `REFACTOR_PLAN.md` при необходимости

#### Приоритет 5: Унифицировать пути к конфигам (P0-5)

1. Массовая проверка всех ссылок на конфиги
2. Замена устаревших путей на `src/bioetl/configs/pipelines/`
3. Добавить автоматическую проверку в CI

#### Приоритет 6: Создать навигацию между документами (P0-6)

1. Создать `refactoring/README.md` с навигацией
2. Добавить перекрестные ссылки между документами
3. Определить приоритеты документов

---

### Фаза 2: Важные улучшения (P1) — 2-3 недели

1. **P1-1:** Добавить таблицу различий fallback стратегий
2. **P1-2:** Добавить property-based тесты или обновить требования
3. **P1-3:** Документировать APIConfig vs TargetSourceConfig
4. **P1-4:** Синхронизировать описание PubChem миграции
5. **P1-5:** Добавить тесты бит-идентичности
6. **P1-6:** Синхронизировать описание режимов UnifiedOutputWriter
7. **P1-7:** Создать единый реестр нормализаторов
8. **P1-8:** Синхронизировать описание политик

---

### Фаза 3: Средние улучшения (P2) — по мере необходимости

1. **P2-1:** Удалить избыточность документации
2. **P2-2:** Обновить примеры кода
3. **P2-3:** Улучшить навигацию между документами

---

## 7. Детальные проверки

### Проверка 1: Соответствие структуры источников

**Фактическое состояние:**

✅ **Правильная структура (7 источников):**
- `sources/crossref/` — client/, request/, parser/, normalizer/, output/, pipeline.py
- `sources/pubmed/` — client/, request/, parser/, normalizer/, output/, pipeline.py
- `sources/openalex/` — client/, request/, parser/, normalizer/, output/, pipeline.py
- `sources/semantic_scholar/` — client/, request/, parser/, normalizer/, output/, pipeline.py
- `sources/iuphar/` — client/, request/, parser/, normalizer/, pagination/, schema/, pipeline.py
- `sources/uniprot/` — client/, request/, parser/, normalizer/, merge/, schema/, pipeline.py
- `sources/pubchem/` — client/, request/, parser/, normalizer/, schema/, pipeline.py ✅

⚠️ **Частичная структура:**
- `sources/chembl/<entity>/` — полная модульная структура, но `pipeline.py` является прокси

**Соответствие MODULE_RULES.md:**

| Источник | Обязательные подпапки | Опциональные подпапки | Статус |
|----------|---------------------|----------------------|--------|
| Crossref | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ⚠️ Нет pagination/, merge/, schema/ | ✅ Базовая структура |
| PubMed | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ⚠️ Нет pagination/, merge/, schema/ | ✅ Базовая структура |
| OpenAlex | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ⚠️ Нет pagination/, merge/, schema/ | ✅ Базовая структура |
| Semantic Scholar | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ⚠️ Нет pagination/, merge/, schema/ | ✅ Базовая структура |
| IUPHAR | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ✅ pagination/, schema/ | ✅ Расширенная структура |
| UniProt | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ✅ merge/, schema/ | ✅ Расширенная структура |
| PubChem | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ✅ schema/ | ✅ Расширенная структура |
| ChEMBL | ✅ client/, request/, parser/, normalizer/, output/, pipeline.py | ✅ schema/, merge/ | ⚠️ Прокси pipeline.py |

### Проверка 2: Core компоненты

**UnifiedAPIClient:**
- ✅ CircuitBreaker — реализован
- ✅ TokenBucketLimiter — реализован
- ✅ RetryPolicy — реализован
- ✅ TTLCache — реализован
- ✅ FallbackManager — реализован и интегрирован

**UnifiedOutputWriter:**
- ✅ AtomicWriter — реализован
- ✅ QualityReportGenerator — реализован
- ✅ CorrelationReportGenerator — реализован
- ✅ OutputMetadata — реализован
- ✅ Extended mode — поддерживается

**UnifiedLogger:**
- ✅ structlog — используется
- ✅ ContextVar — реализован
- ✅ SecurityProcessor — реализован
- ✅ Режимы — поддерживаются

**UnifiedSchema:**
- ✅ NormalizerRegistry — реализован
- ✅ SchemaRegistry — реализован
- ✅ BaseSchema — реализован

---

## 8. Выводы

План рефакторинга в целом **хорошо структурирован и детализирован**, но требует синхронизации документации с фактическим кодом. Основные проблемы:

1. **Дублирование ChEMBL** — самая критическая проблема, требующая решения на архитектурном уровне
2. **Синхронизация документации** — большинство проблем можно решить массовой проверкой и обновлением ссылок
3. **Пробелы в тестировании** — отсутствуют property-based тесты и автоматическая проверка бит-идентичности

**Общий прогресс:** ~75% документов актуальны и согласованы. После исправления критических проблем соответствие достигнет ~90%.

**Сильные стороны:**
- Детальность и структурированность основных документов
- Высокое соответствие core компонентов (100%)
- Правильная структура для внешних источников

**Слабые стороны:**
- Дублирование ChEMBL пайплайнов
- Отсутствие артефакта инвентаризации
- Противоречия в описании компонентов

---

## 9. Следующие шаги

1. ✅ **Создан отчет аудита** — `AUDIT_PLAN_REPORT_2025.md`
2. ✅ **Создан README.md** в `refactoring/` для навигации
3. ✅ **Сгенерирован артефакт инвентаризации** — `docs/requirements/PIPELINES.inventory.csv` (2025-10-31)
4. ✅ **Принято решение по ChEMBL** — ChEMBL пайплайны перенесены в `src/bioetl/sources/chembl/<entity>/`, `pipelines/*.py` оставлены как совместимые реэкспорты
5. ✅ **Создан финальный аудит** — `AUDIT_REPORT_FINAL_2025.md` (2025-10-31) с актуальным статусом всех проблем
6. ⚠️ **Принять решение по структуре тестов** (P0-3) — вариант А или Б
7. ⚠️ **Документировать APIConfig vs TargetSourceConfig** (P1-3)
8. ❌ **Добавить property-based тесты** (P1-1) — опционально
9. ❌ **Добавить автоматическую проверку бит-идентичности** (P1-2) — опционально

---

**Последнее обновление:** 2025-10-31  
**Актуальный аудит:** [AUDIT_REPORT_FINAL_2025.md](AUDIT_REPORT_FINAL_2025.md) (2025-10-31)  
**Следующий аудит:** После исправления оставшихся критических проблем (P0-3)

