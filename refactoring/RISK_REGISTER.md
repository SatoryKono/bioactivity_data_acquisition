# Реестр рисков рефакторинга

**Дата**: 2025-01-29  
**Ветка**: test_refactoring_32  
**Аннотация**: Реестр рисков, связанных с рефакторингом кода. Для каждого риска указаны источник, вероятность, влияние, стратегия митигации и требуемые тесты.

## Таблица рисков

| risk | source | probability | impact | mitigation | tests |
|------|--------|-------------|--------|-------------|-------|
| Регрессия в fetch_chembl_release | Батч 1: изменение сигнатуры функции | Medium | High | Сохранить обратную совместимость через wrapper или использовать Union[UnifiedAPIClient, str] с созданием временного клиента | Интеграционные тесты всех вызовов fetch_chembl_release |
| Breaking change в CLI командах | Батч 2: унификация CLI | Low | Medium | Тщательное тестирование всех 4 команд, сохранение совместимости интерфейса | E2E тесты всех CLI команд external sources |
| Потеря детерминизма при рефакторинге | Батч 4: изменения в sort_values() | Low | High | Golden-тесты перед изменениями, проверка бит-в-бит идентичности | Golden-тесты для всех критичных pipeline outputs |
| Циклические зависимости не обнаружены | Батч 5: анализ графа зависимостей | Medium | Medium | Использование автоматических инструментов (pydeps), ручная проверка топ-модулей | Статический анализ импортов в CI |
| Breaking change в конфигах | Батч 6: вынос adapter_definition | Medium | Medium | Версионирование конфигов, миграционные скрипты, депрекация старого формата | Тесты совместимости старых и новых конфигов |
| Пропущенные места использования fetch_chembl_release | Батч 1: рефакторинг utils/chembl.py | Medium | Medium | Автоматический поиск через grep/codebase_search, обновление всех мест | Тесты на отсутствие прямых requests в utils/ |
| Регрессия в обработке timeout | Батч 3: изменение импорта requests | Low | Low | Проверка всех использований ReadTimeout, unit тесты | Unit тесты обработки timeout в document_client |

## Детализация рисков

### 1. Регрессия в fetch_chembl_release

**Источник**: Батч 1 - изменение сигнатуры функции для обязательного использования `UnifiedAPIClient`.

**Вероятность**: Medium  
**Влияние**: High - функция используется в критичных местах для определения версии ChEMBL.

**Стратегия митигации**:
1. Сохранить обратную совместимость через wrapper с поддержкой строки:
   ```python
   def fetch_chembl_release(
       api_client: UnifiedAPIClient | str,
   ) -> ChemblRelease:
       if isinstance(api_client, str):
           # Создать временный UnifiedAPIClient
           temp_client = UnifiedAPIClient(APIConfig(name="temp", base_url=api_client))
           return _fetch_via_client(temp_client)
       return _fetch_via_client(api_client)
   ```
2. Добавить deprecation warning для использования строки
3. Постепенно мигрировать все вызовы на UnifiedAPIClient

**Требуемые тесты**:
- `tests/unit/utils/test_chembl.py`: мок UnifiedAPIClient
- `tests/integration/utils/test_chembl.py`: реальный клиент
- `tests/integration/pipelines/test_chembl_*.py`: проверка работы с реальными pipeline

### 2. Breaking change в CLI командах

**Источник**: Батч 2 - унификация CLI команд через factory.

**Вероятность**: Low - структура идентична  
**Влияние**: Medium - пользователи могут зависеть от конкретных команд

**Стратегия митигации**:
1. Сохранить все 4 команды в реестре с теми же именами
2. Тщательное тестирование всех 4 команд через E2E тесты
3. Проверить совместимость параметров командной строки
4. Сохранить обратную совместимость через сохранение старых точек входа (если нужно)

**Требуемые тесты**:
- `tests/e2e/test_cli_crossref.py`
- `tests/e2e/test_cli_openalex.py`
- `tests/e2e/test_cli_pubmed.py`
- `tests/e2e/test_cli_semantic_scholar.py`
- Проверка всех параметров: `--config`, `--input-file`, `--output-dir`, `--dry-run`

### 3. Потеря детерминизма при рефакторинге

**Источник**: Батч 4 - изменения в `sort_values()` для обеспечения детерминизма.

**Вероятность**: Low - только улучшения  
**Влияние**: High - детерминизм критичен для воспроизводимости

**Стратегия митигации**:
1. Создать golden-тесты ДО изменений для всех критичных pipeline outputs
2. Проверить бит-в-бит идентичность после изменений
3. Использовать `kind="stable"` или полный набор ключей для сортировки
4. Добавить в CI проверку детерминизма через сравнение хешей outputs

**Требуемые тесты**:
- Golden-тесты для: `activity.csv`, `assay.csv`, `target.csv`, `testitem.csv`, `document.csv`
- Тесты на детерминизм сортировок (bit-identical outputs)
- Property-based тесты для проверки стабильности сортировки

### 4. Циклические зависимости не обнаружены

**Источник**: Батч 5 - анализ графа зависимостей (не все циклы могут быть выявлены).

**Вероятность**: Medium - некоторые циклы могут быть замаскированы  
**Влияние**: Medium - циклические зависимости ухудшают тестируемость

**Стратегия митигации**:
1. Использовать автоматические инструменты: `pydeps`, `import-linter`
2. Ручная проверка топ-10 модулей по количеству импортов
3. Проверить динамические импорты и lazy loading
4. Добавить статический анализ в CI

**Требуемые тесты**:
- CI проверка через `import-linter` или `pydeps`
- Тесты на отсутствие циклов в графе зависимостей
- Ручная проверка документации импортов

### 5. Breaking change в конфигах

**Источник**: Батч 6 (опциональный) - вынос adapter_definition в YAML конфиги.

**Вероятность**: Medium - изменения в формате конфигов  
**Влияние**: Medium - требует обновления всех конфигов

**Стратегия митигации**:
1. Версионирование конфигов: добавить `config_version: "2.0"`
2. Поддержка старого формата через backward compatibility wrapper
3. Миграционные скрипты для конвертации старых конфигов
4. Deprecation warning для старого формата
5. Документация миграции

**Требуемые тесты**:
- Тесты совместимости: загрузка старых и новых конфигов
- Интеграционные тесты с обоими форматами
- Тесты миграции конфигов

### 6. Пропущенные места использования fetch_chembl_release

**Источник**: Батч 1 - может быть пропущено место использования строки.

**Вероятность**: Medium - функция может использоваться в неочевидных местах  
**Влияние**: Medium - runtime ошибки при неподдерживаемом формате

**Стратегия митигации**:
1. Автоматический поиск: `grep -r "fetch_chembl_release" src/ tests/`
2. `codebase_search` для семантического поиска
3. Статический анализ через `grep` на `fetch_chembl_release\(["']` (строковый аргумент)
4. Type checking через mypy после изменений

**Требуемые тесты**:
- Статический анализ: grep на все вызовы
- Type checking: mypy должен найти проблемы
- Runtime тесты: проверить все пути выполнения

### 7. Регрессия в обработке timeout

**Источник**: Батч 3 - изменение импорта `requests`.

**Вероятность**: Low - минимальные изменения  
**Влияние**: Low - только обработка исключений

**Стратегия митигации**:
1. Проверить все использований `requests.exceptions.*` в файле
2. Убедиться, что `ReadTimeout` импортируется корректно
3. Unit тесты обработки timeout

**Требуемые тесты**:
- `tests/unit/sources/chembl/document/test_client.py`: тест обработки ReadTimeout
- Проверка, что исключение обрабатывается корректно

## Приоритизация рисков

1. **High Impact**: Риски 1 (fetch_chembl_release) и 3 (детерминизм)
2. **Medium Impact**: Риски 2 (CLI), 4 (циклы), 5 (конфиги), 6 (пропущенные места)
3. **Low Impact**: Риск 7 (timeout)

## Общие рекомендации

1. **Страховочные тесты**: Создать golden-тесты для критичных функций ДО рефакторинга
2. **Постепенная миграция**: Сохранять обратную совместимость с deprecation warnings
3. **CI проверки**: Добавить автоматические проверки на регрессии
4. **Документация**: Обновить документацию для всех breaking changes
5. **Тестирование**: Увеличить coverage критичных модулей перед рефакторингом

