# План рефакторинга

**Дата**: 2025-01-29  
**Ветка**: test_refactoring_32  
**Аннотация**: Поэтапный план устранения дубликатов кода и архитектурных нарушений. План разбит на батчи ≤300 LOC каждый с независимыми тестами и критериями готовности.

## Общая стратегия

1. **Приоритет 1**: Исправление архитектурных нарушений (High severity)
2. **Приоритет 2**: Унификация дублирующихся CLI команд (Low risk, high impact)
3. **Приоритет 3**: Оптимизация комплементарных модулей (Low priority)

## Батч 1: Устранение прямых requests вызовов (High Priority)

**Цель**: Устранить использование прямых `requests.get()` вне `client/` слоя.

**Файлы для изменения**:
- `src/bioetl/utils/chembl.py` (~40 LOC изменений)

**Шаги**:
1. Изменить сигнатуру `fetch_chembl_release()` для обязательного использования `UnifiedAPIClient`
2. Переписать `_request_status()` на использование `api_client.request_json("/status.json")`
3. Удалить fallback для строки base_url или создать временный `UnifiedAPIClient` при передаче строки
4. Обновить все вызовы `fetch_chembl_release(str)` в кодовой базе

**Зависимости**: Нет

**Критерии "done"**:
- ✅ Все тесты проходят
- ✅ `grep -r "requests.get" src/bioetl/utils/chembl.py` не находит прямых вызовов
- ✅ Покрытие тестами не уменьшилось
- ✅ Все места использования обновлены

**План отката**:
- Вернуть `_request_status()` с прямым `requests.get()`
- Вернуть сигнатуру `fetch_chembl_release()` с поддержкой строки

**Оценка**: 2-3 часа

**Риски**: Medium - требуется обновление всех мест использования

## Батч 2: Унификация CLI команд для external sources (Medium Priority)

**Цель**: Устранить дублирование 4 идентичных CLI команд.

**Файлы для изменения**:
- Создать `src/bioetl/cli/commands/external_source.py` (~50 LOC)
- Удалить: `crossref.py`, `openalex.py`, `pubmed.py`, `semantic_scholar.py` (4 файла, ~100 LOC суммарно)

**Шаги**:
1. Создать generic factory `build_external_source_command_config(source_name: str) -> PipelineCommandConfig`
2. Использовать реестр для получения pipeline класса
3. Параметризовать config path: `f"pipelines/{source_name}.yaml"`
4. Параметризовать defaults (input/output paths)
5. Обновить регистрацию в `cli/registry.py` или `cli/app.py`
6. Удалить 4 дублирующихся файла
7. Обновить тесты

**Зависимости**: Батч 1 (не критично, но лучше после)

**Критерии "done"**:
- ✅ Все 4 команды работают идентично как раньше
- ✅ Тесты CLI команд проходят
- ✅ Удалены 4 дублирующихся файла
- ✅ Регистрация команд работает через новый factory

**План отката**:
- Восстановить 4 удаленных файла из git history
- Откатить регистрацию команд

**Оценка**: 1-2 часа

**Риски**: Low - структура идентична, изменения тривиальны

## Батч 3: Оптимизация импорта requests (Low Priority)

**Цель**: Заменить избыточный импорт `requests` на точечный.

**Файлы для изменения**:
- `src/bioetl/sources/chembl/document/client/document_client.py` (~5 LOC изменений)

**Шаги**:
1. Заменить `import requests` на `from requests.exceptions import ReadTimeout`
2. Обновить `except requests.exceptions.ReadTimeout:` на `except ReadTimeout:`
3. Проверить, что нет других использований `requests` в файле

**Зависимости**: Нет

**Критерии "done"**:
- ✅ Импорт изменен на точечный
- ✅ Все тесты проходят
- ✅ `grep -r "import requests"` не находит этот файл (или проверка исключений)

**План отката**: Вернуть `import requests`

**Оценка**: 15 минут

**Риски**: Low

## Батч 4: Верификация детерминизма сортировок (Medium Priority)

**Цель**: Убедиться, что все `sort_values()` используют детерминированные ключи.

**Файлы для проверки**:
- `src/bioetl/sources/iuphar/pipeline.py:247`
- `src/bioetl/sources/chembl/document/request/external.py:488`
- `src/bioetl/pipelines/base.py:1043` (проверить наличие дефолта для sort_by)

**Шаги**:
1. Прочитать каждый файл с `sort_values()` без `kind="stable"` или с неполным ключом
2. Проверить, достаточно ли ключей для детерминизма
3. Если недостаточно - добавить дополнительные ключи или `kind="stable"`
4. Создать golden-тесты для проверки детерминизма

**Зависимости**: Нет

**Критерии "done"**:
- ✅ Все `sort_values()` имеют полный ключ или `kind="stable"`
- ✅ Созданы golden-тесты для критичных сортировок
- ✅ Тесты на детерминизм проходят

**План отката**: Откатить изменения в сортировках

**Оценка**: 2-3 часа (включая создание тестов)

**Риски**: Low - только улучшения, не breaking changes

## Батч 5: Анализ и устранение импорт-циклов (Low Priority)

**Цель**: Выявить и устранить циклические зависимости.

**Шаги**:
1. Построить граф зависимостей (вручную или через `pydeps`)
2. Выявить циклы
3. Разорвать циклы через рефакторинг (вынести общие модули, использовать lazy imports)
4. Добавить проверку в CI

**Зависимости**: Нет (но лучше после батчей 1-3)

**Критерии "done"**:
- ✅ Граф зависимостей построен
- ✅ Циклы выявлены и задокументированы
- ✅ Критичные циклы устранены
- ✅ CI проверка добавлена

**План отката**: Зависит от найденных циклов

**Оценка**: 4-6 часов (зависит от сложности циклов)

**Риски**: Medium - может потребоваться рефакторинг архитектуры

## Батч 6: Вынос adapter_definition в конфиги (Optional, Low Priority)

**Цель**: Унифицировать определение адаптеров через YAML конфиги.

**Файлы для изменения**:
- `src/bioetl/sources/crossref/pipeline.py`
- `src/bioetl/sources/openalex/pipeline.py`
- `src/bioetl/sources/pubmed/pipeline.py`
- `src/bioetl/sources/semantic_scholar/pipeline.py`
- `src/bioetl/configs/pipelines/crossref.yaml` (и аналоги)
- `src/bioetl/pipelines/external_source.py` (логика загрузки)

**Шаги**:
1. Добавить секцию `adapter` в YAML конфиги
2. Обновить `ExternalSourcePipeline` для загрузки из конфига
3. Оставить минимальные Python-классы только для type hints
4. Обновить тесты

**Зависимости**: Батч 2 (после унификации CLI)

**Критерии "done"**:
- ✅ Adapter definitions загружаются из конфигов
- ✅ Все тесты проходят
- ✅ Python-классы минимальны (только type hints)

**План отката**: Вернуть hardcoded определения в Python

**Оценка**: 3-4 часа

**Риски**: Medium - изменения в контракте конфигов

## Порядок выполнения

1. **Батч 1** (High Priority) → сразу после утверждения плана
2. **Батч 2** (Medium Priority) → после батча 1
3. **Батч 3** (Low Priority) → можно параллельно с батчем 2
4. **Батч 4** (Medium Priority) → после батча 2
5. **Батч 5** (Low Priority) → после батчей 1-3
6. **Батч 6** (Optional) → после батча 2, опционально

## Критерии успеха проекта

- ✅ Все архитектурные нарушения High severity устранены
- ✅ Дублирование кода уменьшено на ≥50% (4 CLI файла → 1)
- ✅ Все тесты проходят
- ✅ Покрытие тестами не уменьшилось
- ✅ CI проверки добавлены для предотвращения регрессий

## Оценка общих трудозатрат

- **Батч 1**: 2-3 часа
- **Батч 2**: 1-2 часа
- **Батч 3**: 15 минут
- **Батч 4**: 2-3 часа
- **Батч 5**: 4-6 часов
- **Батч 6**: 3-4 часа (optional)

**Итого**: 12-18 часов (без батча 6), 15-22 часа (с батчем 6)

