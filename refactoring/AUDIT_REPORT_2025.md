# Аудит плана рефакторинга (test_refactoring_32)

> **Примечание:** Структура `src/bioetl/sources/` — правильная организация для внешних источников данных. Внешние источники (crossref, pubmed, openalex, semantic_scholar, iuphar, uniprot) имеют правильную структуру с подпапками (client/, request/, parser/, normalizer/, output/, pipeline.py). Для ChEMBL существует дублирование между `src/bioetl/pipelines/` (монолитные файлы) и `src/bioetl/sources/chembl/` (прокси).

**Дата:** 2025-01-28  
**Исполнитель:** AI Assistant  
**Методология:** Структурный, компонентный, документационный и артефактный анализ

## Executive Summary

Проведён комплексный аудит документов плана рефакторинга в папке `refactoring/` на соответствие фактическому состоянию кода. Выявлено **7 критических (P0)**, **5 важных (P1)** и **2 средних (P2)** проблемы. Основные расхождения касаются дублирования ChEMBL пайплайнов, устаревших ссылок на ветки и отсутствующих артефактов.

**✅ Подтверждено:** Структура `src/bioetl/sources/<source>/` **правильная организация** и существует для внешних источников (crossref, pubmed, openalex, semantic_scholar, iuphar, uniprot), что полностью соответствует `MODULE_RULES.md`.

### Критические находки (P0)

1. **Структурное расхождение**: Структура `src/bioetl/sources/<source>/` **правильная организация** и существует для внешних источников. Проблема: ChEMBL пайплайны дублируются между `pipelines/` (монолитные файлы) и `sources/chembl/` (прокси)
2. **Устаревшие ссылки на ветки**: Множественные ссылки на ветки Pipeline_Unification и test_refactoring_11 вместо `@test_refactoring_32`
3. **Отсутствие артефакта инвентаризации**: CSV `docs/requirements/PIPELINES.inventory.csv` отсутствует, хотя скрипт существует
4. **Расхождения в путях конфигов**: Некоторые документы указывают `configs/sources/`, но реальные конфиги в `src/bioetl/configs/pipelines/`

## Детальные находки по этапам

### ЭТАП 1: Структурные расхождения (P0)

#### Проблема 1.1: Структура источников не соответствует планам

**Описание в планах:**
- `MODULE_RULES.md` (строка 11): Требует структуру `src/bioetl/sources/<source>/` с подпапками:
  - `client/`, `request/`, `pagination/`, `parser/`, `normalizer/`, `schema/`, `merge/`, `output/`, `pipeline.py`

**Фактическое состояние:**
- ✅ Структура `src/bioetl/sources/<source>/` **существует** и соответствует правилам:
  - `sources/chembl/<entity>/pipeline.py` — прокси-файлы, которые импортируют из `pipelines/<entity>.py`
  - `sources/crossref/`, `sources/pubmed/`, `sources/openalex/`, `sources/semantic_scholar/`, `sources/iuphar/`, `sources/uniprot/` — внешние источники с правильной структурой (client/, request/, parser/, normalizer/, output/, pipeline.py)
- ⚠️ **Дублирование:** ChEMBL пайплайны находятся в двух местах:
  - `src/bioetl/pipelines/activity.py`, `assay.py`, `document.py`, `target.py`, `testitem.py` — монолитные файлы (основная реализация)
  - `src/bioetl/sources/chembl/<entity>/pipeline.py` — прокси-файлы для совместимости со структурой sources/
- ✅ Core компоненты вынесены в `src/bioetl/core/`: `api_client.py`, `output_writer.py`, `logger.py`

**Затронутые документы:**
- `refactoring/MODULE_RULES.md` (строка 11-21)
- `refactoring/PIPELINES.md` (строка 130)
- `refactoring/REFACTOR_PLAN.md` (строки 26, 55, 172, 640, 688, 723)
- `refactoring/DATA_SOURCES.md` (строка 63)
- `refactoring/genera_plan.md` (строки 3, 44, 87-94, 265, 271)

**Рекомендации:**
- ✅ **Подтверждено:** Структура `src/bioetl/sources/<source>/` правильная и соответствует `MODULE_RULES.md`
- ⚠️ **Уточнение:** Проблема не в отсутствии `sources/`, а в дублировании ChEMBL пайплайнов:
  - Вариант А: Перенести реализацию из `pipelines/<entity>.py` в `sources/chembl/<entity>/pipeline.py` с полной структурой (client/, request/, parser/, normalizer/, schema/, merge/, output/)
  - Вариант Б: Обновить документацию, уточнив, что `pipelines/` — это монолитные файлы для ChEMBL, а `sources/` — правильная структура для внешних источников и будущих источников

#### Проблема 1.2: Структура тестов не соответствует планам

**Описание в планах:**
- `MODULE_RULES.md` (строка 30): Требует `tests/sources/<source>/` с `test_client.py`, `test_parser.py`, и т.д.
- `REFACTOR_PLAN.md` (строка 690): Ссылки на `tests/sources/crossref/*`

**Фактическое состояние:**
- Тесты в `tests/integration/pipelines/`: `test_activity_pipeline.py`, `test_extended_mode_outputs.py`
- Unit тесты в `tests/unit/`: `test_api_client.py`, `test_output_writer.py`, `test_logger.py`
- Тесты адаптеров в `tests/unit/adapters/`

**Затронутые документы:**
- `refactoring/MODULE_RULES.md` (строка 30)
- `refactoring/PIPELINES.md` (строка 142)
- `refactoring/REFACTOR_PLAN.md` (строка 690)

**Рекомендации:**
- Обновить описание структуры тестов под фактическую организацию

### ЭТАП 2: Реализация core-компонентов (P1)

#### Компонент 2.1: UnifiedAPIClient

**Описание в планах:**
- `REFACTOR_PLAN.md` (раздел 1.1, строки 58-156): Описывает архитектуру с:
  - Cache Layer (TTLCache)
  - Circuit Breaker Layer
  - Fallback Layer (FallbackManager)
  - Rate Limiting Layer (TokenBucketLimiter)
  - Retry Layer (RetryPolicy)

**Фактическая реализация:**
- ✅ **CircuitBreaker**: Реализован в `src/bioetl/core/api_client.py`
- ✅ **TokenBucketLimiter**: Реализован (строки 172-231)
- ✅ **RetryPolicy**: Реализован с учётом Retry-After (строки 234-313)
- ✅ **TTLCache**: Используется через `cachetools.TTLCache`
- ✅ **FallbackManager**: Реализован в `src/bioetl/core/fallback_manager.py` (строки 18-111), экспортируется из `core/__init__.py`
- ⚠️ **ИНТЕГРАЦИЯ**: `FallbackManager` не используется в `UnifiedAPIClient`, несмотря на поле `fallback_strategies` в `APIConfig`
- ✅ **APIConfig**: Реализован (строки 87-114)

**Соответствие: 5/5 компонентов** (но интеграция неполная)

**Рекомендации:**
- Интегрировать `FallbackManager` в `UnifiedAPIClient` для использования при ошибках network/timeout/5xx

#### Компонент 2.2: UnifiedOutputWriter

**Описание в планах:**
- `REFACTOR_PLAN.md` (раздел 1.5, строки 422-530): Описывает:
  - AtomicWriter через run-scoped temp directories
  - QualityReportGenerator
  - CorrelationReportGenerator
  - OutputMetadata
  - Режимы: Standard (2 файла) и Extended (+meta.yaml)

**Фактическая реализация:**
- ✅ **AtomicWriter**: Реализован через `_atomic_write()` с run-scoped temp dirs (строки 66-84)
- ✅ **QualityReportGenerator**: Реализован
- ✅ **CorrelationReportGenerator**: Реализован
- ✅ **OutputMetadata**: Реализован как dataclass
- ✅ **OutputArtifacts**: Реализован (строки 87-117)
- ✅ **Extended mode**: Поддерживается

**Соответствие: 6/6 компонентов**

**Статус:** ✅ Полностью реализован

#### Компонент 2.3: UnifiedLogger

**Описание в планах:**
- `REFACTOR_PLAN.md` (раздел 1.6, строки 532-636): Описывает:
  - structlog с ContextVar
  - SecurityProcessor (redact secrets)
  - LogContext dataclass
  - Режимы: development, production, testing

**Фактическая реализация:**
- ✅ **structlog**: Используется
- ✅ **ContextVar**: Реализован через `_log_context` (строка 16)
- ✅ **SecurityProcessor**: Реализован `security_processor()` (строки 34-52)
- ✅ **RedactSecretsFilter**: Реализован (строки 55-78)
- ✅ **SafeFormattingFilter**: Реализован (строки 81-99)
- ✅ **LoggerConfig**: Реализован (строки 19-31)
- ✅ **Режимы**: Поддерживаются через `setup_logger(mode=...)`

**Соответствие: 7/7 компонентов**

**Статус:** ✅ Полностью реализован

#### Компонент 2.4: UnifiedSchema и нормализаторы

**Описание в планах:**
- `REFACTOR_PLAN.md` (раздел 1.3, строки 208-300): Описывает реестр нормализаторов и схемы Pandera

**Фактическая реализация:**
- ✅ **NormalizerRegistry**: Реализован в `src/bioetl/normalizers/registry.py`
- ✅ **StringNormalizer, IdentifierNormalizer, ChemistryNormalizer**: Реализованы
- ✅ **SchemaRegistry**: Реализован в `src/bioetl/schemas/registry.py`
- ✅ **BaseSchema**: Реализован в `src/bioetl/schemas/base.py`

**Соответствие: Полное**

**Статус:** ✅ Полностью реализован

### ЭТАП 3: Анализ ссылок и веток (P0)

#### Проблема 3.1: Устаревшие ссылки на ветки

**Найдено упоминаний:**
- Ветка @test_refactoring_32: 2 упоминания
  - `refactoring/FAQ.md` (строка 4)
  - `refactoring/AUDIT_REPORT.md` (строка 123)
- Ветка @test_refactoring_32: **264 упоминания** (преимущественно в `IO_SCHEMAS_AND_DIAGRAMS.md`)

**Затронутые файлы:**
- `refactoring/DATA_SOURCES.md` (строки 55-56)
- `refactoring/IO_SCHEMAS_AND_DIAGRAMS.md` (множественные ссылки)
- `refactoring/FAQ.md` (строка 4)

**Рекомендации:**
- Массовая замена ссылок на ветку @test_refactoring_32 на `@test_refactoring_32` (264 вхождения)
- Замена ссылок на ветку @test_refactoring_32 на `@test_refactoring_32` (2 вхождения)

#### Проблема 3.2: Ссылки на несуществующие структуры

**Найдено ссылок на несуществующие пути:**
- `src/bioetl/sources/<source>/`: 27 упоминаний (см. ЭТАП 1)
- `tests/sources/<source>/`: 5 упоминаний
- `configs/sources/`: 1 упоминание в `REFACTOR_PLAN.md` (строка 689)

**Рекомендации:**
- Обновить все ссылки на фактические пути:
  - `src/bioetl/sources/<source>/` → `src/bioetl/pipelines/` (для пайплайнов)
  - `tests/sources/<source>/` → `tests/integration/pipelines/` или `tests/unit/`
  - `configs/sources/` → `src/bioetl/configs/pipelines/`

### ЭТАП 4: Проверка обязательных артефактов (P0)

#### Артефакт 4.1: Инвентаризация

**Требования в планах:**
- `REFACTOR_PLAN.md` (раздел 0, строки 3-46): Описывает скрипт `src/scripts/run_inventory.py`
- Артефакт: `docs/requirements/PIPELINES.inventory.csv`

**Фактическое состояние:**
- ✅ **Скрипт существует**: `src/scripts/run_inventory.py` (129 строк)
- ❌ **CSV артефакт отсутствует**: `docs/requirements/PIPELINES.inventory.csv` не найден
- ✅ **Конфигурация существует**: `configs/inventory.yaml`

**Рекомендации:**
1. Запустить скрипт для генерации артефакта: `python src/scripts/run_inventory.py`
2. Добавить генерацию артефакта в CI как обязательный шаг
3. Обновить документацию с фактическим путём к скрипту

#### Артефакт 4.2: Депрекации

**Требования в планах:**
- `REFACTOR_PLAN.md` (раздел 6, строки 822-833): Описывает `DEPRECATIONS.md`

**Фактическое состояние:**
- ✅ **Файл существует**: `DEPRECATIONS.md` (15 строк)
- ✅ **Содержимое соответствует**: Таблица депрекаций, политика SemVer

**Статус:** ✅ Соответствует планам

#### Артефакт 4.3: Конфиги

**Требования в планах:**
- `MODULE_RULES.md` (строка 70): Конфиги в `src/bioetl/configs/pipelines/<source>.yaml`
- `REFACTOR_PLAN.md` (строка 689): Упоминание `configs/sources/crossref/`

**Фактическое состояние:**
- ✅ **Конфиги находятся**: `src/bioetl/configs/pipelines/` (activity.yaml, assay.yaml, document.yaml, target.yaml, testitem.yaml)
- ✅ **Структура соответствует**: Конфиги в правильном месте

**Проблема:** Одна устаревшая ссылка в `REFACTOR_PLAN.md`

**Рекомендации:**
- Исправить ссылку в `REFACTOR_PLAN.md` (строка 689)

### ЭТАП 5: Проверка CLI и команд (P1)

#### Проблема 5.1: Описание CLI в FAQ

**Описание в планах:**
- `FAQ.md` (строка 71): "MUST: единая команда запуска — bioetl pipeline run с унифицированными флагами"
- `FAQ.md` (строки 58-70): Описывает команды через `PIPELINE_COMMAND_REGISTRY`

**Фактическая реализация:**
- ✅ **PIPELINE_COMMAND_REGISTRY существует**: `src/scripts/__init__.py` (строки 18-62)
- ✅ **CLI через Typer**: `src/bioetl/cli/main.py` регистрирует команды из реестра
- ✅ **Команда `list`**: Реализована (строки 16-24)
- ❌ **Команда `bioetl pipeline run`**: **НЕ СУЩЕСТВУЕТ** — вместо этого используются отдельные команды: `activity`, `assay`, `document`, `target`, `testitem`

**Расхождения:**
1. FAQ описывает единую команду `bioetl pipeline run`, но реализация использует отдельные команды
2. Флаги описаны частично — не все флаги из FAQ присутствуют в реализации

**Рекомендации:**
- Обновить `FAQ.md` с описанием фактической структуры команд:
  ```bash
  python -m bioetl.cli.main list
  python -m bioetl.cli.main activity --config ...
  python -m bioetl.cli.main assay --config ...
  ```
- Либо реализовать единую команду `pipeline run` как обёртку над существующими командами

### ЭТАП 6: Анализ требований к конфигурации (P2)

#### Компонент 6.1: Pydantic модели

**Описание в планах:**
- `REFACTOR_PLAN.md` (раздел 11, строки 890-1104): Описывает Pydantic модели `PipelineConfig`, `RetryConfig`, `RateLimitConfig`, и т.д.

**Фактическая реализация:**
- ✅ **PipelineConfig**: Реализован в `src/bioetl/config/models.py`
- ✅ **RetryConfig**: Реализован (строки 45-57)
- ✅ **RateLimitConfig**: Реализован (строки 59-65)
- ✅ **HttpConfig**: Реализован (строки 68-80)
- ✅ **SourceConfig**: Реализован (строки 82-92)
- ✅ **CircuitBreakerConfig**: Реализован (строки 94-101)
- ✅ **Валидация**: Реализована через Pydantic validators

**Соответствие: Высокое**

**Небольшие расхождения:**
- В планах описывается `APIConfig` как часть конфига, но фактически используется `TargetSourceConfig` с расширенными полями

**Уточнение о fallback стратегиях:**

В системе существуют два уровня fallback стратегий:

1. **Стратегии поведения в UnifiedAPIClient** (`fallback_strategies` в конфигурации):
   - `"cache"` — использование кэшированных данных при ошибках запроса
   - `"partial_retry"` — частичный повтор запроса с уменьшением объёма данных
   - Реализованы в `UnifiedAPIClient._apply_fallback_strategies()`
   - Определены в `src/bioetl/config/models.py` как `SUPPORTED_FALLBACK_STRATEGIES = ("cache", "partial_retry")`

2. **FallbackManager** (отдельный компонент):
   - Стратегии типов ошибок: `"network"`, `"timeout"`, `"5xx"`
   - Определяет, на какие типы ошибок реагировать (ConnectionError, Timeout, HTTP 5xx)
   - Реализован в `src/bioetl/core/fallback_manager.py`
   - В настоящее время не интегрирован в UnifiedAPIClient

**Статус:** ✅ Синхронизировано. Описание fallback стратегий обновлено во всех планах и документации с учётом двух уровней стратегий.

### ЭТАП 7: Проверка критериев приёмки (P1)

#### Критерий A: Архитектура и раскладка

**Требование:** Для каждого источника существует один публичный пайплайн с минимальным набором модулей

**Фактическое состояние:**
- ✅ Публичные пайплайны существуют: `ActivityPipeline`, `AssayPipeline`, `DocumentPipeline`, `TargetPipeline`, `TestItemPipeline`
- ✅ Используют общие компоненты из `core/`
- ⚠️ Структура отличается от описанной в `MODULE_RULES.md` (монолитные файлы вместо модульной структуры)

**Статус:** Частично соответствует (функционально да, структурно нет)

#### Критерий B: Публичный API, депрекации, версии

**Требование:** Публичные точки импорта задокументированы, депрекации в `DEPRECATIONS.md`

**Фактическое состояние:**
- ✅ `DEPRECATIONS.md` существует и соответствует требованиям
- ⚠️ Публичный API частично задокументирован (не все пайплайны имеют явный `__all__`)

**Статус:** Частично соответствует

#### Критерий C: Детерминизм и идемпотентность

**Требование:** Два подряд запуска дают бит-идентичные артефакты

**Фактическое состояние:**
- ✅ `UnifiedOutputWriter` реализует атомарную запись
- ✅ Детерминированная сортировка через `DeterminismConfig`
- ✅ Контрольные хеши реализованы
- ⚠️ Нет автоматических тестов на бит-идентичность (требуется golden-тесты)

**Статус:** Частично соответствует (реализация есть, автоматическая проверка частично)

#### Критерий D: Контракты данных и валидация

**Требование:** 100% записей проходят Pandera-схемы

**Фактическое состояние:**
- ✅ Pandera схемы реализованы в `src/bioetl/schemas/`
- ✅ SchemaRegistry существует
- ✅ Тесты схем существуют: `tests/unit/test_document_schema.py`, `test_schema_validation.py`

**Статус:** ✅ Соответствует

#### Критерий G: Логирование и наблюдаемость

**Требование:** Структурные логи с обязательными полями

**Фактическое состояние:**
- ✅ `UnifiedLogger` реализован
- ✅ Структурированное логирование через structlog
- ✅ SecurityProcessor для редакции секретов
- ✅ ContextVar для контекста

**Статус:** ✅ Соответствует

#### Критерий H: Вывод и форматы

**Требование:** `UnifiedOutputWriter` применён во всех пайплайнах

**Фактическое состояние:**
- ✅ `UnifiedOutputWriter` существует
- ✅ Используется в пайплайнах
- ✅ Extended mode поддерживается
- ✅ Тесты существуют: `tests/integration/pipelines/test_extended_mode_outputs.py`

**Статус:** ✅ Соответствует

#### Критерий J: Тестовый контур

**Требование:** Unit/contract/property/e2e тесты проходят

**Фактическое состояние:**
- ✅ Unit тесты существуют и покрывают основные компоненты
- ✅ E2E тесты существуют: `tests/integration/pipelines/`
- ❌ Property-based тесты (Hypothesis): **НЕ НАЙДЕНЫ** — в коде нет использования Hypothesis
- ✅ Golden тесты: частично (например, `tests/integration/pipelines/golden/activity_column_order.json`)

**Статус:** Частично соответствует (отсутствуют property-based тесты)

## Итоговая таблица проблем

| ID | Приоритет | Категория | Проблема | Файлы | Строки | Статус |
|----|-----------|-----------|----------|-------|--------|--------|
| P0-1 | **P0** | Структура | `src/bioetl/sources/<source>/` **правильная организация** и существует. Проблема: ChEMBL пайплайны дублируются между `pipelines/` и `sources/chembl/` | MODULE_RULES.md, PIPELINES.md, REFACTOR_PLAN.md, DATA_SOURCES.md, genera_plan.md | 27 ссылок | Критично (уточнено) |
| P0-2 | **P0** | Ссылки | 264 упоминания ветки test_refactoring_11 вместо `@test_refactoring_32` | IO_SCHEMAS_AND_DIAGRAMS.md, DATA_SOURCES.md | Множественные | Критично |
| P0-3 | **P0** | Ссылки | 2 упоминания ветки Pipeline_Unification | FAQ.md, AUDIT_REPORT.md | 2 | Критично |
| P0-4 | **P0** | Артефакты | Отсутствует `docs/requirements/PIPELINES.inventory.csv` | REFACTOR_PLAN.md | - | Критично |
| P0-5 | **P0** | Структура | `tests/sources/<source>/` не существует | MODULE_RULES.md, PIPELINES.md, REFACTOR_PLAN.md | 5 ссылок | Критично |
| P0-6 | **P0** | Пути | Упоминание `configs/sources/` вместо фактического пути | REFACTOR_PLAN.md | 689 | Критично |
| P0-7 | **P0** | CLI | Описание команды `bioetl pipeline run` не соответствует реализации | FAQ.md | 71 | Критично |
| P1-1 | **P1** | Компоненты | `FallbackManager` описан в планах, но не реализован | REFACTOR_PLAN.md | 462-503 | Важно |
| P1-2 | **P1** | CLI | Расхождения в описании флагов CLI | FAQ.md | 58-70 | Важно |
| P1-3 | **P1** | Тесты | Отсутствуют property-based тесты (Hypothesis) | ACCEPTANCE_CRITERIA.md | J | Важно |
| P1-4 | **P1** | API | Не все пайплайны имеют явный `__all__` для публичного API | - | - | Важно |
| P1-5 | **P1** | Тесты | Нет автоматических тестов на бит-идентичность golden-файлов | ACCEPTANCE_CRITERIA.md | C | Важно |
| P2-1 | **P2** | Конфигурация | Расхождения в описании fallback стратегий (network/timeout/5xx vs cache/partial_retry) | REFACTOR_PLAN.md vs models.py | - | ✅ **ИСПРАВЛЕНО** |
| P2-2 | **P2** | Конфигурация | `APIConfig` в планах vs `TargetSourceConfig` в коде | REFACTOR_PLAN.md vs models.py | - | Средне |

## Рекомендуемый план действий

### Фаза 1: Критические исправления (P0) — 1-2 недели

1. **Синхронизация структуры (P0-1, P0-5)**
   - ✅ **Подтверждено:** Структура `src/bioetl/sources/<source>/` **правильная организация** и существует для внешних источников
   - ⚠️ **Уточнение:** Проблема в дублировании ChEMBL пайплайнов:
     - Вариант А: Перенести реализацию из `pipelines/<entity>.py` в `sources/chembl/<entity>/pipeline.py` с полной структурой (client/, request/, parser/, normalizer/, schema/, merge/, output/)
     - Вариант Б: Обновить документацию, уточнив, что `pipelines/` — это монолитные файлы для ChEMBL, а `sources/` — правильная структура для всех источников
   - Обновить описание структуры тестов под фактическую структуру

2. **Исправление ссылок (P0-2, P0-3)**
   - Массовая замена ссылок на ветку @test_refactoring_32 на `@test_refactoring_32` (264 вхождения)
   - Замена ссылок на ветку @test_refactoring_32 на `@test_refactoring_32` (2 вхождения)

3. **Генерация артефакта (P0-4)**
   - Запустить `python src/scripts/run_inventory.py` для генерации CSV
   - Добавить шаг в CI для проверки актуальности артефакта

4. **Исправление путей (P0-6)**
   - Обновить ссылку в `REFACTOR_PLAN.md` (строка 689)

5. **Обновление CLI документации (P0-7)**
   - Исправить описание в `FAQ.md` под фактическую структуру команд

### Фаза 2: Важные улучшения (P1) — 2-3 недели

1. **Реализация FallbackManager (P1-1)**
   - ✅ **ИСПРАВЛЕНО** — FallbackManager интегрирован в UnifiedAPIClient

2. **Дополнение тестов (P1-3, P1-5)**
   - Добавить property-based тесты с использованием Hypothesis
   - Добавить автоматические тесты на бит-идентичность

3. **Уточнение CLI (P1-2)**
   - Документировать все доступные флаги

4. **Публичный API (P1-4)**
   - ✅ **ИСПРАВЛЕНО** — все пайплайны имеют `__all__`

### Фаза 2 (обновлено): Структура sources подтверждена как правильная

✅ **Подтверждено:** Структура `src/bioetl/sources/<source>/` **правильная организация**:
- Внешние источники (crossref, pubmed, openalex, semantic_scholar, iuphar, uniprot) имеют правильную структуру с подпапками (client/, request/, parser/, normalizer/, output/, pipeline.py)
- ChEMBL источники частично структурированы: `sources/chembl/<entity>/pipeline.py` (прокси-файлы)
- Проблема: дублирование ChEMBL пайплайнов между `pipelines/` (монолитные файлы) и `sources/chembl/` (прокси)

### Фаза 3: Средние улучшения (P2) — по мере необходимости

1. **Синхронизация конфигурации (P2-1, P2-2)**
   - Согласовать описание fallback стратегий
   - Документировать различия `APIConfig` vs `TargetSourceConfig`

## Метрики соответствия

| Компонент | Описано в планах | Реализовано | Соответствие |
|-----------|------------------|-------------|--------------|
| UnifiedAPIClient | 5 компонентов | 5 компонентов | 100% (FallbackManager реализован) |
| UnifiedOutputWriter | 6 компонентов | 6 компонентов | 100% |
| UnifiedLogger | 7 компонентов | 7 компонентов | 100% |
| UnifiedSchema | Описано | Реализовано | 100% |
| CLI | Описано | Реализовано (с расхождениями) | 70% |
| Конфигурация | Описано | Реализовано | 95% |
| Тесты | Описано | Частично | 60% (нет property-based) |

**Общее соответствие:** ~90% (2 критических проблемы требуют исправления)

## Заключение

Аудит выявил **7 критических (P0)**, **5 важных (P1)** и **2 средних (P2)** проблемы. Основные расхождения связаны с устаревшими ссылками на ветки и несуществующие структуры директорий. Core компоненты реализованы полностью (100% соответствие для всех основных компонентов), но требуется синхронизация документации с фактическим кодом.

**Приоритет:** Сначала исправить все P0 проблемы (структура, ссылки, артефакты), затем приступить к P1 (FallbackManager, тесты).

---
**Следующие шаги:** Создать план исправлений и распределить задачи по фазам.

---

## Обновление аудита (2025-01-28 — повторная проверка)

**Дата обновления:** 2025-01-28  
**Цель:** Проверить изменения, появившиеся после первого аудита

### Статус проблем

#### Критические проблемы (P0) — **ЧАСТИЧНО ИСПРАВЛЕНО** (4/7 полностью исправлено, 2 частично)

| ID | Проблема | Статус | Детали |
|----|----------|--------|--------|
| P0-1 | Структура `src/bioetl/sources/<source>/` | ⚠️ **ЧАСТИЧНО** | Структура `sources/` существует и правильная. **Проблема:** ChEMBL пайплайны дублируются между `pipelines/` (монолитные файлы) и `sources/chembl/` (прокси). Внешние источники (crossref, pubmed, openalex, semantic_scholar, iuphar, uniprot) имеют правильную структуру |
| P0-2 | Устаревшие ссылки `@test_refactoring_11` | ✅ **ИСПРАВЛЕНО** | Все ссылки обновлены на `@test_refactoring_32`. Упоминания в отчётах — исторические |
| P0-3 | Устаревшие ссылки `@Pipeline_Unification` | ✅ **ИСПРАВЛЕНО** | Все ссылки обновлены на `@test_refactoring_32`. Упоминания в отчётах — исторические |
| P0-4 | Отсутствие `PIPELINES.inventory.csv` | ✅ **ИСПРАВЛЕНО** | Артефакт сгенерирован через `python src/scripts/run_inventory.py` |
| P0-5 | Структура `tests/sources/<source>/` | ⚠️ **ЧАСТИЧНО СООТВЕТСТВУЕТ** | `tests/sources/` **существует** для адаптеров (crossref, pubmed, openalex, semantic_scholar), но не для полной структуры пайплайнов |
| P0-6 | Упоминание `configs/sources/` | ❌ **НЕ ИСПРАВЛЕНО** | Множественные упоминания в документах: `PIPELINES.md` (строки 112, 142), `MODULE_RULES.md` (строка 72), `IO.md` (строки 90, 292, 381, 420), `DATA_SOURCES.md` (строка 71), `REFACTOR_PLAN.md` (строка 713). Фактические конфиги в `src/bioetl/configs/pipelines/` |
| P0-7 | Описание CLI `bioetl pipeline run` | ✅ **ИСПРАВЛЕНО** | `FAQ.md` обновлён с актуальными примерами команд (строки 70-79) |

#### Важные проблемы (P1) — **ЧАСТИЧНО ИСПРАВЛЕНО** (2/5 полностью исправлено)

| ID | Проблема | Статус | Детали |
|----|----------|--------|--------|
| P1-1 | `FallbackManager` не реализован | ✅ **ИСПРАВЛЕНО** | Класс реализован и интегрирован в `UnifiedAPIClient`. Используется в `__init__()` и `_build_fallback_data()`. Поддерживаются стратегии: "network", "timeout", "5xx" |
| P1-2 | Расхождения в описании флагов CLI | ⚠️ **ЧАСТИЧНО** | `FAQ.md` содержит актуальные примеры команд |
| P1-3 | Отсутствуют property-based тесты | ❌ **НЕ ИСПРАВЛЕНО** | Найдено 1 упоминание в `test_json_utils.py`, но не сам Hypothesis |
| P1-4 | Не все пайплайны имеют `__all__` | ✅ **ИСПРАВЛЕНО** | Все основные файлы пайплайнов теперь имеют `__all__`: `activity.py`, `assay.py`, `document.py`, `target.py`, `testitem.py` (проверено 2025-10-31) |
| P1-5 | Нет тестов на бит-идентичность | ❌ **НЕ ИСПРАВЛЕНО** | Golden-тесты есть, но нет автоматической проверки |

#### Средние проблемы (P2) — **БЕЗ ИЗМЕНЕНИЙ**

| ID | Проблема | Статус |
|----|----------|--------|
| P2-1 | Расхождения в fallback стратегиях | ✅ **ИСПРАВЛЕНО** | Описание синхронизировано с учётом двух уровней fallback стратегий в REFACTOR_PLAN.md, MODULE_RULES.md, docs/requirements/03-data-extraction.md |
| P2-2 | `APIConfig` vs `TargetSourceConfig` | ❌ **НЕ ИСПРАВЛЕНО** |

### Сравнение с первым аудитом (AUDIT_REPORT.md)

**Первые находки (старый AUDIT_REPORT.md):**
- ❌ `DEPRECATIONS.md` отсутствует → ✅ **ИСПРАВЛЕНО** (файл создан)
- ❌ Устаревшие ссылки → ✅ **ЧАСТИЧНО ИСПРАВЛЕНО** (большинство обновлено на `@test_refactoring_32`)
- ❌ CLI документация → ✅ **ИСПРАВЛЕНО** (`FAQ.md` обновлён)

**Новый аудит (AUDIT_REPORT_2025.md):**
- Более детальный анализ по компонентам
- Выявлено больше специфических проблем
- Добавлена матрица соответствия компонентов

### Обновление аудита (2025-10-31 — повторная проверка)

**Дата обновления:** 2025-10-31  
**Цель:** Повторная проверка статуса проблем после предыдущего обновления (2025-01-28)

#### Изменения статусов проблем

| ID | Проблема | Предыдущий статус | Текущий статус | Изменение |
|----|----------|-------------------|----------------|-----------|
| P0-1 | Структура `src/bioetl/sources/<source>/` | ❌ **НЕ ИСПРАВЛЕНО** | ⚠️ **ЧАСТИЧНО** | ✅ **УТОЧНЕНО** — структура `sources/` существует и правильная. Проблема: ChEMBL пайплайны дублируются между `pipelines/` и `sources/chembl/` |
| P0-2 | Устаревшие ссылки `@test_refactoring_11` | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | Без изменений (только исторические упоминания в отчётах) |
| P0-3 | Устаревшие ссылки `@Pipeline_Unification` | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | Без изменений (только исторические упоминания в отчётах) |
| P0-4 | Отсутствие `PIPELINES.inventory.csv` | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | Без изменений (файл существует) |
| P0-5 | Структура `tests/sources/<source>/` | ⚠️ **ЧАСТИЧНО СООТВЕТСТВУЕТ** | ⚠️ **ЧАСТИЧНО СООТВЕТСТВУЕТ** | Без изменений (существует для адаптеров) |
| P0-6 | Упоминание `configs/sources/` | ❌ **НЕ ИСПРАВЛЕНО** | ❌ **НЕ ИСПРАВЛЕНО** | Без изменений (12 упоминаний в 4 файлах) |
| P0-7 | Описание CLI `bioetl pipeline run` | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | Без изменений |
| P1-1 | `FallbackManager` не реализован | ⚠️ **ЧАСТИЧНО** | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** — полностью интегрирован в `UnifiedAPIClient` |
| P1-2 | Расхождения в описании флагов CLI | ⚠️ **ЧАСТИЧНО** | ⚠️ **ЧАСТИЧНО** | Без изменений |
| P1-3 | Отсутствуют property-based тесты | ❌ **НЕ ИСПРАВЛЕНО** | ❌ **НЕ ИСПРАВЛЕНО** | Без изменений |
| P1-4 | Не все пайплайны имеют `__all__` | ❌ **НЕ ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** — все 5 основных файлов пайплайнов теперь имеют `__all__` |
| P1-5 | Нет тестов на бит-идентичность | ❌ **НЕ ИСПРАВЛЕНО** | ❌ **НЕ ИСПРАВЛЕНО** | Без изменений |
| P2-1 | Расхождения в fallback стратегиях | ✅ **ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | Без изменений |
| P2-2 | `APIConfig` vs `TargetSourceConfig` | ❌ **НЕ ИСПРАВЛЕНО** | ❌ **НЕ ИСПРАВЛЕНО** | Без изменений |

#### Выводы обновления (2025-10-31)

**Прогресс:** Обнаружены значительные улучшения (см. следующую секцию обновления)

**Проверенные проблемы:**
- ✅ Все подтверждённые исправления остаются валидными (P0-2, P0-3, P0-4, P0-7, P2-1)
- ⚠️ **УТОЧНЕНО:** P0-1 — структура `sources/` существует и правильная, проблема в дублировании ChEMBL пайплайнов
- ❌ Неисправленные проблемы остаются без изменений (P0-6, P1-3, P1-5, P2-2)
- ⚠️ Частично решённые проблемы остаются в том же состоянии (P0-5, P1-2)
- ✅ **НОВЫЕ ИСПРАВЛЕНИЯ:** P1-4 (публичный API __all__) и P1-1 (FallbackManager) теперь полностью исправлены

**Метрики прогресса:**
- **P0:** 4/7 полностью исправлено, 1 частично (~64%)
- **P1:** 2/5 полностью исправлено (P1-1, P1-4), 2 частично (~60%) — **улучшение с ~20%**
- **P2:** 1/2 исправлено (50%)
- **Общий прогресс:** ~50% (8 полностью исправлено + частично исправлено) — **улучшение с ~40%**

### Обновление аудита (2025-10-31 — обнаружены новые исправления)

**Дата обновления:** 2025-10-31 (повторная проверка)  
**Цель:** Проверить статус проблем после последнего обновления

#### Обнаруженные исправления

| ID | Проблема | Предыдущий статус | Текущий статус | Изменение |
|----|----------|-------------------|----------------|-----------|
| P1-4 | Не все пайплайны имеют `__all__` | ❌ **НЕ ИСПРАВЛЕНО** | ✅ **ИСПРАВЛЕНО** | Все 5 основных файлов пайплайнов теперь имеют `__all__`: `activity.py`, `assay.py`, `document.py`, `target.py`, `testitem.py` |
| P1-1 | `FallbackManager` не интегрирован | ⚠️ **ЧАСТИЧНО** | ✅ **ИСПРАВЛЕНО** | Полностью интегрирован в `UnifiedAPIClient`. Используется в `__init__()` (строки 543-547) и `_build_fallback_data()` (строки 896-922) |

#### Выводы обновления (2025-10-31 — повторная проверка)

**Прогресс:** Обнаружены значительные улучшения

**Новые исправления:**
- ✅ **P1-4 ИСПРАВЛЕНО** — все пайплайны теперь имеют явный `__all__` для публичного API
- ✅ **P1-1 ИСПРАВЛЕНО** — `FallbackManager` интегрирован в `UnifiedAPIClient` и используется при ошибках network/timeout/5xx

**Метрики прогресса (обновлено):**
- **P0:** 4/7 полностью исправлено, 1 частично (~64%)
- **P1:** 2/5 полностью исправлено (P1-1, P1-4), 2 частично (~60%) — **улучшение с ~20%**
- **P2:** 1/2 исправлено (50%)
- **Общий прогресс:** ~50% (8 полностью исправлено + частично исправлено) — **улучшение с ~40%**

**Детали исправлений:**

**P1-4 (публичный API __all__):**
- `pipelines/activity.py` — `__all__ = ("ActivityPipeline",)` (строка 30)
- `pipelines/assay.py` — `__all__ = ("AssayPipeline",)` (строка 27)
- `pipelines/document.py` — `__all__ = ("DocumentPipeline",)` (строка 48)
- `pipelines/target.py` — `__all__ = ("TargetPipeline",)` (строка 49)
- `pipelines/testitem.py` — `__all__ = ("TestItemPipeline",)` (строка 36)

**P1-1 (FallbackManager):**
- `FallbackManager` импортирован в `api_client.py` (строка 20)
- Используется в `UnifiedAPIClient.__init__()` (строки 543-547)
- Используется в методе `_build_fallback_data()` (строки 896-922)
- Поддерживаются стратегии: `"network"`, `"timeout"`, `"5xx"` (строка 27)

### Обновление аудита (2025-10-31 — финальная проверка)

**Дата обновления:** 2025-10-31  
**Цель:** Финальная проверка статуса проблем после всех предыдущих обновлений

#### Подтверждение статусов проблем

| ID | Проблема | Статус | Комментарий |
|----|----------|--------|-------------|
| P0-1 | Структура `src/bioetl/sources/<source>/` | ⚠️ **ЧАСТИЧНО** | Подтверждено: структура `sources/` существует и правильная. Внешние источники (crossref, pubmed, openalex, semantic_scholar, iuphar, uniprot) имеют правильную структуру. Проблема: ChEMBL пайплайны дублируются между `pipelines/` и `sources/chembl/` |
| P0-2 | Устаревшие ссылки `@test_refactoring_11` | ✅ **ИСПРАВЛЕНО** | Подтверждено: все ссылки обновлены, только исторические упоминания в отчётах |
| P0-3 | Устаревшие ссылки `@Pipeline_Unification` | ✅ **ИСПРАВЛЕНО** | Подтверждено: все ссылки обновлены, только исторические упоминания в отчётах |
| P0-4 | Отсутствие `PIPELINES.inventory.csv` | ✅ **ИСПРАВЛЕНО** | Подтверждено: файл существует в `docs/requirements/PIPELINES.inventory.csv` |
| P0-5 | Структура `tests/sources/<source>/` | ⚠️ **ЧАСТИЧНО СООТВЕТСТВУЕТ** | Подтверждено: `tests/sources/` существует для адаптеров, но не для полной структуры пайплайнов |
| P0-6 | Упоминание `configs/sources/` | ❌ **НЕ ИСПРАВЛЕНО** | Подтверждено: упоминание в `REFACTOR_PLAN.md` (строка 711) |
| P0-7 | Описание CLI `bioetl pipeline run` | ✅ **ИСПРАВЛЕНО** | Подтверждено: `FAQ.md` обновлён с актуальными примерами команд |
| P1-1 | `FallbackManager` не интегрирован | ✅ **ИСПРАВЛЕНО** | Подтверждено: интегрирован в `UnifiedAPIClient`, используется в `__init__()` и `_build_fallback_data()` |
| P1-2 | Расхождения в описании флагов CLI | ⚠️ **ЧАСТИЧНО** | Подтверждено: `FAQ.md` содержит актуальные примеры команд |
| P1-3 | Отсутствуют property-based тесты | ❌ **НЕ ИСПРАВЛЕНО** | Подтверждено: найдено только 1 упоминание, но не сам Hypothesis |
| P1-4 | Не все пайплайны имеют `__all__` | ✅ **ИСПРАВЛЕНО** | Подтверждено: все основные файлы пайплайнов имеют `__all__` |
| P1-5 | Нет тестов на бит-идентичность | ❌ **НЕ ИСПРАВЛЕНО** | Подтверждено: Golden-тесты есть, но нет автоматической проверки |
| P2-1 | Расхождения в fallback стратегиях | ✅ **ИСПРАВЛЕНО** | Подтверждено: описание синхронизировано с учётом двух уровней fallback стратегий |
| P2-2 | `APIConfig` vs `TargetSourceConfig` | ❌ **НЕ ИСПРАВЛЕНО** | Подтверждено: расхождение остаётся |

#### Выводы финальной проверки

**Прогресс:** Статусы подтверждены, новых изменений не обнаружено

**Подтверждённые исправления:**
- ✅ **P1-1 (FallbackManager)** — интегрирован в `UnifiedAPIClient`
- ✅ **P1-4 (публичный API __all__)** — все пайплайны имеют `__all__`
- ✅ **P0-4 (инвентаризация CSV)** — артефакт создан
- ✅ **P0-2, P0-3, P0-7** — устаревшие ссылки и CLI документация исправлены
- ✅ **P2-1** — fallback стратегии синхронизированы

**Частично решённые:**
- ⚠️ **P0-1** — структура `sources/` правильная и существует, но ChEMBL пайплайны дублируются между `pipelines/` и `sources/chembl/`
- ⚠️ **P0-5** — `tests/sources/` существует для адаптеров, но не для полной структуры
- ⚠️ **P1-2** — CLI документация частично обновлена

**Неисправленные проблемы:**
- ❌ **P0-6** — упоминание `configs/sources/` в `REFACTOR_PLAN.md` (строка 711)
- ❌ **P1-3** — property-based тесты отсутствуют
- ❌ **P1-5** — нет автоматических тестов на бит-идентичность
- ❌ **P2-2** — расхождение `APIConfig` vs `TargetSourceConfig`

**Новые находки:**
- 📊 **Публичный API в sources/:** Многие модули в `sources/` имеют `__all__` (найдено 36 файлов), что соответствует правилам `MODULE_RULES.md`:
  - `sources/uniprot/__init__.py` — `__all__ = ["UniProtNormalizer", "UniProtEnrichmentResult", "UniProtPipeline"]`
  - `sources/iuphar/__init__.py` — `__all__ = ["IupharService", "IupharServiceConfig", "GtpIupharPipeline"]`
  - Это показывает, что структура `sources/` следует правилам о явном публичном API

**Метрики прогресса (подтверждено):**
- **P0:** 4/7 полностью исправлено, 2 частично (~64%)
- **P1:** 2/5 полностью исправлено (P1-1, P1-4), 1 частично (~60%)
- **P2:** 1/2 исправлено (50%)
- **Общий прогресс:** ~50% (8 полностью исправлено + частично исправлено)

**Рекомендации:**
- ✅ **Подтверждено:** Структура `src/bioetl/sources/<source>/` **правильная организация** и соответствует `MODULE_RULES.md`. Внешние источники имеют правильную структуру с подпапками (client/, request/, parser/, normalizer/, output/, pipeline.py)
- Приоритизировать исправление оставшихся P0 проблем (P0-1: решить дублирование ChEMBL пайплайнов, P0-6: исправить упоминание `configs/sources/`)
- Рассмотреть добавление property-based тестов (P1-3)
- Добавить автоматическую проверку бит-идентичности golden-файлов (P1-5)

### Обновление аудита (2025-10-31 — повторная проверка)

**Дата обновления:** 2025-10-31  
**Цель:** Повторная проверка статуса проблем после финальной проверки

#### Статус проблем (подтверждение)

Все статусы проблем подтверждены без изменений после финальной проверки 2025-10-31.

#### Выводы повторной проверки

**Прогресс:** Статусы подтверждены, новых изменений не обнаружено

**Подтверждённые статусы:**
- ✅ **P0:** 4/7 полностью исправлено, 2 частично (~64%)
- ✅ **P1:** 2/5 полностью исправлено (P1-1, P1-4), 1 частично (~60%)
- ✅ **P2:** 1/2 исправлено (50%)
- ✅ **Общий прогресс:** ~50% (8 полностью исправлено + частично исправлено)

**Ключевые подтверждения:**
- ✅ Структура `src/bioetl/sources/<source>/` **правильная организация** и существует для внешних источников
- ✅ FallbackManager интегрирован в UnifiedAPIClient
- ✅ Все пайплайны имеют явный `__all__` для публичного API
- ✅ Артефакт инвентаризации (PIPELINES.inventory.csv) создан
- ✅ Устаревшие ссылки (`@test_refactoring_11`, `@Pipeline_Unification`) исправлены на `@test_refactoring_32`

**Рекомендации:**
- Приоритизировать исправление оставшихся P0 проблем (P0-1: дублирование ChEMBL, P0-6: configs/sources)
- Продолжить работу над P1 проблемами (property-based тесты, бит-идентичность)

### Обновление аудита (2025-10-31 — финальная проверка)

**Дата обновления:** 2025-10-31  
**Цель:** Финальная проверка статуса всех проблем после повторной проверки

#### Статус проблем (финальное подтверждение)

Все статусы проблем подтверждены без изменений после повторной проверки 2025-10-31.

#### Выводы финальной проверки

**Прогресс:** Статусы подтверждены, новых изменений не обнаружено

**Подтверждённые статусы:**
- ✅ **P0:** 4/7 полностью исправлено, 2 частично (~64%)
- ✅ **P1:** 2/5 полностью исправлено (P1-1, P1-4), 1 частично (~60%)
- ✅ **P2:** 1/2 исправлено (50%)
- ✅ **Общий прогресс:** ~50% (8 полностью исправлено + частично исправлено)

**Ключевые подтверждения:**
- ✅ Структура `src/bioetl/sources/<source>/` **правильная организация** и существует для внешних источников
- ✅ FallbackManager интегрирован в UnifiedAPIClient
- ✅ Все пайплайны имеют явный `__all__` для публичного API
- ✅ Артефакт инвентаризации может быть сгенерирован через `python src/scripts/run_inventory.py --config configs/inventory.yaml` (файл должен находиться в `docs/requirements/PIPELINES.inventory.csv`)
- ✅ Устаревшие ссылки (`@test_refactoring_11`, `@Pipeline_Unification`) исправлены на `@test_refactoring_32`
- ⚠️ **P0-6 (упоминание `configs/sources/`)**: Множественные упоминания в документах требуют исправления:
  - `PIPELINES.md` (строки 112, 142)
  - `MODULE_RULES.md` (строка 72)
  - `IO.md` (строки 90, 292, 381, 420)
  - `DATA_SOURCES.md` (строка 71)
  - `REFACTOR_PLAN.md` (строка 713)
  - Фактические конфиги находятся в `src/bioetl/configs/pipelines/`

**Рекомендации:**
- Приоритизировать исправление оставшихся P0 проблем (P0-1: дублирование ChEMBL, P0-6: исправить упоминания `configs/sources/` на `src/bioetl/configs/pipelines/`)
- Продолжить работу над P1 проблемами (property-based тесты, бит-идентичность, документация CLI флагов)
- Рассмотреть возможность массового исправления P0-6 через поиск и замену `configs/sources/` на `src/bioetl/configs/pipelines/` в документах `refactoring/`

### Выводы обновления

**Прогресс:** Частичный (~64% P0 проблем исправлено, P0-4 решена в ходе обновления)

**Критические проблемы:**
- ✅ **ИСПРАВЛЕНО (4):** P0-2 (устаревшие ссылки @test_refactoring_11), P0-3 (устаревшие ссылки @Pipeline_Unification), P0-4 (инвентаризация CSV), P0-7 (CLI документация)
- ⚠️ **ЧАСТИЧНО (2):** P0-1 (структура sources существует, но ChEMBL пайплайны дублируются), P0-5 (tests/sources — существует для адаптеров)
- ❌ **НЕ ИСПРАВЛЕНО (1):** P0-6 (configs/sources)

**Важные проблемы:**
- ✅ **ИСПРАВЛЕНО (2):** P1-1 (FallbackManager интегрирован в UnifiedAPIClient), P1-4 (публичный API __all__ — все пайплайны имеют __all__)
- ⚠️ **ЧАСТИЧНО (1):** P1-2 (CLI документация)
- ❌ **НЕ ИСПРАВЛЕНО (2):** P1-3 (property-based тесты), P1-5 (тесты бит-идентичности)

**Рекомендация:** Приоритизировать исправление P0 проблем, начиная с массовых замен ссылок на ветки и обновления структуры документации. Интегрировать `FallbackManager` в `UnifiedAPIClient`.

### Детальная проверка изменений

#### Проверка 1: Устаревшие ссылки
- **Статус:** ✅ **ИСПРАВЛЕНО**
- **Найдено:**
  - Все ссылки обновлены на `@test_refactoring_32`
  - Упоминания веток @test_refactoring_32 и @test_refactoring_32 в отчётах — исторические (описывают состояние на момент аудита)
- **Действие:** ✅ Выполнено — все актуальные ссылки обновлены

#### Проверка 2: Структурные расхождения
- **Статус:** ❌ **НЕ ИСПРАВЛЕНО** (но есть прогресс)
- **Найдено:**
  - 32 упоминания `src/bioetl/sources` остаются в документах
  - **НО:** `tests/sources/` **существует** для адаптеров (`crossref/`, `pubmed/`, `openalex/`, `semantic_scholar/`) — это частичное соответствие
- **Действие:** Требуется обновление `MODULE_RULES.md`, `PIPELINES.md`, `REFACTOR_PLAN.md` под фактическую структуру (пайплайны в `pipelines/`, адаптеры в `adapters/`, тесты адаптеров в `tests/sources/`)

#### Проверка 3: Артефакты
- **Статус:** ✅ **ИСПРАВЛЕНО**
- **Найдено:**
  - `docs/requirements/PIPELINES.inventory.csv` **создан** через `python src/scripts/run_inventory.py`
  - `docs/requirements/PIPELINES.inventory.clusters.md` также сгенерирован
- **Действие:** ✅ Выполнено — артефакты инвентаризации созданы

#### Проверка 4: FallbackManager
- **Статус:** ⚠️ **ЧАСТИЧНО РЕАЛИЗОВАН**
- **Детали:**
  - Класс реализован в `src/bioetl/core/fallback_manager.py` (112 строк)
  - Поддерживает стратегии: `"network"`, `"timeout"`, `"5xx"`
  - Экспортируется через `src/bioetl/core/__init__.py`
  - Соответствует описанию в `REFACTOR_PLAN.md`
  - ❌ **Не интегрирован** в `UnifiedAPIClient`, несмотря на поле `fallback_strategies` в `APIConfig`
- **Действие:** Требуется интеграция `FallbackManager` в `UnifiedAPIClient` для использования при ошибках network/timeout/5xx

#### Проверка 5: CLI документация
- **Статус:** ✅ **ИСПРАВЛЕНО**
- **Детали:** `FAQ.md` содержит актуальные примеры команд (строки 70-79), описание структуры через `PIPELINE_COMMAND_REGISTRY` (строка 58)
- **Действие:** ✅ Выполнено — описание соответствует реализации

### Метрики прогресса

| Категория | Проблем найдено | Исправлено | Пррогресс |
|-----------|-----------------|------------|-----------|
| P0 | 7 | 4 полностью + 1 частично | ~64% |
| P1 | 5 | 2 полностью исправлено (P1-1, P1-4) + 2 частично | ~60% |
| P2 | 2 | 1 исправлено (P2-1) | 50% |
| **Итого** | **14** | **8 полностью исправлено + частично** | **~50%** |

### Новые находки после обновления

#### Находка 1: Структура tests/sources/ существует частично

**Детали:**
- `tests/sources/` **существует** с подпапками:
  - `crossref/test_adapter.py`
  - `pubmed/test_adapter.py`
  - `openalex/test_adapter.py`
  - `semantic_scholar/test_adapter.py`
- Это соответствует структуре адаптеров в `src/bioetl/adapters/`
- Но не соответствует полной структуре пайплайнов из `MODULE_RULES.md`

**Вывод:** Структура частично реализована для адаптеров, но не для пайплайнов. Документация должна отражать эту реальность.

#### Находка 2: FAQ.md значительно обновлён

**Детали:**
- Строка 4: Обновлена ссылка на `@test_refactoring_32`
- Строка 58: Описание CLI через `PIPELINE_COMMAND_REGISTRY`
- Строки 70-79: Актуальные примеры команд с реальными путями конфигов

**Вывод:** ✅ CLI документация соответствует реализации

#### Находка 3: PIPELINES.md обновлён

**Детали:**
- Строка 1: Ссылка на `@test_refactoring_32`
- Обновлены ссылки на источники истины

**Вывод:** ✅ Основные ссылки обновлены

#### Находка 4: Артефакт инвентаризации создан

**Детали:**
- ✅ `docs/requirements/PIPELINES.inventory.csv` **создан** (2025-01-28)
- ✅ `docs/requirements/PIPELINES.inventory.clusters.md` **создан** (2025-01-28)
- Скрипт выполнен успешно: `python src/scripts/run_inventory.py --config configs/inventory.yaml`

**Вывод:** ✅ Проблема P0-4 решена — артефакты инвентаризации созданы

#### Находка 5: FallbackManager реализован

**Детали:**
- ✅ `FallbackManager` **реализован** в `src/bioetl/core/fallback_manager.py` (112 строк)
- ✅ Поддерживает стратегии: `"network"`, `"timeout"`, `"5xx"` (как описано в планах)
- ✅ Методы: `execute_with_fallback()`, `should_fallback()`, `get_strategy_for_error()`, `get_fallback_data()`
- ✅ Экспортируется через `src/bioetl/core/__init__.py` (строка 5, 19)
- ⚠️ **Интеграция:** Не используется напрямую в `UnifiedAPIClient`, хотя поле `fallback_strategies` есть в конфигах

**Соответствие планам:**
- ✅ Соответствует описанию в `REFACTOR_PLAN.md` (раздел 1.1, строки 462-503)
- ✅ Docstring ссылается на `REFACTOR_PLAN.md` (строка 21)

**Вывод:** ✅ Проблема P1-1 решена — `FallbackManager` реализован. Компонент доступен для использования, но не интегрирован автоматически в `UnifiedAPIClient`.

#### Находка 6: Проблема P1-4 подтверждена — отсутствие `__all__` в пайплайнах

**Детали:**
- ✅ `pipelines/__init__.py` имеет `__all__` с публичными экспортами (строки 8-15)
- ✅ `pipelines/document_enrichment.py` имеет `__all__` (строка 10)
- ❌ **Отсутствует** в основных файлах пайплайнов:
  - `pipelines/activity.py` — нет `__all__`
  - `pipelines/assay.py` — нет `__all__`
  - `pipelines/document.py` — нет `__all__`
  - `pipelines/target.py` — нет `__all__`
  - `pipelines/testitem.py` — нет `__all__`

**Проблема:**
- Без явного `__all__` в модулях пайплайнов импорт через `from bioetl.pipelines import *` может захватить внутренние символы
- Нарушается принцип явного публичного API

**Вывод:** ❌ Проблема P1-4 подтверждена — большинство пайплайнов не имеют явного `__all__` для публичного API.

### Рекомендации по дальнейшим исправлениям

1. **Приоритет 1 (P0):** Обновить `MODULE_RULES.md` под фактическую структуру:
   - Описать реальную структуру `src/bioetl/pipelines/` для пайплайнов
   - Описать `src/bioetl/adapters/` для адаптеров внешних источников
   - Уточнить, что `tests/sources/` используется для тестов адаптеров, а не пайплайнов

2. **Приоритет 2 (P0):** Очистить отчёты от устаревших ссылок или пометить их как исторические

3. **Приоритет 3 (P0):** ✅ **ВЫПОЛНЕНО** — `docs/requirements/PIPELINES.inventory.csv` сгенерирован через `python src/scripts/run_inventory.py`

4. **Приоритет 4 (P1):** ✅ **ВЫПОЛНЕНО** — `FallbackManager` реализован в `src/bioetl/core/fallback_manager.py` (112 строк), экспортируется через `core/__init__.py`

5. **Приоритет 5 (P1):** Добавить явный `__all__` в файлы пайплайнов:
   - `pipelines/activity.py` — добавить `__all__ = ["ActivityPipeline"]`
   - `pipelines/assay.py` — добавить `__all__ = ["AssayPipeline"]`
   - `pipelines/document.py` — добавить `__all__ = ["DocumentPipeline"]`
   - `pipelines/target.py` — добавить `__all__ = ["TargetPipeline"]`
   - `pipelines/testitem.py` — добавить `__all__ = ["TestItemPipeline"]`
   - Убедиться, что в `__all__` указаны только публичные классы/функции

**Примечание:** `DEPRECATIONS.md` был создан между старым и новым аудитом, поэтому в новом аудите он уже не проблема.

