# Assay ChEMBL Pipeline Configuration
#
# This configuration defines the pipeline for extracting assay records
# from the ChEMBL API and normalizing them to the project schema.

# Inherit from base, determinism, and shared profiles
extends:
  - ../../profiles/base.yaml
  - ../../profiles/determinism.yaml
  - ../../profiles/chembl.yaml
  - ../../profiles/validation.yaml
  - ../../profiles/postprocess.yaml

# Pipeline metadata
pipeline:
  name: assay_chembl
  version: "1.0.0"
  owner: "Data Acquisition Team"
  description: "Extract assay records from ChEMBL API"

# ChEMBL source configuration (common settings inherited from chembl.yaml profile)
sources:
  chembl:
    batch_size: 25  # Must be <= 25 for ChEMBL API URL length limit
    parameters:
      select_fields:
        - assay_chembl_id
        - description
        - assay_type
        - assay_type_description
        - assay_test_type
        - assay_category
        - assay_organism
        - assay_tax_id
        - assay_strain
        - assay_tissue
        - assay_cell_type
        - assay_subcellular_fraction
        - target_chembl_id
        - document_chembl_id
        - src_id
        - src_assay_id
        - cell_chembl_id
        - tissue_chembl_id
        - assay_group
        - confidence_score
        - confidence_description
        - variant_sequence
        - curation_level
        - assay_classifications
        - assay_parameters

# CLI configuration (optional overrides)
cli:
  # Optional path to input file (CSV/Parquet) containing assay_chembl_id column
  # for batch extraction. Can be overridden via --input-file CLI option.
  input_file: "data/input/assay.csv"

# Determinism configuration for assay pipeline
determinism:
  sort:
    by:
      - assay_chembl_id
      - row_subtype
      - row_index
    ascending:
      - true
      - true
      - true
    na_position: "last"
  column_order:
    - assay_chembl_id
    - row_subtype
    - row_index
    - description
    - assay_type
    - assay_type_description
    - assay_test_type
    - assay_category
    - assay_organism
    - assay_tax_id
    - assay_strain
    - assay_tissue
    - assay_cell_type
    - assay_subcellular_fraction
    - target_chembl_id
    - document_chembl_id
    - src_id
    - src_assay_id
    - cell_chembl_id
    - tissue_chembl_id
    - assay_group
    - confidence_score
    - confidence_description
    - variant_sequence
    - assay_classifications
    - assay_parameters
    - assay_class_id
    - curation_level

  hashing:
    business_key_fields:
      - assay_chembl_id
      - row_subtype
      - row_index

# Transform configuration
transform:
  arrays_to_header_rows:
    - assay_classifications
    - assay_parameters

# Enrichment configuration
# assay_class_id is populated only through enrichment from ASSAY_CLASS_MAP.
# If enrichment is not configured, assay_class_id will remain NULL.
chembl:
  assay:
    enrich:
      classifications:
        class_map_fields:
          - assay_chembl_id
          - assay_class_id
        classification_fields:
          - assay_class_id
          - l1
          - l2
          - l3
          - pref_name
        page_limit: 1000
      parameters:
        fields:
          - assay_chembl_id
          - type
          - relation
          - value
          - units
        page_limit: 1000
        active_only: true

# Validation schema (common settings inherited from validation.yaml profile)
validation:
  schema_out: "bioetl.schemas.assay.assay_chembl.AssaySchema"

