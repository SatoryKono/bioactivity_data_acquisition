# Assay ChEMBL Pipeline Configuration
#
# This configuration defines the pipeline for extracting assay records
# from the ChEMBL API and normalizing them to the project schema.

# Inherit from base, determinism, and common ChEMBL profiles
extends:
  - ../../profiles/base.yaml
  - ../../profiles/determinism.yaml
  - ../../profiles/common_chembl.yaml

# Pipeline metadata
pipeline:
  name: assay_chembl
  version: "1.0.0"
  owner: "Data Acquisition Team"
  description: "Extract assay records from ChEMBL API"

# ChEMBL source configuration
sources:
  chembl:
    <<: *chembl_source_base
    batch_size: 25  # Must be <= 25 for ChEMBL API URL length limit
    parameters:
      <<: *chembl_source_params
      select_fields:
        - assay_chembl_id
        - description
        - assay_type
        - assay_type_description
        - assay_test_type
        - assay_category
        - assay_organism
        - assay_tax_id
        - assay_strain
        - assay_tissue
        - assay_cell_type
        - assay_subcellular_fraction
        - target_chembl_id
        - document_chembl_id
        - src_id
        - src_assay_id
        - cell_chembl_id
        - tissue_chembl_id
        - assay_group
        - confidence_score
        - confidence_description
        - variant_sequence
        - assay_classifications
        - assay_parameters

# Input file support (optional)
# You can specify input_file in two ways:
# 1. In this YAML config via cli.input_file (see below)
# 2. Via CLI option --input-file (overrides YAML value if provided)
#
# The CSV/Parquet file must contain an 'assay_chembl_id' column for batch extraction.
# If not provided, pipeline uses full pagination.
# Example CSV file: data/input/assay_ids.csv with column 'assay_chembl_id'

# CLI configuration (optional overrides)
cli:
  # Optional path to input file (CSV/Parquet) containing assay_chembl_id column
  # for batch extraction. Can be overridden via --input-file CLI option.
    input_file: "data/input/assay.csv"

# Determinism configuration for assay pipeline
determinism:
  sort:
    by:
      - assay_chembl_id
      - row_subtype
      - row_index
    ascending:
      - true
      - true
      - true
    <<: *chembl_sort_common
  column_order:
    - assay_chembl_id
    - row_subtype
    - row_index
    - description
    - assay_type
    - assay_type_description
    - assay_test_type
    - assay_category
    - assay_organism
    - assay_tax_id
    - assay_strain
    - assay_tissue
    - assay_cell_type
    - assay_subcellular_fraction
    - target_chembl_id
    - document_chembl_id
    - src_id
    - src_assay_id
    - cell_chembl_id
    - tissue_chembl_id
    - assay_group
    - confidence_score
    - confidence_description
    - variant_sequence
    - assay_classifications
    - assay_parameters
    - assay_class_id
    - curation_level

  hashing:
    <<: *chembl_hashing_common
    business_key_fields:
      - assay_chembl_id
      - row_subtype
      - row_index

# Transform configuration
transform:
  arrays_to_header_rows:
    - assay_classifications
    - assay_parameters

postprocess:
  <<: *chembl_postprocess_common

# Validation schema
validation:
  schema_out: "bioetl.schemas.assay_chembl.AssaySchema"
  <<: *chembl_validation_common
  coerce: true

