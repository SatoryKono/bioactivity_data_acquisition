# TestItem ChEMBL Pipeline Configuration
#
# This configuration defines the pipeline for extracting molecule records
# from the ChEMBL API and normalizing them to the project schema.

# Inherit from base, determinism, and common ChEMBL profiles
extends:
  - ../../profiles/base.yaml
  - ../../profiles/determinism.yaml
  - ../../profiles/common_chembl.yaml

# Pipeline metadata
pipeline:
  name: testitem_chembl
  version: "0.1.0"
  owner: "bioetl-team"
  description: "ChEMBL Molecules (/molecule) â†’ normalized test items"

# ChEMBL source configuration
sources:
  chembl:
    <<: *chembl_source_base
    batch_size: 25  # Must be <= 25 for ChEMBL API URL length limit (for batch extraction)
    parameters:
      <<: *chembl_source_params
      max_pages: null  # null = all pages, or set to limit for dev/ci (for full pagination)
      filters: {}  # e.g., molecule_properties__full_mwt__lte: "1000"
      select_fields:
        # scalars
        - molecule_chembl_id
        - pref_name
        - max_phase
        - first_approval
        - first_in_class
        - availability_type
        - black_box_warning
        - chirality
        - dosed_ingredient
        - helm_notation
        - indication_class
        - inorganic_flag
        - natural_product
        - prodrug
        - structure_type
        - therapeutic_flag
        # nested objects (pull whole blocks; we'll flatten in transform)
        - molecule_hierarchy
        - molecule_properties
        - molecule_structures
        # arrays
        - atc_classifications
        - cross_references
        - molecule_synonyms

# Input file support (optional)
# You can specify input_file in two ways:
# 1. In this YAML config via cli.input_file (see below)
# 2. Via CLI option --input-file (overrides YAML value if provided)
#
# The CSV/Parquet file must contain a 'molecule_chembl_id' column for batch extraction.
# If not provided, pipeline uses full pagination.
# Example CSV file: data/input/molecule_ids.csv with column 'molecule_chembl_id'

# CLI configuration (optional overrides)
cli:
  # Optional path to input file (CSV/Parquet) containing molecule_chembl_id column
  # for batch extraction. Can be overridden via --input-file CLI option.
   input_file: "data/input/testitem.csv"

# Determinism configuration for testitem pipeline
determinism:
  sort:
    by:
      - molecule_chembl_id
    ascending:
      - true
    <<: *chembl_sort_common
  column_order:
    # Scalars
    - molecule_chembl_id
    - pref_name
    - molecule_type
    - max_phase
    - first_approval
    - first_in_class
    - availability_type
    - black_box_warning
    - chirality
    - dosed_ingredient
    - helm_notation
    - indication_class
    - inorganic_flag
    - natural_product
    - prodrug
    - structure_type
    - therapeutic_flag
    # Flattened from molecule_hierarchy
    - molecule_hierarchy__parent_chembl_id
    # Flattened from molecule_structures
    - molecule_structures__canonical_smiles
    - molecule_structures__standard_inchi
    - molecule_structures__standard_inchi_key
    # Flattened from molecule_properties
    - molecule_properties__alogp
    - molecule_properties__aromatic_rings
    - molecule_properties__cx_logd
    - molecule_properties__cx_logp
    - molecule_properties__cx_most_apka
    - molecule_properties__cx_most_bpka
    - molecule_properties__full_molformula
    - molecule_properties__full_mwt
    - molecule_properties__hba
    - molecule_properties__hba_lipinski
    - molecule_properties__hbd
    - molecule_properties__hbd_lipinski
    - molecule_properties__heavy_atoms
    - molecule_properties__molecular_species
    - molecule_properties__mw_freebase
    - molecule_properties__mw_monoisotopic
    - molecule_properties__num_lipinski_ro5_violations
    - molecule_properties__num_ro5_violations
    - molecule_properties__psa
    - molecule_properties__qed_weighted
    - molecule_properties__ro3_pass
    - molecule_properties__rtb
    # Serialized arrays
    - atc_classifications
    - cross_references__flat
    - molecule_synonyms__flat
    # Version fields
    - _chembl_db_version
    - _api_version

  hashing:
    <<: *chembl_hashing_common
    business_key_fields:
      - molecule_chembl_id

# Transform configuration
transform:
  enable_flatten: true
  enable_serialization: true
  arrays_simple_to_pipe:
    - atc_classifications
  arrays_objects_to_header_rows:
    - cross_references
    - molecule_synonyms
  flatten_objects:
    molecule_hierarchy:
      - parent_chembl_id
    molecule_properties:
      - alogp
      - aromatic_rings
      - cx_logd
      - cx_logp
      - cx_most_apka
      - cx_most_bpka
      - full_molformula
      - full_mwt
      - hba
      - hba_lipinski
      - hbd
      - hbd_lipinski
      - heavy_atoms
      - molecular_species
      - mw_freebase
      - mw_monoisotopic
      - num_lipinski_ro5_violations
      - num_ro5_violations
      - psa
      - qed_weighted
      - ro3_pass
      - rtb
    molecule_structures:
      - canonical_smiles
      - standard_inchi
      - standard_inchi_key

postprocess:
  <<: *chembl_postprocess_common

# Validation schema
validation:
  schema_out: "bioetl.schemas.testitem_chembl.TestItemSchema"
  <<: *chembl_validation_common
  coerce: true

