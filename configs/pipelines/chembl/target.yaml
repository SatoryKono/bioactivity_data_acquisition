# Target ChEMBL Pipeline Configuration
#
# This configuration defines the pipeline for extracting target records
# from the ChEMBL API and normalizing them to the project schema.

# Inherit from base and determinism profiles
extends:
  - ../../profiles/base.yaml
  - ../../profiles/determinism.yaml

# Pipeline metadata
pipeline:
  name: target_chembl
  version: "1.0.0"
  owner: "Data Acquisition Team"
  description: "Extract target records from ChEMBL API"

# ChEMBL source configuration
sources:
  chembl:
    enabled: true
    description: "ChEMBL REST API"
    batch_size: 25  # Must be <= 25 for ChEMBL API URL length limit
    parameters:
      base_url: "https://www.ebi.ac.uk/chembl/api/data"
      max_url_length: 2000  # Used for predictive throttling of batch requests
      select_fields:
        - target_chembl_id
        - pref_name
        - target_type
        - organism
        - tax_id
        - species_group_flag
        - cross_references
        - target_components

# Input file support (optional)
# You can specify input_file in two ways:
# 1. In this YAML config via cli.input_file (see below)
# 2. Via CLI option --input-file (overrides YAML value if provided)
#
# The CSV/Parquet file must contain a 'target_chembl_id' column for batch extraction.
# If not provided, pipeline uses full pagination.
# Example CSV file: data/input/target_ids.csv with column 'target_chembl_id'

# CLI configuration (optional overrides)
cli:
  # Optional path to input file (CSV/Parquet) containing target_chembl_id column
  # for batch extraction. Can be overridden via --input-file CLI option.
   input_file: "data/input/target.csv"

# Determinism configuration for target pipeline
determinism:
  sort:
    by:
      - target_chembl_id
    ascending:
      - true
    na_position: "last"
  column_order:
    - target_chembl_id
    - pref_name
    - target_type
    - organism
    - tax_id
    - species_group_flag
    - cross_references__flat
    - target_components__flat
    - target_component_synonyms__flat
    - uniprot_accessions
    - protein_class_desc
    - component_count

  hashing:
    algorithm: "sha256"
    row_fields: []
    business_key_fields:
      - target_chembl_id
    exclude_fields:
      - generated_at
      - run_id

# Transform configuration
transform:
  arrays_to_header_rows:
    - cross_references
    - target_components

# Validation schema
validation:
  schema_out: "bioetl.schemas.target_chembl.TargetSchema"
  strict: true
  coerce: false

