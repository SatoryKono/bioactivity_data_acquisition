# Конфигурация v2 для documents pipeline
# Основана на унифицированном шаблоне config.template.yaml

# Метаданные пайплайна - основная информация о пайплайне
pipeline:
  name: "documents"                  # Имя пайплайна для идентификации
  version: "2.0.0"                  # Версия конфигурации
  entity_type: "documents"          # Тип сущности для обработки
  description: "ETL pipeline for document metadata from multiple sources"  # Описание назначения

# HTTP настройки
http:
  global:
    timeout_sec: 60.0
    retries:
      total: 5
      backoff_multiplier: 2.0
      backoff_max: 120.0
    rate_limit:
      max_calls: 5
      period: 15.0
    headers:
      Accept: "application/json"
      User-Agent: "bioactivity-data-acquisition/0.1.0"
    verify_ssl: true
    follow_redirects: true

# Источники данных - конфигурация источников для извлечения данных
sources:
  crossref:                            # Crossref API для DOI метаданных
    enabled: true                      # Включен ли источник
    http:                              # HTTP настройки для Crossref
      base_url: "https://api.crossref.org"  # Базовый URL API
      timeout_sec: 30.0                # Таймаут для Crossref запросов
      retries:                         # Настройки повторных попыток
        total: 3                       # Количество попыток
        backoff_multiplier: 2.0        # Множитель задержки
    batch_size: 100                    # Размер батча для запросов
    max_requests_per_second: 10        # Максимум запросов в секунду
    
  openalex:                            # OpenAlex API для научных публикаций
    enabled: true                      # Включен ли источник
    http:                              # HTTP настройки для OpenAlex
      base_url: "https://api.openalex.org"  # Базовый URL API
      timeout_sec: 30.0                # Таймаут для OpenAlex запросов
      retries:                         # Настройки повторных попыток
        total: 3                       # Количество попыток
        backoff_multiplier: 2.0        # Множитель задержки
    batch_size: 50                     # Размер батча для запросов
    max_requests_per_second: 5         # Максимум запросов в секунду
    
  pubmed:                              # PubMed NCBI E-utilities API
    enabled: true                      # Включен ли источник
    http:                              # HTTP настройки для PubMed
      base_url: "https://eutils.ncbi.nlm.nih.gov/entrez/eutils"  # Базовый URL E-utilities
      timeout_sec: 30.0                # Таймаут для PubMed запросов
      retries:                         # Настройки повторных попыток
        total: 3                       # Количество попыток
        backoff_multiplier: 2.0        # Множитель задержки
    batch_size: 200                    # Размер батча для запросов
    max_requests_per_second: 3         # Максимум запросов в секунду
    
  semantic_scholar:                    # Semantic Scholar API
    enabled: true                      # Включен ли источник
    http:                              # HTTP настройки для Semantic Scholar
      base_url: "https://api.semanticscholar.org"  # Базовый URL API
      timeout_sec: 30.0                # Таймаут для Semantic Scholar запросов
      retries:                         # Настройки повторных попыток
        total: 3                       # Количество попыток
        backoff_multiplier: 2.0        # Множитель задержки
    batch_size: 100                    # Размер батча для запросов
    max_requests_per_second: 5         # Максимум запросов в секунду

# Ввод-вывод
io:
  input:
    path: "data/input/documents.csv"
    encoding: "utf-8"
    required_columns: ["document_chembl_id","doi", "pmid", "title"]
    
  output:
    dir: "data/output/documents"
    format: "csv"
    csv:
      encoding: "utf-8"
      float_format: "%.6f"
      date_format: "%Y-%m-%dT%H:%M:%SZ"
      na_rep: ""
      line_terminator: "\n"

# Runtime настройки
runtime:
  workers: 4
  limit: null
  offset: 0
  dry_run: false
  date_tag: null
  dev_mode: false
  allow_incomplete_sources: false

# Логирование
logging:
  level: "INFO"
  file:
    enabled: true
    path: "data/logs/documents.log"
    max_size: "10MB"
    backup_count: 5
  console:
    enabled: true
    format: "text"
  structured: true

# Детерминизм
determinism:
  sort:
    by: ["document_chembl_id", "doi", "pmid"]
    ascending: [true, true, true]
    na_position: "last"
  column_order:
     # Основные поля документа (оригинальные из ChEMBL)
    - document_chembl_id      # STRING: PK документа из ChEMBL API /document, тип: STRING, валидация: NOT NULL, UNIQUE, pattern ^CHEMBL\d+$
    - document_pubmed_id      # STRING: PubMed идентификатор, источник: ChEMBL, тип: STRING, валидация: nullable, pattern ^\d+$
    - document_classification # STRING: Классификация документа, источник: ChEMBL, тип: STRING, валидация: nullable
    - referenses_on_previous_experiments  # BOOL: Содержит ли документ внешние ссылки, источник: ChEMBL, тип: BOOL, валидация: boolean
    - original_experimental_document     # BOOL: Является ли документ экспериментальным, источник: ChEMBL, тип: BOOL, валидация: boolean
    - document_citation       # TEXT: Форматированная литературная ссылка, источник: система, тип: TEXT, валидация: nullable
    - retrieved_at            # STRING: Время получения данных, источник: система, тип: TIMESTAMP, валидация: NOT NULL, ISO 8601

    - pubmed_mesh_descriptors # TEXT: MeSH дескрипторы из PubMed, источник: PubMed E-utilities, тип: TEXT, валидация: nullable
    - pubmed_mesh_qualifiers  # TEXT: MeSH квалификаторы из PubMed, источник: PubMed E-utilities, тип: TEXT, валидация: nullable
    - pubmed_chemical_list    # TEXT: Список химических веществ из PubMed, источник: PubMed E-utilities, тип: TEXT, валидация: nullable
    - crossref_subject        # TEXT: Предметная область из Crossref, источник: Crossref API, тип: TEXT, валидация: nullable

    # Группа полей PMID из всех источников
    - chembl_pmid             # STRING: PMID из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable, pattern ^\d+$
    - crossref_pmid           # STRING: PMID из Crossref, источник: Crossref API, тип: STRING, валидация: nullable, pattern ^\d+$
    - openalex_pmid           # STRING: PMID из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable, pattern ^\d+$
    - pubmed_pmid             # STRING: PMID из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable, pattern ^\d+$
    - semantic_scholar_pmid   # STRING: PMID из Semantic Scholar, источник: Semantic Scholar API, тип: STRING, валидация: nullable, pattern ^\d+$
    
    # Группа полей названий статей из всех источников
    - chembl_title            # TEXT: Название статьи из ChEMBL, источник: ChEMBL API, тип: TEXT, валидация: nullable
    - crossref_title          # TEXT: Название статьи из Crossref, источник: Crossref API, тип: TEXT, валидация: nullable
    - openalex_title          # TEXT: Название статьи из OpenAlex, источник: OpenAlex API, тип: TEXT, валидация: nullable
    - pubmed_article_title    # TEXT: Название статьи из PubMed, источник: PubMed E-utilities, тип: TEXT, валидация: nullable
    - semantic_scholar_title  # TEXT: Название статьи из Semantic Scholar, источник: Semantic Scholar API, тип: TEXT, валидация: nullable
    
    # Группа полей аннотаций из всех источников
    - chembl_abstract            # TEXT: Аннотация из ChEMBL, источник: ChEMBL API, тип: TEXT, валидация: nullable
    - crossref_abstract          # TEXT: Аннотация из Crossref, источник: Crossref API, тип: TEXT, валидация: nullable
    - openalex_abstract          # TEXT: Аннотация из OpenAlex, источник: OpenAlex API, тип: TEXT, валидация: nullable
    - pubmed_abstract            # TEXT: Аннотация из PubMed, источник: PubMed E-utilities, тип: TEXT, валидация: nullable
    
    # Группа полей авторов из всех источников
    - chembl_authors             # TEXT: Авторы из ChEMBL, источник: ChEMBL API, тип: TEXT, валидация: nullable
    - crossref_authors           # TEXT: Авторы из Crossref, источник: Crossref API, тип: TEXT, валидация: nullable
    - openalex_authors           # TEXT: Авторы из OpenAlex, источник: OpenAlex API, тип: TEXT, валидация: nullable
    - pubmed_authors             # TEXT: Авторы из PubMed, источник: PubMed E-utilities, тип: TEXT, валидация: nullable
    - semantic_scholar_authors   # TEXT: Авторы из Semantic Scholar, источник: Semantic Scholar API, тип: TEXT, валидация: nullable
    
    # Группа полей DOI из всех источников
    - chembl_doi              # STRING: DOI из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable, pattern ^10\.\d+/[^\s]+$
    - crossref_doi            # STRING: DOI из Crossref, источник: Crossref API, тип: STRING, валидация: nullable, pattern ^10\.\d+/[^\s]+$
    - openalex_doi             # STRING: DOI из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable, pattern ^10\.\d+/[^\s]+$
    - pubmed_doi              # STRING: DOI из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable, pattern ^10\.\d+/[^\s]+$
    - semantic_scholar_doi    # STRING: DOI из Semantic Scholar, источник: Semantic Scholar API, тип: STRING, валидация: nullable, pattern ^10\.\d+/[^\s]+$
    
    # Группа полей типов публикации из всех источников
    - chembl_doc_type          # STRING: Тип документа из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable
    - crossref_doc_type       # STRING: Тип документа из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_doc_type      # STRING: Тип документа из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - openalex_crossref_doc_type  # STRING: Тип документа из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_doc_type          # STRING: Тип публикации из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    - semantic_scholar_doc_type    # STRING: Типы публикации из Semantic Scholar, источник: Semantic Scholar API, тип: STRING, валидация: nullable
    
    # Группа полей ISSN из всех источников
    - chembl_issn             # STRING: ISSN из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable, pattern ^\d{4}-\d{3}[\dX]$
    - crossref_issn           # STRING: ISSN из Crossref, источник: Crossref API, тип: STRING, валидация: nullable, pattern ^\d{4}-\d{3}[\dX]$
    - openalex_issn           # STRING: ISSN из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable, pattern ^\d{4}-\d{3}[\dX]$
    - pubmed_issn             # STRING: ISSN из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable, pattern ^\d{4}-\d{3}[\dX]$
    - semantic_scholar_issn   # STRING: ISSN из Semantic Scholar, источник: Semantic Scholar API, тип: STRING, валидация: nullable, pattern ^\d{4}-\d{3}[\dX]$
    
    # Группа полей названий журналов из всех источников
    - chembl_journal          # STRING: Название журнала из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable
    - crossref_journal        # STRING: Название журнала из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_journal        # STRING: Название журнала из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_journal           # STRING: Название журнала из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    - semantic_scholar_journal  # STRING: Название журнала из Semantic Scholar, источник: Semantic Scholar API, тип: STRING, валидация: nullable
    
    # Группа полей годов издания из всех источников
    - chembl_year             # INT: Год из ChEMBL, источник: ChEMBL API, тип: INT, валидация: nullable, 1900-текущий год
    - crossref_year           # INT: Год из Crossref, источник: Crossref API, тип: INT, валидация: nullable, 1900-текущий год
    - openalex_year           # INT: Год из OpenAlex, источник: OpenAlex API, тип: INT, валидация: nullable, 1900-текущий год
    - pubmed_year             # INT: Год из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1900-текущий год

    # Группа полей томов из всех источников
    - chembl_volume           # STRING: Том из ChEMBL, источник: ChEMBL API, тип: STRING, валидация:rometer
    - crossref_volume         # STRING: Том из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_volume         # STRING: Том из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_volume           # STRING: Том из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    
    # Группа полей выпусков из всех источников
    - chembl_issue            # STRING: Номер выпуска из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable
    - crossref_issue          # STRING: Номер выпуска из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_issue          # STRING: Номер выпуска из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_issue            # STRING: Номер выпуска из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    
    # Группа полей первых страниц из всех источников
    - crossref_first_page     # STRING: Первая страница из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_first_page     # STRING: Первая страница из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_first_page       # STRING: Начальная страница из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    
    # Группа полей последних страниц из всех источников
    - crossref_last_page      # STRING: Последняя страница из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_last_page      # STRING: Последняя страница из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_last_page        # STRING: Конечная страница из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    
    # Группа полей ошибок из всех источников
    - chembl_error            # STRING: Ошибка из ChEMBL, источник: ChEMBL API, тип: STRING, валидация: nullable
    - crossref_error          # STRING: Ошибка из Crossref, источник: Crossref API, тип: STRING, валидация: nullable
    - openalex_error          # STRING: Ошибка из OpenAlex, источник: OpenAlex API, тип: STRING, валидация: nullable
    - pubmed_error            # STRING: Ошибка из PubMed, источник: PubMed E-utilities, тип: STRING, валидация: nullable
    - semantic_scholar_error  # STRING: Ошибка из Semantic Scholar, источник: Semantic Scholar API, тип: STRING, валидация: nullable

    # Поля из PubMed (расширенные)
    - pubmed_year_completed   # INT: Год завершения из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1900-текущий год
    - pubmed_month_completed  # INT: Месяц завершения из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1-12
    - pubmed_day_completed    # INT: День завершения из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1-31
    - pubmed_year_revised     # INT: Год пересмотра из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1900-текущий год
    - pubmed_month_revised    # INT: Месяц пересмотра из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1-12
    - pubmed_day_revised      # INT: День пересмотра из PubMed, источник: PubMed E-utilities, тип: INT, валидация: nullable, 1-31
    - publication_date        # STRING: Дата публикации, источник: вычисляется, тип: DATE, валидация: nullable, ISO 8601
    - document_sortorder      # INT: Порядок сортировки документов, источник: вычисляется, тип: INT, валидация: NOT NULL, >= 0

    # Поля валидации данных из различных источников
    - valid_doi               # BOOL: Валидное значение DOI, источник: система, тип: BOOL, валидация: boolean
    - valid_journal           # BOOL: Валидное значение журнала, источник: система, тип: BOOL, валидация: boolean
    - valid_year              # BOOL: Валидное значение года, источник: система, тип: BOOL, валидация: boolean
    - valid_volume            # BOOL: Валидное значение тома, источник: система, тип: BOOL, валидация: boolean
    - valid_issue             # BOOL: Валидное значение номера выпуска, источник: система, тип: BOOL, валидация: boolean
    - invalid_doi             # BOOL: Флаг невалидности DOI, источник: система, тип: BOOL, валидация: boolean
    - invalid_journal         # BOOL: Флаг невалидности журнала, источник: система, тип: BOOL, валидация: boolean
    - invalid_year            # BOOL: Флаг невалидности года, источник: система, тип: BOOL, валидация: boolean
    - invalid_volume          # BOOL: Флаг невалидности тома, источник: система, тип: BOOL, валидация: boolean
    - invalid_issue           # BOOL: Флаг невалидности номера выпуска, источник: система, тип: BOOL, валидация: boolean    
   # Метаданные
    - "index"                         # INT: Порядковый номер записи, тип: INT, валидация: NOT NULL, >= 0
    - "pipeline_version"               # STRING: Версия пайплайна, источник: система, тип: STRING, валидация: NOT NULL                        # INT: Порядковый номер записи, тип: INT, валидация: NOT NULL, >= 0
    - "source_system"                 # STRING: Система-источник, источник: система, тип: STRING, валидация: NOT NULL
    - "chembl_release"                # STRING: Версия ChEMBL, источник: система, тип: STRING, валидация: nullable
    - "extracted_at"                  # STRING: Время извлечения данных, источник: система, тип: TIMESTAMP, валидация: NOT NULL, ISO 8601
    - "hash_row"                      # STRING: Хеш строки, источник: система, тип: STRING, валидация: NOT NULL, SHA256
    - "hash_business_key"             # STRING: Хеш бизнес-ключа, источник: система, тип: STRING, валидация: NOT NULL, SHA256


# Валидация - настройки проверки данных
validation:
  enabled: true                        # Включить валидацию
  strict: false                        # Строгий режим (останавливать при ошибках)
  schema_validation: true              # Валидация схемы данных
  data_quality_checks: true            # Проверки качества данных

# Постобработка - настройки обработки после извлечения
postprocess:
  qc:                                 # Контроль качества
    enabled: true                      # Включить QC
    fail_on: ["missing_doi", "missing_title"]  # Критические ошибки
    thresholds:                        # Пороговые значения для QC
      missing_doi: 0.1                # Максимальный % отсутствующих DOI
      missing_title: 0.05              # Максимальный % отсутствующих заголовков
    detailed_report: true              # Детальный отчет QC
    
  correlation:                        # Корреляционный анализ
    enabled: true                      # Включить корреляцию
    methods: ["pearson", "spearman"]   # Методы корреляции
    min_correlation: 0.5               # Минимальная корреляция
    
  steps:                              # Этапы постобработки
    - type: "merge_sources"            # Объединение источников
      description: "Merge data from multiple sources"
      priority: ["crossref", "openalex", "pubmed", "semantic_scholar"]  # Приоритет источников
    - type: "doi_fallback"             # Fallback по DOI
      description: "Use DOI as fallback identifier"
    - type: "author_normalization"     # Нормализация авторов
      description: "Normalize author names and affiliations"
    - type: "journal_normalization"    # Нормализация журналов
      description: "Normalize journal names"
    - type: "citation_formatting"      # Форматирование цитирования
      description: "Format citation data"

# Нормализация - настройки нормализации данных
normalization:
  enabled: true                        # Включить нормализацию
  doi_format: "standard"              # Формат DOI
  author_format: "last_first"         # Формат авторов
  date_format: "iso"                  # Формат дат

# Качество данных - профили контроля качества
quality:
  profiles:
    default:                          # Профиль по умолчанию
      enabled: true                    # Включен ли профиль
      rules:                          # Правила валидации
        - name: "valid_doi"            # Валидация DOI
          pattern: "^10\\.\\d+/[^\\s]+$"  # Регулярное выражение
        - name: "valid_pmid"           # Валидация PMID
          pattern: "^\\d+$"             # Регулярное выражение
        - name: "non_empty_title"      # Валидация заголовка
          min_length: 10               # Минимальная длина

# Кэширование - настройки кэширования данных
cache:
  enabled: true                        # Включить кэширование
  dir: "data/cache/documents"         # Директория кэша
  ttl: 86400                          # Время жизни кэша в секундах (24 часа)
  max_size: "1GB"                     # Максимальный размер кэша

# Мониторинг и телеметрия - настройки сбора метрик
telemetry:
  enabled: false                       # Включить телеметрию
  endpoint: null                       # Endpoint для отправки метрик
  api_key: null                        # API ключ для аутентификации
  batch_size: 100                      # Размер батча для отправки
  flush_interval: 30.0                 # Интервал отправки в секундах
