# Unified config schema for BioETL pipelines.
# Designed for basic dict-based validators: no anchors, custom tags, or references.
schema:
  version:
    type: int
    required: true
    description: "Версия схемы конфига. Целое число, контролирует миграции."
  common:
    type: map
    required: true
    description: "Общие параметры для всех пайплайнов (Assay, Activity, Testitem, Target, Document)."
    fields:
      dataset:
        type: str
        required: true
        description: "Имя набора данных/артефакта для включения в QC и meta.yaml."
      output_path:
        type: path
        required: true
        description: "Абсолютный или относительный путь (UTC/ISO8601 в метаданных), используется атомарной записью."
      client:
        type: map
        required: true
        description: "Настройки UnifiedAPIClient."
        fields:
          base_url:
            type: str
            required: true
            description: "Базовый URL внешнего API; MUST быть нормализован."
          api_key_env:
            type: str|null
            required: false
            default: null
            description: "Имя переменной окружения с секретом; null если аутентификация не требуется."
          timeout_s:
            type: int
            required: false
            default: 30
            description: "Таймаут запроса в секундах; жёсткое ограничение UnifiedAPIClient."
          retries:
            type: int
            required: false
            default: 3
            description: "Количество повторов с экспоненциальным backoff."
          backoff_s:
            type: float
            required: false
            default: 1.0
            description: "Начальный backoff в секундах с обязательным джиттером."
      extract:
        type: map
        required: true
        description: "Параметры извлечения данных."
        fields:
          pagination_size:
            type: int
            required: false
            default: 100
            description: "Размер страницы пагинации; соблюдает детерминированный порядок."
          since:
            type: str|null
            required: false
            default: null
            description: "ISO-8601 граница инкрементальной загрузки или null."
      normalize:
        type: map
        required: true
        description: "Политика нормализации значений."
        fields:
          na_policy:
            type: enum
            required: false
            default: "drop"
            values: ["drop", "keep", "fill"]
            description: "Стратегия обращения с пропущенными значениями (строго перечисление)."
      validate:
        type: map
        required: true
        description: "Ссылки на Pandera-схемы и дополнительные проверки."
        fields:
          schema:
            type: str|null
            required: false
            default: null
            description: "Полный путь до Pandera-схемы; null допускается для промежуточных этапов."
      write:
        type: map
        required: true
        description: "Настройки вывода артефактов и сериализации."
        fields:
          format:
            type: enum
            required: false
            default: "csv"
            values: ["csv", "parquet", "jsonl"]
            description: "Формат вывода; deterministic writers обязаны сортировать строки и колонки."
          include_header:
            type: bool
            required: false
            default: true
            description: "Флаг включения заголовка в выгрузку (применимо к CSV/JSONL)."

mapping_old_to_new:
  api.endpoint: client.base_url
  api.token_env: client.api_key_env
  page_size: extract.pagination_size
  output.dir: output_path

# Примечание: дополнительные синонимы в ветке не обнаружены (поиск по `api.endpoint`, `api.token_env`, `output.dir` дал 0 совпадений); маппинг отражает только подтверждённые ключи из спецификации.

