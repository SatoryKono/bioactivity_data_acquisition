# Specification: Pipeline Output Layout

This document defines the standard structure and naming conventions for all artifacts generated by `bioetl` pipelines. Adhering to this layout ensures that pipeline outputs are predictable, consistent, and easily consumed by downstream processes and automated tooling.

## 1. Root Output Directory

All pipeline outputs for a single run are written to a common root directory. This directory is specified at runtime via the **required** `--output-dir` CLI flag.

It is strongly recommended to use a unique, descriptive name for this directory for each run, such as one that includes the pipeline name and a timestamp.

**Example:**
```bash
python -m bioetl.cli.main activity \
  --output-dir /data/output/activity/run_20251103_103000
```

## 2. Standard Artifacts and Naming Conventions

Inside the root output directory, the framework generates a set of standard artifacts. The naming convention is based on the pipeline's `name` as defined in its configuration.

Let's assume `pipeline.name` is `activity`. The standard output files would be:

-   **`activity.csv`**: The main dataset artifact. This file contains the clean, validated, and transformed data. While other formats like Parquet are supported, CSV is the default.
-   **`activity_meta.yaml`**: The run manifest. This is a YAML file containing a comprehensive record of the pipeline run, including configuration hashes, file checksums, and QC metrics.
-   **`activity_qc_report.csv`**: The quality control report. This file contains detailed metrics about the quality of the data, such as null counts, uniqueness, and validation failures.

### Example Directory Structure

```
/data/output/activity/run_20251103_103000/
├── activity.csv
├── activity_meta.yaml
└── activity_qc_report.csv
```

## 3. The `meta.yaml` Manifest File

The `meta.yaml` file is the definitive record of a pipeline run. It is a human-readable YAML file with alphabetically sorted keys, making it easy to compare across runs.

### `meta.yaml` Structure

| Top-Level Key | Description |
|---|---|
| `artifacts` | A map of artifact types (e.g., `dataset`, `quality_report`) to their relative output paths within the run directory. |
| `column_order`| An explicit list of all column names in their exact, final order as they appear in the dataset artifact. |
| `config_fingerprint` | A SHA256 hash of the fully resolved `PipelineConfig` object, providing a unique signature for the exact configuration used in the run. |
| `config_snapshot` | Contains the path to the main YAML configuration file and its SHA256 hash at the time of the run. |
| `generated_at_utc` | An ISO-8601 timestamp (UTC) indicating when the run was executed. This is a non-deterministic field. |
| `hash_algo` | The hashing algorithm used for all integrity checks (e.g., `sha256`). |
| `inputs`| A list of input files used by the pipeline, each with its path and SHA256 hash. |
| `outputs`| A list of all generated output files, each with its path and SHA256 hash. This allows for quick verification of artifact integrity. |
| `pipeline` | Metadata about the pipeline, including its `name` and `version`. |
| `qc`| A dictionary of high-level quality control metrics, such as `total_rows`, `duplicate_rows`, and `missing_values`. |
| `run_id`| A unique identifier for the specific pipeline execution. This is a non-deterministic field. |
| `schema_version`| The version of the Pandera schema that the output data was validated against. |
| `source_lineage`| A dictionary containing version information about the upstream data sources (e.g., `chembl_release: "33"`). |

For a more detailed specification on how these values are generated, see the `[ref: repo:docs/determinism/01-determinism-policy.md@test_refactoring_32]` document.

## 4. Extended and Debug Artifacts

Some pipelines may be configured to generate additional, non-standard artifacts for debugging or extended analysis.

-   **Trigger**: This behavior is often controlled by a CLI flag such as `--extended`.
-   **Naming**: These files should follow the base naming convention but with a descriptive suffix (e.g., `activity_enrichment_failures.csv`).
-   **`meta.yaml`**: Any extended artifacts should also be registered in the `outputs` section of the `meta.yaml` file.
