# Промт: «HTTP-клиенты с backoff и унифицированными правилами»

> **Note**: Implementation status: **planned**. All file paths referencing
> `src/bioetl/` in this document describe the intended architecture and are not
> yet implemented in the codebase.

Роль и режим работы

Ты — системный аналитик ETL и разработчик. Работаешь строго по содержимому ветки
test_refactoring_32 репозитория SatoryKono/bioactivity_data_acquisition. Никаких
внешних предположений о коде. Все ссылки на репозиторий оформляй так:

\[ref: repo:`<path>`@refactoring_001\]

Обязательные внутренние источники

[ref: repo:README.md@refactoring_001] — упоминание «HTTP-клиенты с backoff» и
запуск через CLI.

[ref: repo:src/bioetl/cli/cli_app.py@refactoring_001] — как конфиги/профили
влияют на сетевые параметры.

[ref: repo:src/bioetl/configs/models.py@refactoring_001] — типобезопасные ключи
конфигов, сетевые таймауты/лимиты (если есть).

[ref: repo:src/bioetl/\*\*@refactoring_001] — базовые клиенты, обёртки над
requests/httpx, ретраи, пагинация, парсеры.

Нормативные внешние факты (для ссылок в документе)

Семантика Retry-After (форматы: дата/секунды) и поведение при 503/3xx.
datatracker.ietf.org

Статус 429 «Too Many Requests» и работа с лимитированием. datatracker.ietf.org

W3C Trace Context (traceparent, tracestate) для сквозной трассировки. W3C +1

OpenTelemetry: семантические конвенции для HTTP-клиента (атрибуты/span/метрики).
OpenTelemetry +1

Иденпотентность и заголовок Idempotency-Key (черновик IETF).
datatracker.ietf.org

Задача

Подготовь нормативную спецификацию «HTTP-клиенты с backoff и едиными правилами
запросов», которая стандартизует:

базовый интерфейс HTTP-клиента и слои конфигурации;

классификацию ошибок и правила ретраев (включая чтение Retry-After);

лимиты RPS/пулы соединений/таймауты;

идемпотентные повторные запросы и Idempotency-Key (если в коде используется);

телеметрию: трассировка/метрики/логи;

пагинацию и квотирование источников (ChEMBL и др.);

тест-план (юнит/интеграция) и пример клиентского кода.

Что нужно выдать (два файла)

docs/http/00-http-clients-and-retries.md — спецификация.

configs/defaults/network.yaml — минимальный профиль сети
(таймауты/лимиты/ретраи) с комментариями и ссылками на поля PipelineConfig.

Обязательное содержание спецификации (структура)

1. Обзор и цели

Роль базового HTTP-клиента: единая точка настройки таймаутов, ретраев,
логирования, телеметрии и детерминизма сериализации ответов.

Влияние профилей (base.yaml, determinism.yaml, network.yaml) на параметры
клиента с указанием приоритета слоёв (опирайся на реализацию CLI). Справочно:
при 503 и/или 3xx сервер может указывать задержку Retry-After (дата или секунды)
— клиент обязан её учитывать. datatracker.ietf.org

1. Конфигурация (типобезопасно)

Таблица ключей PipelineConfig/профиля network.yaml: connect_timeout,
read_timeout, total_timeout, max_retries, backoff_base, backoff_cap,
respect_retry_after: true|false, status_forcelist, methods_whitelist,
rate_limit_rps, pool_maxsize, headers.default, user_agent.

Порядок мерджа: base.yaml → профили (determinism.yaml, network.yaml) → --config
→ флаги CLI.

Неизвестные ключи — ошибка валидации (см. модели конфигов в коде).

1. Таймауты, пулы, заголовки

Модель таймаутов: соединение/чтение/тотальный (слои + переопределения на метод).

Пул соединений: стабильные лимиты, стратегия повторного использования.

User-Agent: включить имя пакета/версию (и commit, если предусмотрено в коде).

Обязательные заголовки (если есть в коде): Accept, Accept-Encoding,
трейс-заголовки (см. §06).

1. Ретраи и backoff

Классификация статусов/исключений:

Ретраим: 429, 408, 5xx (уточни по коду, какие именно), сетевые таймауты,
transient-ошибки DNS/TLS.

Не ретраим: 4xx (кроме 408/429) и явно фатальные ошибки парсинга.

Алгоритм: экспоненциальный backoff с верхней «кепкой»; если Retry-After
присутствует — ждать указанный интервал (имеет приоритет над локальным
расчётом). datatracker.ietf.org

Идемпотентность: безопасные методы (GET/HEAD/OPTIONS) ретраятся по правилам; для
POST/PATCH — только если в коде реализован механизм идемпотентности (например,
Idempotency-Key). Укажи, что сам заголовок стандартизуется в IETF-черновике.
datatracker.ietf.org

1. Квоты, лимиты и 429

При 429 Too Many Requests использовать серверный Retry-After; при его отсутствии
— локальную стратегия backoff и снижение параллелизма.

Опиши стратегию дросселирования RPS/одновременных запросов на
клиента/хост/эндпоинт (по коду).

Справка по 429 как стандартному статусу лимитирования. datatracker.ietf.org

1. Телеметрия и логирование

Трейсинг: прокидывание traceparent/tracestate для сквозной трассировки; старт
span http.client c атрибутами (метод, урл/хост, код ответа, размер,
длительность, попытка №). W3C +1

Метрики: латентность (p50/p95), счётчики ретраев/фатальных ошибок, коды ответов
(лейблы), RPS. OpenTelemetry

Логи: единый формат события (уровень, попытка, задержка, причина ретрая,
выдержанный Retry-After).

1. Пагинация и лимиты источников

Единые контракты пагинации: page/size или offset/limit, чтение
next-ссылки/курсоров; требования к «паузам» между страницами при лимитах.

Укажи точки расширения под специфику ChEMBL и пр., с ссылками на соответствующие
клиенты/парсеры.

1. Обработка ответов и ошибок

Единая декодировка JSON/CSV, нормализация кодировок, обработка Content-Type.

Библиотека ошибок: иерархия исключений (HTTP, сеть, парсинг, валидация),
обогащение контекстом (метод, урл, попытка, latency, trace_id).

1. Тест-план

Юнит: матрица ретраев по кодам/исключениям, приоритет Retry-After,
backoff-кепка.

Интеграция: ограниченный RPS, параллелизм и 429-сценарии, сохранение сквозного
trace-контекста; golden-тесты на стабильные логи и метрики.

Контрактные тесты пагинации: корректное соблюдение «паузы» и инвариантов лимита.

1. Примеры

Мини-пример клиента (создание с профилем network.yaml, вызов GET с ретраями,
чтение Retry-After), и пример интеграции в ChEMBL-пайплайн (ссылка на код
клиента/парсера).

Требования к оформлению

Язык: русский.

Стиль: нормативка (MUST/SHOULD/MAY), короткие таблицы, блоки псевдокода.

Все ссылки внутри — только вида \[ref: repo:`<path>`@refactoring_001\].

Внешние ссылки — лишь как сноски на нормы HTTP/OTel/Trace Context в
пояснительных местах (см. цитаты выше).

Критерии приёмки (MUST)

Чётко зафиксированы: классы ошибок для ретраев, алгоритм backoff, приоритет
Retry-After, политика идемпотентности (и её отсутствие/наличие в текущем коде),
RPS-дросселирование, набор телеметрии. (Справка по Retry-After и 503/3xx — из
стандарта HTTP. datatracker.ietf.org )

Есть профиль configs/defaults/network.yaml с документированными ключами и
приоритетом мерджа.

Тест-план покрывает 429/408/5xx, Retry-After, пагинацию, трассинг и метрики.

Примеры запуска через CLI с профилем сети и без него
