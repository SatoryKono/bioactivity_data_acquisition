# Оценка проекта по ISO/IEC 25010

Анализ качества архитектуры и требований на основе стандарта ISO/IEC 25010 и ATAM (Architecture Trade-off Analysis Method).

## Обзор

**Методология**: ISO/IEC 25010 (функциональная полнота, надёжность, сопровождаемость, совместимость, безопасность, удобство) и ATAM (риски и компромиссы).

**Краткая оценка**: Документы зрелые, но проверяемость местами неформализована. Принять пакет правок «красной линии» с едиными инвариантами.

## Матрица оценки по осям (0–5)

| Ось | Текущий балл | Целевой | Gap | Priority |
|-----|-------------|---------|-----|----------|
| Функциональная полнота и проверяемость | 3.5 | 4.5 | G4, G5, G13 | High |
| Надёжность и отказоустойчивость | 3.5 | 4.5 | G3, G11 | High |
| Производительность и лимиты | 3.0 | 4.0 | G3 | Med |
| Безопасность и соблюдение контрактов | 3.5 | 4.5 | G11, G12 | High |
| Сопровождаемость и детерминизм | 3.0 | 4.5 | G1, G9, G15 | High |
| Совместимость и переносимость | 3.5 | 4.0 | - | Med |

| Наблюдаемость и трассировка | 4.0 | 4.5 | G12 | Med |
| Пользовательская пригодность CLI | 3.0 | 4.0 | G8 | Med |
| Архитектурные trade-off'ы | 3.5 | 4.0 | - | Med |

**Средний балл**: 3.4 → 4.4 (цель)

## Детализация по осям

### 1. Функциональная полнота и проверяемость (3.5 → 4.5)

**Текущее состояние**:

- ✅ Архитектура описана детально
- ✅ Компоненты покрыты документацией

- ⚠️ Отсутствие формализованных AC
- ⚠️ Неполная проверяемость инвариантов

**Пробелы** (Gaps): G4, G5, G13

**Правки**:

- Ввести AC для всех критичных инвариантов
- Centralize schema registry с column_order

- Golden-run команда для bit-exact сравнения

**Критерий успеха**: Все инварианты покрыты AC, golden-run проходит.

---

### 2. Надёжность и отказоустойчивость (3.5 → 4.5)

**Текущее состояние**:

- ✅ Circuit breaker, retry policy описаны
- ✅ Fallback механизмы присутствуют

- ⚠️ UNCERTAIN лимит для activity
- ⚠️ Retry-After не закреплён как инвариант

**Пробелы**: G3, G11

**Правки**:

- Фиксация "безопасного" limit через бинарный поиск
- Respect Retry-After обязателен (AC5)

- Формализовать стратегию отказоустойчивости

**Критерий успеха**: Metrics 429 < 5%, stable limit зафиксирован.

---

### 3. Производительность и лимиты (3.0 → 4.0)

**Текущее состояние**:

- ✅ Batch sizing описан
- ✅ Rate limiting присутствует

- ⚠️ batch_size не валидируется
- ⚠️ Long-format может раздуть объём данных

**Пробелы**: G3

**Правки**:

- batch_size ≤ 25 validation
- Фиксация limit для activity

- Компромисс: детерминизм > скорость

**Критерий успеха**: batch_size≤25 enforced, limit зафиксирован в Best Practices.

---

### 4. Безопасность и соблюдение контрактов (3.5 → 4.5)

**Текущее состояние**:

- ✅ Redact secrets в логах
- ✅ Валидация входных данных

- ⚠️ Schema drift не fail-fast
- ⚠️ Обязательные поля логов не формализованы

**Пробелы**: G11, G12

**Правки**:

- --fail-on-schema-drift default=True
- Обязательные поля логов: run_id, stage, endpoint, etc.

- Маскирование секретов в логах

**Критерий успеха**: Схемы fail-fast, логи безопасны.

---

### 5. Сопровождаемость и детерминизм (3.0 → 4.5)

**Текущее состояние**:

- ✅ Атомарная запись описана
- ✅ Сортировка документирована

- ⚠️ Atomic write не единый норматив
- ⚠️ Hash stability не формализована

- ⚠️ Activity сортировка не AC

**Пробелы**: G1, G9, G15

**Правки**:

- Единый протокол atomic write
- Канонизация для hash (AC3)

- Сортировка по activity_id (AC6)
- Ссылки из всех пайплайнов

**Критерий успеха**: Golden-run бит-в-бит, hash стабилен.

---

### 6. Совместимость и переносимость (3.5 → 4.0)

**Текущее состояние**:

- ✅ Pandera схемы (портативность)
- ✅ Cross-platform (Windows/POSIX)

- ✅ Semver для схем описан

**Компромиссы**: Жёсткость валидации vs. гибкость миграций.

**Правки**:

- --fail-on-schema-drift с возможностью отключения
- Миграционные гайды для major updates

---

### 7. Наблюдаемость и трассировка (4.0 → 4.5)

**Текущее состояние**:

- ✅ Structured logging (structlog)
- ✅ Context переменные

- ⚠️ Обязательные поля не формализованы

**Пробелы**: G12

**Правки**:

- Список обязательных полей: run_id, stage, endpoint, params, attempt, retry_after, duration_ms

---

### 8. Пользовательская пригодность CLI (3.0 → 4.0)

**Текущее состояние**:

- ✅ CLI флаги описаны
- ⚠️ Строгие режимы не default

- ⚠️ --strict-enrichment не описано

**Пробелы**: G8

**Правки**:

- --strict-enrichment default=True
- Документация флагов

---

### 9. Архитектурные trade-off'ы (3.5 → 4.0)

**Компромиссы**:

- **Производительность vs. детерминизм**: выбор — детерминизм (AC1, golden-run)
- **Гибкость vs. строгость схем**: выбор — строгость с возможностью отключения (AC10)

- **Скорость vs. надёжность**: выбор — надёжность (Retry-After, backoff)

**Риски (ATAM)**:

- a) **Детерминизм вывода**: mitigated через AC1, AC3, AC6
- b) **Отказоустойчивость под лимитами API**: mitigated через AC5, G11

- c) **Эволюция схем (semver)**: mitigated через AC10, G4
- d) **Целостность ссылок (RI)**: mitigated через RI-чеки в assay/activity

**Правки**: Формализовать trade-off'ы в документации.

---

## Gap-анализ (ATAM)

### Критические риски

1. **Детерминизм (G1, G9, G13)** ✅ ЗАКРЫТ

   - Риск: Неидентичность run-to-run
   - Mitigation: AC1, AC6, golden-run
   - Компромисс: Performance overhead
   - **Статус**: Синхронизирована NA-policy (R1), типо-зависимая политика зафиксирована в [02-io-system.md](requirements/02-io-system.md#na-policy)

2. **Отказоустойчивость (G3, G11)** ✅ ЧАСТИЧНО ЗАКРЫТ

   - Риск: 429-штормы, неустойчивый limit
   - Mitigation: AC5, бинарный поиск limit
   - Компромисс: Время выгрузки
   - **Статус**: Протокол requeue для PartialFailure формализован (R3), см. [03-data-extraction.md](requirements/03-data-extraction.md#протокол-повторной-постановки-requeue-для-partialfailure)

3. **Эволюция схем (G4, G10)** ✅ ЗАКРЫТ

   - Риск: Breaking changes незамеченные
   - Mitigation: AC10, fail-fast
   - Компромисс: Жёсткость валидации
   - **Статус**: Обязательные поля lineage добавлены в meta.yaml (R2), см. [02-io-system.md](requirements/02-io-system.md#обязательные-поля-meta-yaml)

4. Целостность данных (G7, G8)

   - Риск: Потеря nested data, шум в output
   - Mitigation: AC8, strict-enrichment
   - Компромисс: Объём данных (long-format)

**Закрытые риски R1–R3:**

- **R1 (blocker)**: Конфликт NA-policy устранён через типо-зависимую политику
- **R2 (critical)**: Обязательные поля lineage (`run_id`, `config_hash`, `config_snapshot`) добавлены
- **R3 (major)**: Протокол requeue формализован с лимитом `max_partial_retries=3`

---

## План закрытия gaps

| Priority | Gap Count | Gaps | ETA | Owners |
|----------|-----------|------|-----|--------|
| High | 6 | G1, G2, G6, G7, G9, G11 | 7д | Архитектор, ETL Eng, Data Eng |
| Med | 8 | G3, G4, G5, G8, G10, G12, G13, G15 | 10д | Data Eng, DevOps, QA |
| Low | 1 | G14 | 1д | Data Eng |

**Total**: 15 gaps, 18 days (parallelizable)

---

## Acceptance Criteria matrix

| AC | Coverage | Owner | Status |
|----|----------|-------|--------|
| AC1 | G1, G13 | QA | Pending |
| AC2 | G4 | Data Eng | Pending |
| AC3 | G5 | Data Eng | Pending |
| AC4 | G1, G15 | Архитектор | Pending |
| AC5 | G11 | Архитектор | Pending |
| AC6 | G9 | Data Eng | Pending |
| AC7 | G6 | ETL Eng | Pending |
| AC8 | G7 | ETL Eng | Pending |
| AC9 | G10 | Data Eng | Pending |
| AC10 | G4, G8 | Архитектор | Pending |

---

## Метрики успеха

После внедрения правок (PR-1 → PR-5):

- ✅ Средний балл ≥ 4.0 (текущ: 3.4)
- ✅ All High-priority gaps закрыты

- ✅ 100% AC покрыты тестами
- ✅ Зелёный CI pipeline

- ✅ Golden-run stable (bit-exact)
- ✅ Schema drift detectible (fail-fast)

- ✅ Rate limit errors < 5%

---

## Открытые вопросы (TBD)

| Вопрос | Почему важен | К кому | Крайний срок |
|--------|--------------|--------|--------------|
| Каков «безопасный» limit для activity по факту? | Закрыть UNCERTAIN | Data Eng | T+3д |
| Нужен ли глобальный флаг для отключения correlation_report? | Контроль нагрузки | Архитектор | T+2д |
| Какой набор полей whitelist-enrichment для assay? | Стабильность контракта | Domain Owner | T+2д |

---

## Связи с документами

- [gaps.md](gaps.md) — детальный gap-лист
- [acceptance-criteria.md](acceptance-criteria.md) — AC matrix

- [pr-plan.md](pr-plan.md) — план внедрения
- [test-plan.md](test-plan.md) — план валидации

- [implementation-examples.md](implementation-examples.md) — патчи кода
- [00-architecture-overview.md](requirements/00-architecture-overview.md) — архитектура

---

## Правила сходимости

После внедрения PR-1..PR-5 и прохождения AC1–AC10:

- Средний балл по осям ожидаемо ≥ 4.0
- High-priority gaps закрыты

- Владельцы назначены
- ETA определены

**Текущее состояние**: 3.4/5.0 → **Цель**: 4.4/5.0
