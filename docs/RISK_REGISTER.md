# Risk Register

| Risk | Description | Monitoring & Signals | Mitigation & Response |
| --- | --- | --- | --- |
| API contract divergence | Источники (ChEMBL, CrossRef и т.д.) меняют схемы/эндпоинты без обратной совместимости. | * Ежедневные smoke-тесты контрактов в CI с использованием golden payloads.<br>* Мониторинг статусов HTTP/JSON-schema в интеграционных тестах (`tests/integration/pipelines/*`).<br>* Структурные логи (`stage="extract"`) генерируют счётчики `api_response_schema_mismatch`.<br>* `meta.yaml` фиксирует `file_checksums` и идентификаторы схем для аудита. | * Усиление покрытия Pandera-схемами и выпуск hotfix-релизов по PEP 387.<br>* Координация с upstream-командами; переключение feature flags через переопределения конфигурации до восстановления паритета.<br>* Версионирование коннекторов, fallback `partial_retry`, оперативное обновление схем регистри. |
| Cursor drift / pagination gaps | Потеря или дублирование записей при инкрементальной выгрузке из-за устаревших курсоров. | * `meta.yaml` фиксирует `stage_durations_ms`, `sort_keys` и курсор (при наличии).<br>* QC отчёты (`qc_missing_mappings.csv`) отслеживают разрывы.<br>* Алерты в логах `cursor_mismatch` и счётчик Prometheus на событиях `cursor_rewind_detected`. | * Сохранение последних успешных курсоров в метаданных и хранилище.<br>* Автоматический replay недавнего окна при обнаружении; инцидент при дрейфе > 1 страницы.<br>* Сравнение с предыдущим снапшотом (hash-сводки), атомарная запись курсоров, fail-fast при несостыковке количества строк. |
| Unstable units / flaky enrichment | Нестабильные единицы измерения или enrichment-стадии нарушают детерминизм. | * QC dataset metrics (`*_dataset_metrics.csv`) выявляют сдвиги распределений значений.<br>* Еженедельные повторные прогоны golden-тестов, structlog фильтр `stage="enrichment"`.<br>* Алерты детектора выбросов через еженедельные Airflow-проверки. | * Нормализация единиц в процессе transform; поддержание таблицы маппинга в конфигах.<br>* Фиксация входов в S3-кассеты, idempotent enrichment stages.<br>* Автоматическое отключение через feature flag при повторных сбоях.<br>* Документирование конверсий в CHANGELOG и планирование предупреждений об устаревании по PEP 387. |
| Atomic write failures | Сбои файловой системы прерывают атомарную запись, приводя к частичным артефактам. | * Writer логирует `atomic_write_failure` со структурированным контекстом.<br>* Структурные логи `atomic_write` + алерты по отсутствию `manifest`/`meta.yaml`.<br>* CI failure budget мониторит полноту `file_checksums` в `meta.yaml`.<br>* Проверка atomic write в `tests/unit/test_output_writer.py`. | * Все записи через `UnifiedOutputWriter` с ретраями и cleanup.<br>* Использование `AtomicWriter` (`os.replace`), повторный запуск пайплайна при сбое.<br>* Чистка `.tmp_run_*` директорий и валидация checksum.<br>* Проверка детерминированности вывода через сравнение хешей. |

**Review cadence:** Риски пересматриваются ежемесячно на операционных ревью. Каждый риск закреплён за владельцем (Pipeline On-Call). Acceptance criteria требуют наличия активных мониторов и отработанных шагов митигации перед продвижением релиза. Обновления фиксируются в `CHANGELOG.md`.
