# Migration Guide: Activity Pipeline v2.x → v3.0

## Обзор изменений

**Breaking Change:** Activity pipeline переходит с offset-пагинации на batch IDs стратегию для унификации с другими ChEMBL pipelines (assay, testitem, target).

**Версия:** v3.0.0
**Дата:** 2025-01-28
**Приоритет:** CRITICAL

## Что изменилось

### Пагинация

**Было (v2.x):**

```python

# Offset-based pagination

params = {"offset": 0, "limit": 100}
response = api.get("/activity.json", params=params)

# Повтор для следующей страницы

params = {"offset": 100, "limit": 100}

```text

**Стало (v3.0):**

```python

# Batch IDs pagination

activity_ids = input_df["activity_id"].tolist()
batch_ids = activity_ids[0:25]  # batch_size=25

params = {"activity_id__in": ",".join(batch_ids)}
response = api.get("/activity.json", params=params)

```text

### Конфигурация

**Было (v2.x):**

```yaml

sources:
  chembl:
    pagination:
      type: "offset"
      page_size: 100
      max_offset: null  # No limit

```text

**Стало (v3.0):**

```yaml

sources:
  chembl:
    batch_size: 25  # ОБЯЗАТЕЛЬНО ≤ 25

    max_url_length: 2000  # Лимит длины URL

```text

### Кэш

**Было (v2.x):**

```python

Ключ кэша = f"activity:offset_{offset}:limit_{limit}"

```text

**Стало (v3.0):**

```python

Ключ кэша = f"activity:{release}:{activity_id_list_hash}"

```text

## Влияние на данные

### Артефакты вывода

**Ожидаемое:** Бит-в-бит идентичность данных при одинаковом наборе `activity_id` в входных данных.

**Изменения:**

- Порядок строк может отличаться (раньше по offset, теперь по activity_id)

- QC метрики идентичны

- Хеши строк (`hash_row`) могут измениться из-за изменений в NA-policy (см. v3.0-NA-policy.md)

### Метрики производительности

**Ожидаемое улучшение:**

- Количество API запросов: снижение в ~4 раза (25 записей за запрос vs 20-100)

- Время извлечения: снижение на 30-40% для больших наборов

- Кэш hit rate: увеличение на 15-25% (более стабильные ключи кэша)

## План миграции

### Шаг 1: Обновление кода (3-5 дней)

1. **Обновить ActivityPipeline:**

   ```python

   # Изменить метод _extract_from_chembl()

   # Заменить offset-логику на batch IDs

```text

2. **Обновить UnifiedAPIClient:**

   ```python

   # Добавить метод fetch_activities_batch(ids: list[int])

   # Адаптировать POST override для длинных URL

```text

3. **Обновить кэш:**

   ```python

   # Изменить ключи кэша под batch IDs

   # Очистить старый кэш offset-based

```text

### Шаг 2: Тестирование (2-3 дня)

1. **Golden test с старой версией:**

   ```bash

   # v2.x прогон

   python get_activity_data.py --input test_ids.csv --output v2_output/

   # v3.0 прогон

   python get_activity_data.py --input test_ids.csv --output v3_output/

   # Сравнение

   diff v2_output/activity.csv v3_output/activity.csv

```text

2. **Проверка QC метрик:**

   - Отсутствие потерянных записей
   - Совпадение row_count
   - Сравнение quality_report (допустимы изменения в NA-policy)

3. **Регрессионное тестирование:**

   - Крайние случаи (пустой input, 1 ID, 10000+ ID)
   - Network failures, rate limiting
   - Cache invalidation

### Шаг 3: Production deployment (1 день)

1. **Предупреждение пользователей:**

   - Email notification о breaking change
   - Рекомендация перезапустить все activity pipeline после обновления

2. **Phased rollout:**

   - 25% трафика → мониторинг 24 часа
   - 50% трафика → мониторинг 12 часов
   - 100% трафика

3. **Rollback план:**

   - Сохранение v2.x ветки 30 дней
   - Возможность отката через feature flag

## Проблемы и решения

### Проблема 1: Несовместимость кэша

**Симптом:** Высокий cache miss rate после обновления.

**Решение:** Очистка кэша при первом запуске v3.0:

```python

if pipeline_version >= "3.0.0":
    cache_manager.clear_legacy_cache()

```text

### Проблема 2: Разный порядок записей

**Симптом:** Порядок строк в CSV изменился.

**Решение:** Это ожидаемое поведение. Использовать `sort.by = ["activity_id"]` для детерминизма.

### Проблема 3: URL слишком длинные

**Симптом:** HTTP 414 (URI Too Long) для больших батчей.

**Решение:** Использовать POST override (автоматически в UnifiedAPIClient):

```python

if len(url) > max_url_length:

    # Переключение на POST

    headers["X-HTTP-Method-Override"] = "GET"
    response = client.post(endpoint, data=params)

```text

## Чеклист миграции

### Before deployment

- [ ] Код обновлен под batch IDs

- [ ] Golden test пройден успешно

- [ ] QC метрики в пределах нормы

- [ ] Кэш стратегия обновлена

- [ ] Тесты проходят (unit + integration)

- [ ] Документация обновлена

### During deployment

- [ ] Мониторинг API call rate

- [ ] Мониторинг cache hit rate

- [ ] Мониторинг error rate

- [ ] Проверка качества артефактов

- [ ] Сравнение QC отчетов

### After deployment

- [ ] Все pipeline успешно завершились

- [ ] Нет увеличения error rate

- [ ] Производительность в пределах SLA

- [ ] Отсутствие жалоб пользователей

## Контакты для поддержки

- **Архитектор:** [contact info]

- **Tech Lead:** [contact info]

- **Incident Response:** [contact info]

## Ссылки

- [06-activity-data-extraction.md](../06-activity-data-extraction.md) — спецификация нового pipeline

- [03-data-extraction.md](../03-data-extraction.md) — унифицированные стратегии пагинации

- [v3.0-NA-policy.md](./v3.0-NA-policy.md) — миграция NA-policy

- Issue tracker: #[issue number]

---

**Последнее обновление:** 2025-01-28

