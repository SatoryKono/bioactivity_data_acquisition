# Реализация корреляционного анализа для документов

## Обзор

Добавлена поддержка расширенного корреляционного анализа для pipeline документов. Функциональность позволяет анализировать корреляции между различными полями документов и генерировать детальные отчеты.

## Основные возможности

### 1. Типы корреляционного анализа

- **Числовые корреляции**: Пирсон, Спирмен, ковариация
- **Категориальные корреляции**: Cramér's V, таблицы сопряженности, χ² статистика
- **Смешанные корреляции**: Eta-squared, point-biserial correlation
- **Кросс-корреляции**: Лаговые корреляции, скользящие корреляции

### 2. Автоматические инсайты

Система автоматически генерирует инсайты и рекомендации:
- Сильные корреляции (|r| > 0.8) - высокая важность
- Умеренные корреляции (|r| > 0.7) - средняя важность
- Категориальные ассоциации (Cramér's V > 0.5)

### 3. Отчеты

Генерируются следующие типы отчетов:
- `numeric_pearson.csv` - корреляции Пирсона для числовых полей
- `numeric_spearman.csv` - корреляции Спирмена для числовых полей
- `numeric_covariance.csv` - ковариационная матрица
- `categorical_cramers_v.csv` - Cramér's V для категориальных полей
- `mixed_eta_squared.csv` - Eta-squared для смешанных корреляций
- `mixed_point_biserial.csv` - Point-biserial корреляции
- `correlation_summary.csv` - сводная статистика
- `correlation_insights.json` - инсайты и рекомендации

## Конфигурация

### Включение корреляционного анализа

В конфигурационном файле YAML:

```yaml
postprocess:
  correlation:
    enabled: true
```

### Пример полной конфигурации

```yaml
# configs/config_documents_full.yaml
postprocess:
  qc:
    enabled: true
  correlation:
    enabled: true
  journal_normalization:
    enabled: true
  citation_formatting:
    enabled: true
```

## Использование

### Через CLI

```bash
# Использование с конфигурацией, включающей корреляционный анализ
python src\scripts\get_document_data.py get-document-data \
  --config configs/config_documents_full.yaml \
  --all --limit 10 \
  --output-dir data/output/correlation_test
```

### Через демонстрационный скрипт

```bash
python scripts/test_correlation_demo.py
```

## Структура выходных файлов

```
data/output/correlation_test/
├── documents_20251015.csv                    # Основные данные документов
├── documents_20251015_qc.csv                 # QC отчет
└── documents_correlation_report_20251015/    # Корреляционные отчеты
    ├── numeric_pearson.csv
    ├── numeric_spearman.csv
    ├── numeric_covariance.csv
    ├── categorical_cramers_v.csv
    ├── mixed_eta_squared.csv
    ├── mixed_point_biserial.csv
    ├── correlation_summary.csv
    └── correlation_insights.json
```

## Примеры инсайтов

### Критические корреляции (высокая важность)

```json
{
  "type": "strong_correlation",
  "severity": "high",
  "message": "Сильная корреляция между month и pubmed_month_completed: 0.963",
  "recommendation": "Рассмотрите возможность удаления одного из столбцов или создания составного признака"
}
```

### Умеренные корреляции (средняя важность)

```json
{
  "type": "moderate_correlation",
  "severity": "medium",
  "message": "Умеренная корреляция между last_page и volume: 0.749",
  "recommendation": "Мониторьте мультиколлинеарность при построении моделей"
}
```

## Технические детали

### Модифицированные файлы

1. **`src/library/documents/pipeline.py`**
   - Добавлена поддержка корреляционного анализа в `run_document_etl()`
   - Расширен `DocumentETLResult` для хранения корреляционных данных
   - Модифицирован `write_document_outputs()` для сохранения отчетов

2. **`src/library/documents/config.py`**
   - Добавлен `DocumentPostprocessSettings` для конфигурации postprocessing
   - Интегрирован в `DocumentConfig`

3. **`configs/config_documents_full.yaml`**
   - Добавлена секция `postprocess` с включенным корреляционным анализом

### Зависимости

- `numpy` - для численных вычислений
- `scipy.stats` - для статистических тестов
- `sklearn.preprocessing` - для кодирования категориальных данных
- `pandas` - для работы с данными

### Обработка ошибок

- Корреляционный анализ выполняется в try-catch блоке
- При ошибках система продолжает работу без корреляционного анализа
- Предупреждения логируются, но не прерывают выполнение

## Производительность

- Анализ выполняется только при включенной опции в конфигурации
- Обрабатываются только релевантные колонки (исключаются error-колонки)
- Результаты кэшируются в структуре `DocumentETLResult`

## Расширение функциональности

Для добавления новых типов корреляционного анализа:

1. Расширить `EnhancedCorrelationAnalyzer` в `src/library/etl/enhanced_correlation.py`
2. Добавить новые методы анализа
3. Обновить `generate_correlation_reports()` для включения новых отчетов
4. При необходимости обновить конфигурацию

## Тестирование

Создан демонстрационный скрипт `scripts/test_correlation_demo.py` для тестирования функциональности:

- Загружает конфигурацию с включенным корреляционным анализом
- Обрабатывает ограниченный набор документов (10 записей)
- Выводит статистику по найденным корреляциям
- Сохраняет все отчеты в отдельную директорию

## Заключение

Корреляционный анализ документов успешно интегрирован в pipeline и предоставляет:

- Комплексный анализ различных типов корреляций
- Автоматическую генерацию инсайтов и рекомендаций
- Детальные отчеты в удобном формате
- Гибкую конфигурацию через YAML
- Надежную обработку ошибок

Функциональность готова к использованию в продакшене и может быть легко расширена для дополнительных типов анализа.
