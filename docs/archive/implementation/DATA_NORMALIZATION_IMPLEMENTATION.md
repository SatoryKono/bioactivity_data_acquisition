# Реализация нормализации данных

## Обзор

В проект добавлена функциональность автоматической нормализации данных перед
сохранением итоговых таблиц с извлеченными данными. Нормализация выполняется
после добавления столбца `index` и включает обработку строковых, числовых и
логических данных.

## Функциональность нормализации

### Обрабатываемые типы данных

#### 1. Строковые данные (object dtype)

- **Приведение к нижнему регистру**: Все строки конвертируются в нижний регистр

- **Обрезка пробелов**: Удаляются ведущие и концевые пробелы

- **Замена пустых значений**: Пустые строки (`''`, `'   '`) заменяются на `pd.NA`

- **Замена специальных значений**: Строки`'nan'`, `'none'`, `'null'`заменяются на`pd.NA`

- **Замена None**: Значения`None`заменяются на`pd.NA`

#### 2. Числовые данные (numeric dtype)

- **Замена NaN**: Значения`np.nan`заменяются на`pd.NA`

- **Замена бесконечности**: Значения`np.inf`и`-np.inf`заменяются на`pd.NA`

- **Сохранение обычных чисел**: Обычные числовые значения остаются без изменений

#### 3. Логические данные (boolean dtype)

- **Замена NaN**: Значения`np.nan`заменяются на`pd.NA`

- **Сохранение булевых значений**:`True`и`False`остаются без изменений

#### 4. Столбец index

- **Исключение из нормализации**: Столбец`index`не подвергается нормализации

- **Сохранение исходных значений**: Порядковые номера остаются без изменений

## Реализация

### Функция`*normalize*dataframe`

**Файл:**`src/library/etl/load.py`

```

def *normalize*dataframe(df: pd.DataFrame, logger: BoundLogger | None = None) ->
pd.DataFrame:
    """
    Нормализует DataFrame перед сохранением:

    - Строковые переменные: в нижний регистр, обрезка пробелов

    - Пустые ячейки: заполнение NA

    - Числовые данные: нормализация

    - Логические данные: нормализация

    """

```

### Интеграция в пайплайн

Нормализация интегрирована в функцию`write*deterministic*csv`:

```

## Добавляем столбец index с порядковыми номерами строк (начиная с 0)

df*to*write = df*to*write.copy()
df*to*write.insert(0, 'index', range(len(df*to*write)))

## Нормализуем данные перед сохранением

df*to*write = *normalize*dataframe(df*to*write, logger=logger)

```

## Примеры нормализации

### Строковые данные

## Исходные данные:```

compound*id       target        reference
'  CHEMBL1  '     'TARGET1'     'PMID123'
'CHEMBL2'         '  target2  ' '  PMID456  '
'chembl3'         'TARGET3'     'PMID789'
''                'nan'         ''
'   '             'NONE'        'None'
'None'            ''            'PMID012'

```## После нормализации:```

compound*id   target   reference
'chembl1'     'target1' 'pmid123'
'chembl2'     'target2' 'pmid456'
'chembl3'     'target3' 'pmid789'
<NA>          <NA>      <NA>
<NA>          <NA>      <NA>
<NA>          <NA>      'pmid012'

```

### Числовые данные

## Исходные данные:```

activity*value
5.2
nan
7.1
9.4
inf
-inf

```## После нормализации:```

activity*value
5.2
<NA>
7.1
9.4
<NA>
<NA>

```

### Логические данные

## Исходные данные:```

is*active
True
False
nan
True
False
True

```## После нормализации:```

is*active
true
false
<NA>
true
false
true

```

## Тестирование

### Созданные тесты

1.**`tests/test*data*normalization*simple.py`**:

   - Тест нормализации строковых данных

   - Тест нормализации числовых данных

   - Тест сохранения столбца index

   - Тест полного пайплайна с нормализацией

2. **`scripts/test*normalization*simple*demo.py`**:

   - Демонстрационный скрипт с реальными данными

   - Пошаговый анализ нормализации

### Запуск тестов

```

## Простые тесты

python tests/test*data*normalization*simple.py

## Демонстрация

python scripts/test*normalization*simple*demo.py

```

## Преимущества нормализации

### 1. Консистентность данных

- Единообразное представление строковых данных

- Стандартизированные значения для пустых ячеек

### 2. Улучшенное качество данных

- Устранение различий в регистре

- Удаление лишних пробелов

- Замена проблемных значений на стандартные NA

### 3. Упрощение анализа

- Предсказуемый формат данных

- Уменьшение количества вариантов представления одинаковой информации

### 4. Автоматичность

- Не требует вмешательства пользователя

- Работает для всех типов данных

- Интегрировано в существующий процесс

## Совместимость

### Обратная совместимость

✅ **Полная обратная совместимость**:

- Все существующие функции работают без изменений

- Не требуется модификация конфигурационных файлов

- Поддерживаются все форматы вывода (CSV, Parquet)

- Интеграция с существующим пайплайном ETL

### Порядок выполнения

1. **Детерминированный порядок**: Применяется сортировка согласно настройкам
2. **Добавление index**: Вставляется столбец с порядковыми номерами
3. **Нормализация данных**: Применяется нормализация ко всем колонкам кроме
index
4. **Сохранение**: Данные сохраняются в выбранном формате

## Логирование

Функция нормализации поддерживает логирование:

```

if logger is not None:
    logger.info("normalize*start", columns=list(df.columns), rows=len(df))

## ... процесс нормализации

```
logger.info("normalize*complete", columns=list(df_normalized.columns))
```

```

## Заключение

Нормализация данных обеспечивает консистентность и качество итоговых таблиц,
автоматически обрабатывая различные проблемы с данными и приводя их к единому
стандарту. Функциональность полностью интегрирована в существующий пайплайн и
работает прозрачно для пользователя.
