# Чек-лист постпроцессинга документов

## Обзор

Данный чек-лист обеспечивает полное покрытие всех этапов постпроцессинга документов и гарантирует качество выходных данных. Каждый пункт должен быть проверен и отмечен как выполненный перед завершением процесса.

## Предварительные проверки

### Конфигурация
- [ ] Конфигурационный файл `configs/postprocess_documents.example.yaml` загружен и валиден
- [ ] Все обязательные параметры настроены
- [ ] Пути к входным и выходным файлам корректны
- [ ] Настройки логирования настроены
- [ ] Пороги QC соответствуют требованиям проекта

### Входные данные
- [ ] Входной CSV файл с документами существует и доступен для чтения
- [ ] CSV файл содержит обязательные колонки: `document_chembl_id`, `title`
- [ ] Количество записей во входном файле соответствует ожиданиям
- [ ] Нет критических ошибок в структуре входных данных

### Окружение
- [ ] Все необходимые Python пакеты установлены
- [ ] Pandera схемы доступны и валидны
- [ ] Внешние API доступны (если требуется)
- [ ] Достаточно места на диске для выходных файлов

## Шаги постпроцессинга

### P01_normalize_keys (Нормализация ключей)

**Входные данные:**
- [ ] `document_chembl_id` — присутствует в 100% записей
- [ ] `doi` — доступен для нормализации
- [ ] `document_pubmed_id` — доступен для нормализации

**Обработка:**
- [ ] DOI нормализованы с удалением префиксов `https://doi.org/`
- [ ] DOI приведены к нижнему регистру
- [ ] DOI обрезаны от пробелов
- [ ] PMID нормализованы (lowercase, trim)
- [ ] Созданы поля `doi_key` и `pmid_key`

**Выходные данные:**
- [ ] Количество нормализованных DOI соответствует ожиданиям
- [ ] Количество нормализованных PMID соответствует ожиданиям
- [ ] Нет критических ошибок нормализации

**Логирование:**
- [ ] Записано количество обработанных строк
- [ ] Записана статистика нормализации DOI
- [ ] Записана статистика нормализации PMID
- [ ] Время выполнения шага зафиксировано

### P02_merge_bibliography (Слияние библиографии)

**Входные данные:**
- [ ] Данные из ChEMBL доступны
- [ ] Данные из Crossref доступны
- [ ] Данные из OpenAlex доступны
- [ ] Данные из PubMed доступны
- [ ] Данные из Semantic Scholar доступны

**Обработка:**
- [ ] Применен приоритет источников: ChEMBL > PubMed > Crossref > OpenAlex > Semantic Scholar
- [ ] Конфликты метаданных разрешены детерминированно
- [ ] Непустые значения выбраны согласно приоритету
- [ ] Создан лог конфликтов (если включен)

**Выходные данные:**
- [ ] Каждое поле имеет максимум одно непустое значение
- [ ] Приоритет источников соблюден
- [ ] Количество конфликтов в пределах нормы

**Логирование:**
- [ ] Записано количество конфликтов при слиянии
- [ ] Записана статистика использования каждого источника
- [ ] Время выполнения шага зафиксировано

### P03_dedupe_and_conflicts (Дедупликация и разрешение конфликтов)

**Входные данные:**
- [ ] `document_chembl_id` уникален
- [ ] `doi_key` доступен для дедупликации
- [ ] `pmid_key` доступен для дедупликации
- [ ] `title` доступен для проверки похожести

**Обработка:**
- [ ] Удалены дубли по `document_chembl_id`
- [ ] Проверена похожесть заголовков (порог 92%)
- [ ] Разрешены конфликты метаданных
- [ ] Создан отчет о причинах удаления

**Выходные данные:**
- [ ] Все записи уникальны по `document_chembl_id`
- [ ] Количество удаленных дублей в пределах нормы
- [ ] Похожие заголовки идентифицированы и обработаны

**Логирование:**
- [ ] Записано количество удаленных дублей
- [ ] Записано количество разрешенных конфликтов
- [ ] Записано количество найденных похожих заголовков
- [ ] Время выполнения шага зафиксировано

### P04_enrich_fields (Обогащение полей)

**Входные данные:**
- [ ] `journal` — названия журналов доступны
- [ ] `year` — годы публикации доступны
- [ ] `title` — заголовки доступны
- [ ] `volume`, `issue`, `first_page`, `last_page` — библиографические данные доступны

**Обработка:**
- [ ] Журналы нормализованы через `normalize_journal_name()`
- [ ] Годы преобразованы в строковое представление
- [ ] Заголовки нормализованы (lowercase, trim)
- [ ] Созданы литературные ссылки через `format_citation()`

**Выходные данные:**
- [ ] `journal_normalized` — нормализованные названия журналов
- [ ] `year_str` — строковые представления годов
- [ ] `title_norm` — нормализованные заголовки
- [ ] `document_citation` — форматированные литературные ссылки

**Логирование:**
- [ ] Записано количество нормализованных журналов
- [ ] Записано количество сгенерированных цитат
- [ ] Время выполнения шага зафиксировано

### P05_qc_validation (Валидация QC)

**Входные данные:**
- [ ] Все обработанные поля доступны
- [ ] Pandera схемы загружены
- [ ] QC пороги настроены

**Обработка:**
- [ ] Выполнена валидация полей через `validate_all_fields()`
- [ ] Применена Pandera схема `DocumentOutputSchema`
- [ ] Выполнены QC проверки:
  - [ ] Полнота обязательных ключей
  - [ ] Уникальность первичных ключей
  - [ ] Диапазоны значений (год, страницы)
  - [ ] Референциальная целостность
  - [ ] Детерминированные проверки

**Выходные данные:**
- [ ] `valid_*` — валидированные значения полей
- [ ] `invalid_*` — флаги невалидности
- [ ] QC отчет с метриками качества

**Логирование:**
- [ ] Записано количество ошибок валидации
- [ ] Записаны метрики качества данных
- [ ] Записаны нарушения схемы Pandera
- [ ] Время выполнения шага зафиксировано

### P06_deterministic_export (Детерминированный экспорт)

**Входные данные:**
- [ ] Все обработанные и валидированные данные доступны
- [ ] Настройки детерминизма настроены
- [ ] Выходные пути доступны

**Обработка:**
- [ ] Данные отсортированы по `['document_chembl_id', 'doi_key']`
- [ ] Колонки упорядочены согласно `determinism.column_order`
- [ ] Применена политика NA значений
- [ ] Экспорт в CSV выполнен
- [ ] Экспорт в Parquet выполнен
- [ ] Создан файл метаданных

**Выходные данные:**
- [ ] `documents.csv` — CSV с детерминированным порядком
- [ ] `documents.parquet` — Parquet как эталон типов данных
- [ ] `documents_meta.json` — метаданные о процессе

**Логирование:**
- [ ] Записано количество экспортированных строк
- [ ] Записано количество экспортированных колонок
- [ ] Записаны размеры созданных файлов
- [ ] Время выполнения шага зафиксировано

## Контроль качества

### Базовые QC проверки
- [ ] **Полнота ключей:**
  - [ ] `document_chembl_id` присутствует в 100% записей
  - [ ] `doi` или `document_pubmed_id` присутствует в >95% записей
  - [ ] `title` присутствует в >98% записей

- [ ] **Уникальность:**
  - [ ] `document_chembl_id` уникален (0 дублей)
  - [ ] `doi_key` уникален среди непустых значений
  - [ ] `pmid_key` уникален среди непустых значений

- [ ] **Диапазоны значений:**
  - [ ] Годы публикации в диапазоне 1800-2030
  - [ ] `first_page` > 0
  - [ ] `last_page` >= `first_page`
  - [ ] `last_page` < 10000

- [ ] **Референциальная целостность:**
  - [ ] DOI имеют валидный формат
  - [ ] PMID имеют валидный формат
  - [ ] Связи с внешними таблицами корректны

### Расширенные QC проверки
- [ ] **Детерминизм:**
  - [ ] Порядок колонок соответствует схеме
  - [ ] Количество строк стабильно между запусками
  - [ ] Нет лишних или отсутствующих колонок

- [ ] **Статистические проверки:**
  - [ ] Распределение данных соответствует ожиданиям
  - [ ] Нет аномальных выбросов
  - [ ] Корреляции между полями в пределах нормы

### Pandera валидация
- [ ] Схема `DocumentOutputSchema` применена успешно
- [ ] Все типы данных соответствуют схеме
- [ ] Все ограничения схемы соблюдены
- [ ] Нет нарушений валидации

### Пороги качества
- [ ] Доля невалидных DOI < 10%
- [ ] Доля невалидных журналов < 15%
- [ ] Доля лет вне диапазона < 1%
- [ ] Доля ошибок страниц < 5%
- [ ] Общий балл качества данных > 85

## CLI и интеграция

### Команда выполнения
- [ ] Команда `etl documents postprocess` выполнена успешно
- [ ] Все обязательные параметры переданы
- [ ] Конфигурационный файл загружен
- [ ] Выходная директория создана

### Возврат кодов
- [ ] Код возврата 0 (успех) или соответствующий код ошибки
- [ ] Ошибки валидации возвращают код 1
- [ ] Ошибки HTTP возвращают код 2
- [ ] Ошибки QC возвращают код 3
- [ ] Ошибки ввода-вывода возвращают код 4

### Флаги и опции
- [ ] `--config` — путь к конфигурации указан
- [ ] `--output` — выходная директория указана
- [ ] `--qc-report` — QC отчет сгенерирован (если указан)
- [ ] `--format` — формат вывода применен
- [ ] `--fail-on-qc` — остановка при ошибках QC работает

## Логирование

### Формат логов
- [ ] Логи в JSON формате
- [ ] Поля контекста присутствуют:
  - [ ] `run_id` — уникальный идентификатор запуска
  - [ ] `step` — текущий шаг постпроцессинга
  - [ ] `elapsed_ms` — время выполнения
  - [ ] `rows_processed` — количество обработанных строк

### Ротация файлов
- [ ] Файл логов не превышает максимальный размер
- [ ] Резервные файлы создаются корректно
- [ ] Старые логи удаляются согласно настройкам

### Уровни логирования
- [ ] INFO уровень для основных операций
- [ ] WARNING для потенциальных проблем
- [ ] ERROR для критических ошибок
- [ ] DEBUG для детальной отладки (если включен)

## Финальные проверки

### Выходные файлы
- [ ] `documents.csv` создан и доступен для чтения
- [ ] `documents.parquet` создан и доступен для чтения
- [ ] `documents_meta.json` создан и содержит корректные метаданные
- [ ] QC отчеты созданы (если включены)
- [ ] Корреляционные отчеты созданы (если включены)

### Размеры файлов
- [ ] Размер CSV файла соответствует ожиданиям
- [ ] Размер Parquet файла разумный (обычно меньше CSV)
- [ ] Файлы не пустые и не повреждены

### Содержимое данных
- [ ] Количество строк в выходных файлах соответствует входным (минус дубли)
- [ ] Количество колонок соответствует схеме
- [ ] Типы данных сохранены корректно (особенно в Parquet)
- [ ] Кодировка UTF-8 применена корректно

### Метаданные
- [ ] `documents_meta.json` содержит:
  - [ ] Временную метку выполнения
  - [ ] Количество обработанных записей
  - [ ] Статистику по источникам
  - [ ] Информацию о QC проверках
  - [ ] Версию схемы данных

## Definition of Done

Все пункты чек-листа выполнены и отмечены как завершенные:

- [ ] **Все QC-чеки пройдены** — все пороги качества соблюдены
- [ ] **Экспорт детерминирован** — порядок колонок и строк фиксирован
- [ ] **CLI возвращает 0** — команда выполнена без ошибок
- [ ] **Логи содержат run_id и метрики** — полное логирование выполнено
- [ ] **Версия схемы синхронизирована** — документация соответствует коду

## Подпись

**Дата выполнения:** _______________

**Исполнитель:** _______________

**Проверяющий:** _______________

**Статус:** [ ] ПРОЙДЕН [ ] НЕ ПРОЙДЕН

**Комментарии:**
```
