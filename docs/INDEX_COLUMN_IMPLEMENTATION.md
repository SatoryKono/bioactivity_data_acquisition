# Реализация столбца Index

## Обзор

В проект добавлена функциональность автоматического добавления столбца `index` с порядковыми номерами строк (начиная с 0) при сохранении итоговых таблиц с извлеченными данными.

## Изменения

### 1. Обновление функции `write_deterministic_csv`

**Файл:** `src/library/etl/load.py`

В функцию `write_deterministic_csv` добавлен код для автоматического добавления столбца `index`:

```python
if df.empty:
    df_to_write = df.copy()
else:
    df_to_write = _deterministic_order(df, determinism)
    
    # Добавляем столбец index с порядковыми номерами строк (начиная с 0)
    df_to_write = df_to_write.copy()
    df_to_write.insert(0, 'index', range(len(df_to_write)))
```

### 2. Улучшение функции `_deterministic_order`

**Файл:** `src/library/etl/load.py`

Функция `_deterministic_order` была улучшена для корректной обработки случаев, когда колонки для сортировки отсутствуют в данных:

```python
# Фильтруем колонки для сортировки, оставляя только существующие
sort_by = [col for col in (determinism.sort.by or ordered.columns.tolist()) if col in df.columns]

# Если нет колонок для сортировки, возвращаем DataFrame как есть
if not sort_by:
    return ordered.reset_index(drop=True)
```

## Функциональность

### Что происходит при сохранении данных:

1. **Обработка пустых DataFrame**: Если DataFrame пустой, столбец `index` не добавляется
2. **Детерминированный порядок**: Данные сортируются согласно настройкам детерминизма (если возможно)
3. **Добавление index**: В начало таблицы добавляется столбец `index` с порядковыми номерами от 0 до (количество_строк - 1)
4. **Сохранение**: Данные сохраняются в выбранном формате (CSV или Parquet)

### Пример результата:

**Исходные данные:**
```
compound_id   target  activity_value activity_type reference
CHEMBL1      TARGET1             5.2          IC50   PMID123
CHEMBL2      TARGET2             7.1          EC50   PMID456
CHEMBL3      TARGET1             3.8          IC50   PMID789
CHEMBL4      TARGET3             9.4            Ki   PMID012
```

**Результат после добавления index:**
```
index compound_id   target  activity_value activity_type reference
    0     CHEMBL1  TARGET1             5.2          IC50   PMID123
    1     CHEMBL2  TARGET2             7.1          EC50   PMID456
    2     CHEMBL3  TARGET1             3.8          IC50   PMID789
    3     CHEMBL4  TARGET3             9.4            Ki   PMID012
```

## Тестирование

### Тесты

Созданы тесты для проверки функциональности:

- **`tests/test_index_column_simple.py`**: Простые тесты для проверки добавления столбца `index`
- **`scripts/test_index_column_demo.py`**: Демонстрационный скрипт с реальными данными

### Запуск тестов

```bash
# Простые тесты
python tests/test_index_column_simple.py

# Демонстрация
python scripts/test_index_column_demo.py
```

## Совместимость

### Обратная совместимость

- ✅ Все существующие функции продолжают работать без изменений
- ✅ Столбец `index` добавляется автоматически, не требует изменения конфигурации
- ✅ Поддерживаются все форматы вывода (CSV, Parquet)

### Интеграция с существующим кодом

Столбец `index` добавляется в функции `write_deterministic_csv`, которая используется во всех местах сохранения итоговых данных:

- `src/library/etl/run.py` - основная функция пайплайна
- Любые другие места, где вызывается `write_deterministic_csv`

## Преимущества

1. **Уникальная идентификация строк**: Каждая строка получает уникальный порядковый номер
2. **Ссылочная целостность**: Возможность ссылаться на конкретные строки по номеру
3. **Удобство для анализа**: Простота работы с данными в аналитических инструментах
4. **Автоматичность**: Не требует дополнительной настройки или вмешательства пользователя

## Использование

Столбец `index` добавляется автоматически при каждом сохранении данных через пайплайн. Никаких дополнительных действий не требуется.

### Пример использования в анализе:

```python
import pandas as pd

# Загрузка данных с индексом
df = pd.read_csv('output/documents_20250115.csv')

# Ссылка на конкретную строку
specific_row = df[df['index'] == 42]

# Группировка по диапазонам индексов
first_hundred = df[df['index'] < 100]
```

## Заключение

Добавление столбца `index` улучшает структуру данных и упрощает работу с результатами пайплайна извлечения биоактивных данных, обеспечивая уникальную идентификацию каждой строки в итоговых таблицах.
