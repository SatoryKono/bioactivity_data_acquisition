# Batch Processing Configuration

Этот документ описывает настройку и использование batch обработки в различных пайплайнах системы извлечения биоактивных данных.

## Обзор

Batch обработка позволяет эффективно обрабатывать большие объемы данных, разбивая их на управляемые части. Это улучшает производительность, контроль памяти и надежность системы.

## Поддерживаемые пайплайны

### 1. Assay Pipeline (`get_assay_data`)

**Статус**: ✅ Полностью реализован

**Особенности**:
- Использует `fetch_assays_batch_streaming()` API
- Настраиваемый `batch_size` через конфигурацию
- Streaming обработка для экономии памяти

**Конфигурация**:
```yaml
runtime:
  batch_size: 100  # Количество ассев в одном батче
```

**Рекомендуемые значения**:
- Для небольших наборов (< 1000): `batch_size: 50`
- Для средних наборов (1000-10000): `batch_size: 100`
- Для больших наборов (> 10000): `batch_size: 200`

### 2. Activity Pipeline (`get_activity_data`)

**Статус**: ✅ Полностью реализован

**Особенности**:
- Использует `fetch_activities_batch()` с chunk_size = 200
- Автоматическая пагинация
- Кэширование результатов

**Конфигурация**:
```yaml
runtime:
  limit: 1000  # Максимальное количество активностей
```

**Рекомендации**:
- Chunk size фиксирован на 200 для оптимальной производительности
- Используйте `limit` для контроля общего объема данных

### 3. Testitem Pipeline (`get_testitem_data`)

**Статус**: ✅ Оптимизирован (обновлено)

**Особенности**:
- Использует `fetch_molecules_batch_streaming()` API
- Отдельные настройки для ChEMBL и PubChem
- Streaming обработка для экономии памяти

**Конфигурация**:
```yaml
runtime:
  batch_size: 50        # ChEMBL batch size
  pubchem_batch_size: 100  # PubChem batch size
```

**Рекомендуемые значения**:
- ChEMBL `batch_size`: 25-50 (ограничения API)
- PubChem `batch_size`: 50-100 (rate limiting: 5 req/sec)

### 4. Document Pipeline (`get_document_data`)

**Статус**: ✅ Полностью реализован

**Особенности**:
- Использует `_batch_dataframe()` для разбиения данных
- `_extract_data_from_source_batch()` для каждого источника
- Поддержка множественных источников данных

**Конфигурация**:
```yaml
runtime:
  batch_size: 100  # Количество документов в одном батче
```

**Рекомендуемые значения**:
- Для источников с высоким rate limiting: `batch_size: 50`
- Для быстрых источников: `batch_size: 100-200`

## Настройка batch_size

### Общие принципы

1. **Меньше = стабильнее**: Меньшие батчи более устойчивы к сбоям
2. **Больше = быстрее**: Большие батчи эффективнее при стабильном соединении
3. **Учитывайте лимиты API**: Некоторые API имеют ограничения на размер запроса

### Факторы выбора batch_size

#### ChEMBL API
- **URL длина**: Максимум ~25 молекул в одном запросе
- **Rate limiting**: 1 запрос в секунду
- **Рекомендация**: `batch_size: 25-50`

#### PubChem API
- **Rate limiting**: 5 запросов в секунду
- **Timeout**: 30 секунд на запрос
- **Рекомендация**: `batch_size: 50-100`

#### Semantic Scholar API
- **Rate limiting**: 1 запрос в минуту (без API ключа)
- **С API ключом**: 100 запросов в минуту
- **Рекомендация**: `batch_size: 10-50`

#### OpenAlex API
- **Rate limiting**: 10 запросов в секунду
- **Рекомендация**: `batch_size: 100-200`

## Мониторинг производительности

### Логирование

Все пайплайны логируют информацию о batch обработке:

```
INFO: Using streaming batch processing with batch_size=100
INFO: Processing ChEMBL batch 1: 100 molecules
INFO: Batch 1 completed: 95 records
INFO: ChEMBL extraction completed: 950 records from 10 batches
```

### Метрики для отслеживания

1. **Время обработки батча**: Должно быть относительно стабильным
2. **Успешность батчей**: Процент успешно обработанных батчей
3. **Использование памяти**: Контроль через streaming обработку

## Troubleshooting

### Частые проблемы

#### 1. Timeout ошибки
```
Error: Request timeout after 60 seconds
```
**Решение**: Уменьшите `batch_size`

#### 2. Rate limiting
```
Error: 429 Too Many Requests
```
**Решение**: Уменьшите `batch_size` или увеличьте задержки

#### 3. Memory issues
```
Error: Out of memory
```
**Решение**: Убедитесь, что используется streaming API

### Диагностика

1. **Проверьте логи**: Ищите сообщения о batch обработке
2. **Мониторьте производительность**: Время обработки батчей
3. **Тестируйте разные размеры**: Найдите оптимальный `batch_size`

## Примеры конфигурации

### Высокая производительность
```yaml
runtime:
  batch_size: 200
  timeout_sec: 120
  retries: 3
```

### Стабильная работа
```yaml
runtime:
  batch_size: 50
  timeout_sec: 60
  retries: 5
```

### Консервативная настройка
```yaml
runtime:
  batch_size: 25
  timeout_sec: 30
  retries: 10
```

## Заключение

Batch обработка является ключевым компонентом для эффективной работы с большими объемами данных. Правильная настройка `batch_size` критически важна для баланса между производительностью и стабильностью.

Рекомендуется начинать с консервативных значений и постепенно увеличивать их при стабильной работе системы.
