# Проверка лимитов API

Этот документ описывает, как проверить лимиты и доступность API, используемых в проекте bioactivity_data_acquisition.

## Доступные скрипты

### 1. Полная проверка всех API (`src/library/scripts/check_api_limits.py`)

Проверяет все API из конфигурации и создает детальный отчет.

```bash
python src/library/scripts/check_api_limits.py
```

**Что проверяется:**

- Доступность каждого API

- Время ответа

- Статус коды

- Заголовки rate limiting

- Ошибки подключения

**Результат:**

- Таблица с результатами в консоли

- JSON файл с детальными результатами в папке `reports/`

### 2. Детальная проверка лимитов (`src/library/scripts/check_specific_limits.py`)

Показывает детальную информацию о лимитах каждого API с рекомендациями.

```bash
python src/library/scripts/check_specific_limits.py
```

**Что показывается:**

- Лимиты для каждого API

- Статус доступности

- Рекомендации по оптимизации

- Информация об аутентификации

### 3. Быстрая проверка конкретного API (`src/library/scripts/quick_api_check.py`)

Проверяет один конкретный API с минимальным выводом.

```bash
python src/library/scripts/quick_api_check.py [api_name]
```

**Доступные API:**

- `chembl` - ChEMBL API

- `pubmed` - PubMed API  

- `crossref` - Crossref API

- `openalex` - OpenAlex API

- `semantic` - Semantic Scholar API

**Примеры:**

```bash
python src/library/scripts/quick_api_check.py crossref
python src/library/scripts/quick_api_check.py pubmed
```

## Анализ результатов

### Статусы API

- **Available** - API доступен и работает нормально

- **Rate Limited** - API ограничивает количество запросов (код 429)

- **Auth Required** - Требуется аутентификация (коды 401/403)

- **Server Error** - Ошибка сервера (коды 5xx)

- **Timeout** - Превышен таймаут запроса

- **Connection Error** - Ошибка подключения к API

### Лимиты по API

| API | Лимит (запросов/сек) | Аутентификация | Рекомендации |

|-----|---------------------|----------------|--------------|

| **ChEMBL** | 20 | Не требуется | Используйте пагинацию |

| **PubMed** | 3 (без ключа), 10 (с ключом) | API ключ опционален | Получите API ключ |

| **Crossref** | 50 (free), 100 (plus) | Plus API Token | Рассмотрите Plus токен |

| **OpenAlex** | 10 | Не требуется | Контролируйте размер ответов |

| **Semantic Scholar** | 100 | Не требуется | Самый либеральный API |

## Рекомендации по оптимизации

### 1. Общие рекомендации

- **Мониторинг**: Регулярно проверяйте статус API

- **Кэширование**: Сохраняйте результаты часто используемых запросов

- **Backoff**: Реализуйте экспоненциальную задержку при ошибках 429

- **Логирование**: Записывайте все API запросы для анализа

### 2. Специфичные рекомендации

#### ChEMBL API

- Используйте параметр `limit` для контроля размера ответа

- Мониторьте заголовки ответов на предмет rate limiting

- Кэшируйте результаты поиска по документам

#### PubMed API

- Получите API ключ для увеличения лимитов

- Используйте batch запросы когда возможно

- Добавьте задержки между запросами (минимум 0.1 сек)

#### Crossref API

- Рассмотрите получение Plus API Token

- Используйте фильтры для уменьшения размера ответов

- Кэшируйте результаты поиска

#### OpenAlex API

- Используйте параметр `per-page` для контроля размера ответа

- Мониторьте использование через заголовки ответов

#### Semantic Scholar API

- Самый либеральный API с лимитом 100 запросов/сек

- Подходит для массовых запросов

### 3. Обработка ошибок

```python
# Пример обработки rate limiting

if response.status_code == 429:
    retry_after = response.headers.get('Retry-After', 60)
    time.sleep(int(retry_after))

# Пример обработки временных ошибок

if response.status_code >= 500:
    # Повторить запрос через некоторое время
    time.sleep(2 ** attempt_number)
```

## Мониторинг в продакшене

### 1. Регулярные проверки

Рекомендуется запускать проверку лимитов API регулярно:

```bash
# Ежедневная проверка

python src/library/scripts/check_api_limits.py

# Проверка конкретного API при проблемах

python src/library/scripts/quick_api_check.py crossref
```

### 2. Алерты

Настройте мониторинг на:

- Увеличение времени ответа API

- Увеличение количества ошибок 429

- Недоступность критичных API

### 3. Логирование

Все результаты проверок сохраняются в папке `reports/` в формате JSON для дальнейшего анализа.

## Устранение проблем

### API недоступен

1. Проверьте подключение к интернету
2. Убедитесь, что API не заблокирован файрволом
3. Проверьте статус API на официальном сайте

### Rate Limited (429 ошибки)

1. Увеличьте интервалы между запросами
2. Получите API ключ для увеличения лимитов
3. Реализуйте экспоненциальный backoff

### Ошибки аутентификации (401/403)

1. Проверьте правильность API ключей
2. Убедитесь, что ключи не истекли
3. Проверьте права доступа для ключа

### Медленные ответы

1. Проверьте размер запросов
2. Используйте фильтры для уменьшения данных
3. Рассмотрите кэширование результатов
