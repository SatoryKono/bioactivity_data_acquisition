> **Note**: Implementation status: **planned**. All file paths referencing `src/bioetl/` in this document describe the intended architecture and are not yet implemented in the codebase.

Промт: «Архитектура источников: клиенты, пагинация, парсеры, нормализаторы»
Роль и режим работы

Ты — системный аналитик ETL и разработчик. Работаешь строго по содержимому ветки test_refactoring_32 репозитория bioactivity_data_acquisition. Никаких внешних домыслов. Все ссылки указывай строго так:

[ref: repo:<path>@refactoring_001]

Обязательные внутренние источники

README с описанием каркаса, стадий и того, что «каждый источник реализует клиентов, пагинацию, парсеры и нормализаторы с Pandera-схемами». Также тут даны команды CLI и список пайплайнов. Используй как рамку и перечень сущностей.
GitHub

Карта документации (INDEX, requirements, pipelines, configs, cli, qc) для сквозной навигации из нового раздела.
GitHub

Исходники в src/bioetl/* для извлечения реальных интерфейсов и инвариантов (клиенты, парсеры, нормализаторы, схемы, регистрация CLI).

Задача

Подготовь нормативную спецификацию архитектурного стека источников: «клиент → пагинация → парсер → нормализатор → Pandera-схема → валидация → запись».
Документ должен дать:

единые интерфейсы и инварианты на каждом уровне;

матрицу реализации по всем источникам/пайплайнам;

правила ошибок, ретраев, детерминизма и логирования;

ссылки на конкретные модули/классы/функции в репозитории.

Что нужно выдать

docs/sources/00-sources-architecture.md — полная спецификация стека и инвариантов.

docs/sources/INTERFACE_MATRIX.md — матрица источников и реализаций.

Если в коде нет явного базового протокола какого-то слоя, включи в документ рекомендованный интерфейс с пометкой «проектный контракт», не противоречащей текущей реализации.

Структура содержания для 00-sources-architecture.md
01. Обзор

Роль стека «клиент → пагинация → парсер → нормализатор → схема» в каркасе PipelineBase и интеграция с CLI. Укажи, что пайплайны объявлены в README и исполняются через python -m bioetl.cli.main <pipeline>.
GitHub

1. Интерфейсы и инварианты слоёв

Опиши минимальные контрактные методы и инварианты. Пример формата:

HTTP/DB-клиент

request(query|params|cursor) -> Response

Инварианты: строгие таймауты, единые заголовки, backoff/ретраи, чтение Retry-After, логирование endpoint/attempt/duration_ms.

Пагинация: поддержка page/size или offset/limit, курсоры next.

Пагинатор

iterate(client, first_request) -> Iterable[Response]

Инварианты: корректный стоп-критерий, задержки при RPS-лимитах, защита от повторов.

Парсер

parse(Response) -> Iterable[dict]

Инварианты: строгое соответствие ожидаемому JSON/CSV-формату, явные ошибки при отсутствующих полях, отсутствие побочных эффектов.

Нормализатор

normalize(row: dict) -> dict и/или normalize_many(rows) -> Iterable[dict]

Инварианты: каноникализация типов/идентификаторов, заполнение обязательных полей, запрет «скрытого» изменения бизнес-ключей.

Pandera-схема/валидация

validate(df) -> df в строгом режиме: фиксирован порядок колонок, типы, композиционная уникальность бизнес-ключа, DataFrame-проверки.

Инварианты: strict/ordered/coerce как в проектной политике.

Выход/детерминизм

Стабильные сорт-ключи перед записью, расчёт hash_row и hash_business_key, генерация meta.yaml.

Логи стадии и итоговые счётчики.

Для каждого слоя сошлись на файлах/классах в src/bioetl/... и точках подключения через CLI/конфиги, как заявлено в README.
GitHub

1. Матрица интерфейсов и реализаций

В отдельном файле INTERFACE_MATRIX.md выдай таблицу вида:

Источник    CLI команда Клиент (модуль/класс)   Пагинация   Парсер  Нормализатор    Схема/валидация Бизнес-ключ Сорт-ключи  Ошибки/ретраи   Тесты
ChEMBL Activity bioetl.cli.main activity    [ref: repo:src/bioetl/...@refactoring_001]  page/size или cursor    [ref: repo:src/bioetl/...@refactoring_001]  [ref: repo:src/bioetl/...@refactoring_001]  [ref: repo:src/bioetl/...@refactoring_001]  перечисли поля  стабильные поля классы/статусы  [ref: repo:tests/...@refactoring_001]
ChEMBL Assay    …   …   …   …   …   …   …   …   …   …
ChEMBL Target   …   …   …   …   …   …   …   …   …   …
ChEMBL Document …   …   …   …   …   …   …   …   …   …
ChEMBL TestItem …   …   …   …   …   …   …   …   …   …

Список пайплайнов и их CLI-команд подтверди ссылкой на README.
GitHub

1. Взаимодействие со схемами и политикой детерминизма

Где в цепочке вызывается Pandera-валидация, как схема привязана к нормализатору.

Как сорт-ключи/хэши и meta.yaml фиксируют воспроизводимость (синхронизируй с проектной политикой детерминизма).

1. Обработка ошибок и ретраи

Единая таксономия исключений для клиента/пагинации/парсера.

Ретраи по статусам/исключениям, приоритет Retry-After.

Лог-поля, обязательные для HTTP-событий: endpoint, attempt, retry_after, duration_ms, trace_id и контекст запуска.

1. Интеграция с CLI и конфигами

Как команды Typer поднимают стек источника и применяют профили (base.yaml, determinism.yaml) и конфиг пайплайна.

Покажи, где в документации CLI будет ссылка на текущий файл (перекрёстная навигация). README уже содержит точку входа в раздел CLI и Configs.
GitHub

1. Примеры (минимум)

Мини-трейс на ChEMBL Activity: клиентский запрос страницы, парсинг, нормализация строки, валидация схемой, упоминание сорт-ключей перед записью.

Пример для источника с курсорной пагинацией, если отличается.

1. Тест-план

Контрактные тесты парсеров на референс-ответы, покрытие ошибок формата.

Тест пагинации на граничные условия (последняя страница/пустой ответ).

Интеграция: прогон полного стека до validate, сверка бизнес-ключей и отсутствия дублей.

Golden-тест на стабильный порядок колонок и сериализацию.

Жёсткие требования (MUST)

Использовать только артефакты из ветки test_refactoring_32; все ссылки — вида [ref: repo:<path>@refactoring_001].

В INTERFACE_MATRIX.md перечислить все поддерживаемые пайплайны, как указано в README (Activity, Assay, Target, Document, TestItem), с их CLI-командами и путями к конфигам.
GitHub

Для каждого слоя стека зафиксировать: публичные методы, ожидаемые типы I/O, инварианты, точки расширения, правила ошибок/логов.

Матрица должна быть синхронизирована с реальными модулями/классами; «пустых» ссылок быть не должно.

Документ добавить в оглавление docs/INDEX.md и связать со страницами CLI/Configs/QC.

Форматирование

Язык: русский.

Короткие код-блоки, таблицы, чек-листы инвариантов.

Без воды. Если в коде чего-то нет — блок помечается как «к внедрению» и не маскируется под существующее.
