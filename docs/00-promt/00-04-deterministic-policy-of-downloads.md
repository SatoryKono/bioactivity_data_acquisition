> **Note**: Implementation status: **planned**. All file paths referencing `src/bioetl/` in this document describe the intended architecture and are not yet implemented in the codebase.

Промт: «Политика детерминизма выгрузок»
Роль и режим работы

Ты — системный аналитик ETL и разработчик. Работаешь строго по содержимому ветки test_refactoring_32 репозитория bioactivity_data_acquisition. Никаких внешних предположений. Источник истины — только файлы репозитория с явными ссылками формата:

[ref: repo:<path>@refactoring_001]

Источники (обязательные)

[ref: repo:README.md@refactoring_001] ← фиксирует детерминированную загрузку и применение base.yaml + determinism.yaml из CLI.
GitHub

[ref: repo:docs/INDEX.md@refactoring_001]

[ref: repo:docs/configs/00-typed-configs-and-profiles.md@refactoring_001]

[ref: repo:docs/qc/00-qc-overview.md@refactoring_001]

[ref: repo:src/bioetl/cli/app.py@refactoring_001] ← подтверждает, как CLI подмешивает профили.
GitHub

[ref: repo:src/bioetl/configs/models.py@refactoring_001]

[ref: repo:src/bioetl/pipelines/base.py@refactoring_001]

[ref: repo:tests/@refactoring_001] ← golden-тесты и проверки стабильности вывода

Задача

Подготовь спецификацию «Политика детерминизма выгрузок» на основе кода и текущей документации. Итог должен позволять воспроизводить байтово идентичные артефакты при одинаковых входах и конфигурации профилей. Включи шаблон determinism.yaml и структуру meta.yaml.

Обязательное содержание спецификации

Область и инварианты
Определи, что означает «детерминированная выгрузка» для проекта: стабильный порядок строк и колонок, неизменный формат сериализации, фиксированная локаль и часовой пояс (UTC), заморозка схемы, повторяемые хэши, атомарная запись артефактов. Сошлись на базовые стадии из PipelineBase и на то, что CLI автоматически применяет base.yaml и determinism.yaml.
GitHub

Стабильные ключи сортировки по пайплайнам
Сформируй таблицу «пайплайн → ключ сортировки → обоснование», извлекая ключи из схем и кода конкретных пайплайнов (ChEMBL activity, assay, target, document, testitem). Для каждого кейса укажи:

бизнес-ключ(и) и их источник (колонки, regex-инварианты);

детерминированный тай-брейкер;

политика для null и пустых значений;

ссылки на модули и схемы.
Все ссылки в формате [ref: repo:...@refactoring_001].

Каноникализация значений
Опиши единые правила до сортировки/хэширования: тримминг, нормализация регистра для идентификаторов, унификация None/NA, стабильные форматы чисел и дат (ISO-8601 UTC), детерминированная сериализация списков/словари с sort_keys=True.

Хэш-политика
Зафиксируй алгоритм и поля:

hash_row: хэш конкатенации нормализованных значений в фиксированном порядке колонок;

hash_business_key: хэш по бизнес-ключу;

алгоритм (BLAKE2b-256 или фактически используемый в коде), кодировка (utf-8), порядок полей, разделитель, соление/без соли;

запрет на включение нестабильных полей (generated_at, run_id) в хэши;

правила пересчета при миграции схемы.

Структура meta.yaml
Определи строгую схему и пример. Обязательные поля:

dataset, pipeline, schema_version, column_order, row_count, deduplicated_count, business_key, hash_algo, hash_business_key, sample_hash_row,

source_lineage (версии источников, например chembl_release),

inputs (пути и хэши входов),

outputs (пути и хэши артефактов),

generated_at_utc, run_id, config_fingerprint,

qc (дубликаты, пропуски, нарушения ссылочной целостности).
Приведи полный пример meta.yaml и требования к порядку ключей при сериализации.

Шаблон determinism.yaml
Дай минимально рабочий скелет профиля с ключами:

serialization (CSV/Parquet параметры: разделитель, квотинг, na_rep, фиксированное представление bool/NaN),

sorting (ключи, направление, na_position),

hashing (алгоритм, поля, исключения),

timezone: UTC, locale: C,

write (атомарная запись, временные файлы, ротация),

meta (включение/исключение полей, путь сохранения рядом с артефактом).
Укажи место файла в репозитории, например configs/profiles/determinism.yaml, и механизм подмешивания из CLI.
GitHub

Golden-проверки
Опиши стратегию тестов: стабилизация вывода в tests/golden/<pipeline>/, сравнение контента с допуском только для технических полей времени, верификация meta.yaml, проверка стабильного порядка колонок и равенства хэшей между запусками при одинаковых входах и профилях.

Правила миграции схем
Версионирование Pandera-схем, матрица совместимости, обязательные миграции golden-артефактов, политика повышения schema_version, регламент изменения сорт-ключей и влияния на хэши.

Псевдокод финализации write()
Дай полный псевдокод: каноникализация → сортировка → заморозка column_order → расчет hash_row/hash_business_key → атомарная запись артефакта → генерация meta.yaml → валидация пост-записи → логи. Сошлись на стадиях оркестрации и контексте запуска из базового оркестратора.
GitHub

Интеграция с CLI
Укажи точку подключения профиля, флаги и поведение по умолчанию: при наличии determinism.yaml профиль включается автоматически согласно README, параметры профиля имеют приоритет над base.yaml, коды возврата и сообщения об ошибках детерминизма.
GitHub

Критерии приемки

Два запуска с одинаковыми входами и конфигами дают байтово идентичный вывод и неизменный meta.yaml (кроме generated_at_utc/run_id).

Golden-тесты зелёные на CI.

Изменение порядка колонок, локали, таймзоны или сериализации приводит к предсказуемому фейлу тестов.

Документ размещён в docs/determinism/00-determinism-policy.md и связан из docs/INDEX.md.

Формат результата

Выдай два файла в одном ответе:

docs/determinism/00-determinism-policy.md — полная спецификация по пунктам выше с таблицами, псевдокодом и примером meta.yaml.

configs/profiles/determinism.yaml — минимально работоспособный профиль с комментариями.
